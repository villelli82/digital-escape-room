<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Escape Room Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¹ÎºÎ®Ï‚: The Wiper Virus </title>
  <style>
    :root{
      --hud-h: 80px;
      --accent-color: #ffd700;
      --bg-color: #1a1a1a;
      --danger-color: #ff3333;
      --term-green: #0f0;
    }
    * { box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background: #111; 
      background-image: url("background.png");
      background-repeat: no-repeat;
      background-position: center center;
      background-attachment: fixed;
      background-size: cover;
      color: #fff;
      margin: 0;
      padding: calc(var(--hud-h) + 10px) 14px 20px 14px;
      overflow-x: hidden;
      user-select: none;
      cursor: default;
      transition: filter 0.1s;
    }

    /* --- CRT SCANLINE EFFECT --- */
    body::before {
      content: " ";
      display: block;
      position: fixed;
      top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
      z-index: 9990;
      background-size: 100% 2px, 3px 100%;
      pointer-events: none;
    }

    /* --- PANIC MODE (RED PULSE) --- */
    @keyframes panic-pulse {
      0% { box-shadow: inset 0 0 0 red; }
      50% { box-shadow: inset 0 0 100px rgba(255, 0, 0, 0.6); }
      100% { box-shadow: inset 0 0 0 red; }
    }
    .panic-mode {
      animation: panic-pulse 1s infinite;
      border: 2px solid red;
    }

    /* --- Î¦Î‘ÎšÎŸÎ£ (Darkness Overlay) --- */
    #darkness-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: 9998;
      background: radial-gradient(circle 250px at 50% 50%, transparent 0%, rgba(0,0,0,0.98) 100%);
      display: none;
      transition: background 0.05s linear;
    }

    /* --- GLITCH ANIMATION --- */
    .glitch-active {
      animation: glitch-anim 0.3s cubic-bezier(.25, .46, .45, .94) both infinite;
      color: red !important;
      text-shadow: 2px 0 blue, -2px 0 red;
    }
    @keyframes glitch-anim {
      0% { transform: translate(0); }
      20% { transform: translate(-5px, 5px); }
      40% { transform: translate(-5px, -5px); }
      60% { transform: translate(5px, 5px); }
      80% { transform: translate(5px, -5px); }
      100% { transform: translate(0); }
    }

    body::after {
      content: " ";
      display: block;
      position: fixed;
      top: 0; left: 0; bottom: 0; right: 0;
      box-shadow: inset 0 0 150px rgba(0,0,0,0.9);
      z-index: 50;
      pointer-events: none;
    }

    .screen {
      display: none;
      padding: 12px;
      opacity: 0;
      transition: opacity 0.5s ease;
      outline: none;
    }
    .screen.active { opacity: 1; }

    .screen h1, .screen h2 {
      margin: 6px 0 8px 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }

    input[type="text"], input[type="password"], input[type="number"] {
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid var(--accent-color);
        color: var(--accent-color);
        font-family: 'Courier New', monospace;
        padding: 10px;
        font-size: 1.1em;
        width: 300px;
        max-width: 90%;
        outline: none;
        border-radius: 6px;
        box-shadow: 0 0 5px var(--accent-color);
        text-align: center;
    }
    input::placeholder { color: #555; }

    button {
      padding: 10px 20px;
      margin: 6px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      background: #222;
      color: #fff;
      border: 2px solid #555;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s ease;
    }
    button:hover {
      background: #444;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      border-color: var(--accent-color);
    }

    .correct { color: lightgreen; font-weight: bold; }
    .wrong    { color: #ff6b6b;  font-weight: bold; }

    /* GENERIC DRAG DROP (Room 2) */
    .drag-container {
      display: flex;
      justify-content: center;
      margin: 12px;
      flex-wrap: wrap;
      min-height: 60px;
    }
    .drag-item, .drop-zone {
      border: 2px dashed #ccc;
      margin: 8px;
      padding: 10px;
      width: 150px;
      min-height: 50px;
      background: rgba(30,30,30,0.8);
      border-radius: 10px;
    }
    .drag-item { cursor: grab; z-index: 100; }

    /* PARSONS PROBLEM STYLES (Room 6) */
    .parsons-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
        margin-top: 10px;
    }
    .parsons-line {
        background: #333;
        border: 1px solid var(--accent-color);
        padding: 8px;
        width: 280px;
        cursor: grab;
        font-family: 'Courier New', monospace;
        text-align: left;
        margin-bottom: 5px;
    }
    .parsons-drop-area {
        border: 2px dashed #666;
        min-height: 200px;
        width: 300px;
        padding: 10px;
        background: rgba(0,0,0,0.5);
    }

    /* BIT FLIPPER STYLES (Room 3) */
    .bit-container {
        display: flex;
        gap: 5px;
        justify-content: center;
        margin: 15px 0;
    }
    .bit-btn {
        width: 40px; height: 50px;
        font-size: 20px;
        font-family: monospace;
        border: 2px solid #555;
        background: #222;
        color: #555;
    }
    .bit-btn.active {
        border-color: #0f0;
        color: #0f0;
        background: #003300;
        box-shadow: 0 0 10px #0f0;
    }
    .bit-display { font-family: monospace; font-size: 1.2em; color: var(--accent-color); }

    /* SPOT THE BUG STYLES (Room 8) */
    .code-token {
        display: inline-block;
        padding: 2px 5px;
        margin: 2px;
        border: 1px solid transparent;
        cursor: pointer;
        transition: background 0.2s;
    }
    .code-token:hover {
        background: rgba(255,255,255,0.1);
        border: 1px solid #555;
    }

    /* VIRUS POPUP STYLES (Room 10) */
    .virus-popup {
        position: fixed;
        width: 200px;
        background: #000;
        border: 2px solid red;
        color: red;
        z-index: 900;
        padding: 10px;
        text-align: center;
        box-shadow: 5px 5px 15px rgba(0,0,0,0.8);
        animation: popIn 0.2s;
    }
    #qblock-room10 { position: relative; z-index: 1000; }
    .virus-close {
        position: absolute;
        top: 2px; right: 5px;
        cursor: pointer;
        font-weight: bold;
        color: white;
        background: red;
        width: 20px; height: 20px;
        line-height: 20px;
        border-radius: 50%;
    }
    .email-inbox { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 10px 0; }
    .email-card { background: #1a1a2e; border: 1px solid #444; border-radius: 8px; padding: 12px; max-width: 220px; text-align: left; }
    .email-from { font-size: 11px; color: #888; margin-bottom: 4px; }
    .email-subject { font-weight: bold; color: #eee; margin-bottom: 6px; }
    .email-preview { font-size: 12px; color: #aaa; margin-bottom: 8px; }
    .email-delete { background: #c00; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .email-delete:hover { background: #e00; }
    .security-panel, .protocol-choice { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin: 12px 0; }
    .security-option, .protocol-option { background: #1a1a2e; border: 2px solid #555; border-radius: 8px; padding: 14px 20px; cursor: pointer; min-width: 180px; text-align: center; }
    .security-option:hover, .protocol-option:hover { border-color: #5dade2; background: #252540; }
    .sec-icon { display: block; font-size: 24px; margin-bottom: 4px; }

    a { color: #5dade2; text-decoration: none; border-bottom: 1px dotted #5dade2; }
    a:hover { color: var(--accent-color); border-bottom-style: solid; }

    .text-box {
      background: rgba(0,0,0,0.85);
      padding: 15px;
      border-radius: 8px;
      display: block;
      margin: 10px auto;
      text-align: center;
      max-width: 700px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .answers { margin-top: 8px; }

    .media-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 12px auto;
    }
    .media-container iframe,
    .media-container img {
      max-width: 90%;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.6);
      margin: 8px 0;
    }

    #hudWrapper {
      position: fixed; top: 0; left: 0; right: 0; z-index: 900;
      padding: 8px 10px;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(4px);
      border-bottom: 2px solid #444;
    }

    #hud {
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      gap: 8px 10px;
      align-items: center;
      justify-content: space-between;
      color: #fff;
      font-size: 14px;
    }

    .hud-left, .hud-center, .hud-right {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px 10px;
      min-width: 0;
    }

    .hud-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(20,20,20,0.75);
      border: 1px solid rgba(255,255,255,0.15);
      white-space: nowrap;
    }

    #integrity-container {
      width: 140px;
      height: 12px;
      background: #222;
      border: 1px solid #555;
      position: relative;
      border-radius: 6px;
      overflow: hidden;
      margin-left: 5px;
    }
    #integrity-bar {
      width: 100%;
      height: 100%;
      background: lightgreen;
      transition: width 0.5s ease, background 0.3s;
    }
    #integrity-label {
      font-size: 10px;
      position: absolute;
      top: -16px;
      left: 0;
      width: 100%;
      text-align: center;
      color: #ccc;
    }

    #difficultyIndicator { font-style: italic; opacity: 0.95; }

    #timer {
      font-size: 16px;
      font-weight: bold;
      color: #ff4444;
      padding: 6px 12px;
      background: rgba(20,20,20,0.85);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.15);
      display: inline-block;
      white-space: nowrap;
    }

    #keysHud { font-size: 14px; font-weight: 700; letter-spacing: 0.2px; }

    #settingsBtn, #teacherInfoBtn {
      font-size: 12px;
      padding: 6px 10px;
      margin: 0;
      border-radius: 10px;
      width: auto;
      white-space: nowrap;
    }

    #teacherInfoPanel {
      position: fixed;
      top: calc(var(--hud-h) + 10px);
      right: 12px;
      background: rgba(10,10,10,0.95);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      text-align: left;
      display: none;
      width: 280px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.12);
      z-index: 950;
    }
    #teacherInfoPanel h4 { margin: 0 0 6px 0; font-size: 12px; }
    #teacherInfoPanel ul { padding-left: 16px; margin: 0; }
    #teacherInfoPanel li { margin-bottom: 3px; }

    #settingsPanel {
      display: none;
      position: fixed;
      top: calc(var(--hud-h) + 10px);
      right: 12px;
      background: rgba(0,0,0,0.92);
      padding: 10px;
      border-radius: 10px;
      font-size: 13px;
      width: 260px;
      z-index: 950;
      text-align: left;
      box-shadow: 0 8px 18px rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.12);
    }
    #settingsPanel label { font-size: 13px; }

    .hint-text { color: #ffd86b; font-style: italic; min-height: 1em; margin-top: 6px; }

    #splash {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 1.5em;
      z-index: 1000;
      padding: 20px;
      text-align: center;
    }

    .hidden { display: none !important; }

    .blinking { animation: blinker 1.5s linear infinite; color: yellow; font-weight: bold; text-align: center; }
    @keyframes blinker { 50% { opacity: 0; } }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); transform: scale(1); }
      50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); transform: scale(1.1); }
    }

    #celebration { margin-top: 12px; font-size: 1.35em; min-height: 2em; }
    .celebration-legendary { color: #ffd700; text-shadow: 0 0 10px rgba(255,215,0,0.8); animation: glow 1.5s infinite alternate; }
    .celebration-good { color: #7CFC00; text-shadow: 0 0 8px rgba(124,252,0,0.7); animation: glow 2s infinite alternate; }
    .celebration-basic { color: #87CEEB; text-shadow: 0 0 6px rgba(135,206,235,0.7); }

    @keyframes glow {
      from { transform: scale(1); opacity: 0.9; }
      to   { transform: scale(1.05); opacity: 1; }
    }

    .difficulty-badge {
      display: inline-block;
      margin-top: 2px;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: bold;
    }
    .difficulty-easy    { background: rgba(76, 175, 80, 0.25); border: 1px solid #4caf50; color: #c8e6c9; }
    .difficulty-medium { background: rgba(255, 193, 7, 0.2);  border: 1px solid #ffc107; color: #ffecb3; }
    .difficulty-hard    { background: rgba(244, 67, 54, 0.25); border: 1px solid #f44336; color: #ffcdd2; }
    .difficulty-boss    { background: rgba(255, 0, 0, 0.4);      border: 1px solid red;       color: #fff; animation: pulseRed 1s infinite; }

    .story-box { background: rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.3); font-weight: bold; }
    .story-highlight { color: #ffd700; text-shadow: 0 0 8px rgba(255,215,0,0.7); animation: glow 2.5s ease-in-out infinite; }

    #progressMap {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 6px;
      z-index: 800;
    }
    .room-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.4);
    }
    .room-dot-active { background: #ffd700; border-color: #ffd700; }
    .room-dot-solved { background: #4caf50; border-color: #4caf50; }

    .avatar-option {
      display: inline-block;
      margin: 5px 10px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 2px solid #555;
      cursor: pointer;
    }
    .avatar-option.selected { border-color: #ffd700; background: rgba(255,215,0,0.1); }

    .key-earned {
      margin: 10px auto 0 auto;
      max-width: 700px;
      display: none;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,0.7);
      border: 1px solid rgba(255,255,255,0.25);
      box-shadow: 0 0 12px rgba(0,0,0,0.6);
      transform: translateY(6px) scale(0.98);
      opacity: 0;
    }
    .key-earned.show { display: block; animation: keyPop 0.35s ease-out forwards; }
    @keyframes keyPop {
      from { opacity: 0; transform: translateY(8px) scale(0.96); }
      to   { opacity: 1; transform: translateY(0px) scale(1); }
    }

    #access-denied {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: #ff3333;
      font-size: 3em;
      font-weight: 900;
      border: 5px solid #ff3333;
      padding: 20px 40px;
      background: rgba(0,0,0,0.9);
      z-index: 9999;
      display: none;
      text-transform: uppercase;
      box-shadow: 0 0 50px #ff3333;
      letter-spacing: 5px;
    }

    .interaction-layer {
      position: relative;
      width: 100%;
      height: 65vh;
      display: block;
      margin-bottom: 20px;
      border: 2px dashed rgba(255,255,255,0.1);
      border-radius: 10px;
      background: rgba(255,255,255,0.02);
      overflow: hidden;
    }

    .hotspot {
      position: absolute;
      cursor: crosshair;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 26px;
      z-index: 9002;
      transition: transform 0.2s;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      width: 65px;
      height: 65px;
      user-select: none;
    }
    .hotspot:hover {
      transform: scale(1.1);
      background: rgba(255,215,0,0.3);
      border-color: var(--accent-color);
    }

    .pulse-active {
      animation: pulseRed 1s infinite alternate !important;
      background: rgba(255, 0, 0, 0.4) !important;
      border: 2px solid red !important;
      z-index: 9003 !important;
      cursor: pointer !important;
    }
    .pulse-active::after {
      content: "ğŸ”“ Î Î‘Î¤Î‘ Î•Î”Î©";
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: red;
      color: white;
      padding: 2px 6px;
      font-size: 12px;
      border-radius: 4px;
      white-space: nowrap;
      font-weight: bold;
    }
    @keyframes pulseRed {
      from { box-shadow: 0 0 10px red; transform: scale(1); }
      to   { box-shadow: 0 0 25px red; transform: scale(1.1); }
    }

    #clue-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(10,10,10,0.95);
      border: 2px solid #33ff33;
      padding: 25px;
      border-radius: 15px;
      z-index: 10001; /* Fix: > 9998 */
      max-width: 600px;
      text-align: center;
      box-shadow: 0 0 40px #000;
      animation: popIn 0.3s;
    }
    @keyframes popIn {
      from { opacity:0; transform:translate(-50%,-50%) scale(0.8); }
      to   { opacity:1; transform:translate(-50%,-50%) scale(1); }
    }
    /* Tooltip for Room 8 debugging tokens */
    #room8-tooltip {
      display: none;
      position: fixed;
      background: rgba(255, 200, 0, 0.95);
      border: 2px solid #ffaa00;
      padding: 12px 18px;
      border-radius: 8px;
      z-index: 10002;
      max-width: 350px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      animation: tooltipFadeIn 0.3s;
      font-size: 0.95em;
      color: #000;
      font-weight: bold;
      pointer-events: none;
    }
    @keyframes tooltipFadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ Î¼Î±Î¸Î·Ï„Î® â€“ Î¿Î¸ÏŒÎ½Î· Ï„ÎµÏÎ¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï */
    .student-stats-wrapper {
      max-width: 640px;
      margin: 24px auto;
      text-align: left;
      background: linear-gradient(145deg, rgba(0, 25, 0, 0.4), rgba(0, 15, 0, 0.6));
      border: 1px solid rgba(0, 255, 0, 0.35);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.4);
    }
    .student-stats-title {
      color: #ffd700;
      margin: 0 0 20px 0;
      font-size: 1.35em;
      text-align: center;
      border-bottom: 1px solid rgba(255, 215, 0, 0.3);
      padding-bottom: 12px;
    }
    .student-stats-content { padding: 0; }
    .stat-block {
      margin-bottom: 18px;
      padding: 14px 18px;
      border-radius: 10px;
      border-left: 4px solid;
      background: rgba(0, 0, 0, 0.25);
    }
    .stat-block.excellent { border-left-color: #0f0; }
    .stat-block.need-repeat { border-left-color: #ffaa00; }
    .stat-block.most-mistakes { border-left-color: #ff6666; }
    .stat-block-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 1.05em;
    }
    .stat-block.excellent .stat-block-title { color: #7cfc00; }
    .stat-block.need-repeat .stat-block-title { color: #ffaa00; }
    .stat-block.most-mistakes .stat-block-title { color: #ff8888; }
    .stat-block-list { margin: 8px 0 0 0; padding-left: 0; line-height: 1.8; color: #ddd; list-style: none; }
    .stat-block-list li { margin-bottom: 10px; padding-left: 8px; border-left: 2px solid rgba(255,255,255,0.1); }
    .student-stats-footer {
      font-size: 0.9em;
      color: #999;
      margin-top: 20px;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }

    .giant-key {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 140px;
      cursor: pointer;
      z-index: 9005;
      filter: drop-shadow(0 0 20px gold);
      animation: keyPulse 1s infinite alternate;
    }
    @keyframes keyPulse {
      from { transform:translate(-50%,-50%) scale(1); }
      to   { transform:translate(-50%,-50%) scale(1.2); }
    }

    #backpack-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 80px;
      height: 80px;
      background: #222 url('https://img.icons8.com/color/96/backpack.png') no-repeat center center;
      background-size: 60%;
      border: 3px solid var(--accent-color);
      border-radius: 50%;
      cursor: pointer;
      z-index: 9005;
      box-shadow: 0 0 15px rgba(0,0,0,0.8);
      transition: transform 0.2s;
    }
    #backpack-btn:hover { transform: scale(1.1); }

    .backpack-wiggle { animation: wiggle 0.5s ease-in-out; }
    @keyframes wiggle {
      0% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(-15deg) scale(1.2); }
      50% { transform: rotate(15deg) scale(1.2); }
      75% { transform: rotate(-10deg) scale(1.1); }
      100% { transform: rotate(0deg) scale(1); }
    }

    /* --- BACKPACK MODAL --- */
    #backpack-modal {
      display: none;
      position: fixed;
      bottom: 110px; 
      right: 20px;
      width: 300px;
      min-height: 200px;
      background: rgba(15, 15, 15, 0.95);
      border: 2px solid var(--accent-color);
      border-radius: 12px;
      z-index: 9006;
      padding: 0;
      color: #fff;
      text-align: left;
      box-shadow: -5px 5px 20px rgba(0,0,0,0.8);
    }

    /* --- NEW: INSPECT MODAL --- */
    #inspect-modal {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      min-height: 250px;
      background: rgba(15,15,15,0.98);
      border: 2px solid #00aaff;
      border-radius: 10px;
      z-index: 10005;
      text-align: center;
      padding: 15px;
      box-shadow: 0 0 30px rgba(0,170,255,0.4);
    }
    #inspect-icon { font-size: 80px; margin: 20px 0; display: block; filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); }
    .inspect-btn {
        margin-top: 15px;
        background: #004466;
        border-color: #00aaff;
        color: #00aaff;
        width: 100%;
    }

    /* --- DRAGGABLE WINDOWS STYLES --- */
    .draggable-window {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(15, 15, 15, 0.95);
      border: 2px solid var(--accent-color);
      border-radius: 12px;
      z-index: 9006;
      width: 320px;
      padding: 0;
      color: #fff;
      text-align: left;
      box-shadow: 0 15px 40px rgba(0,0,0,0.9);
      overflow: hidden;
    }

    .window-header {
      padding: 8px 12px;
      background: #333;
      border-bottom: 1px solid #555;
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      color: #ffd700;
      user-select: none;
    }
    #backpack-modal .window-header, #inspect-modal .window-header { cursor: default; }

    .window-content { padding: 15px; }
    .win-btn-close {
      width: 14px; height: 14px;
      border-radius: 50%;
      background: #ff4444;
      cursor: pointer;
      display: inline-block;
      margin-left: 5px;
    }

    #backpack-items-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 10px; }
    .bp-item {
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.1);
      border: 1px solid #555;
      border-radius: 6px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 26px;
      cursor: help;
    }

    .boss-active {
      background: rgba(50, 0, 0, 0.9) !important;
      border: 3px solid red !important;
      animation: pulseRedBox 1s infinite alternate;
    }
    @keyframes pulseRedBox {
      from { box-shadow: 0 0 10px red; }
      to   { box-shadow: 0 0 30px red; }
    }
    #boss-status {
      font-size: 1.4em;
      color: #ff3333;
      font-weight: bold;
      margin: 10px;
      text-shadow: 0 0 5px red;
    }

    /* TERMINAL */
    .terminal-window {
      background: #000;
      font-family: 'Courier New', monospace;
      text-align: left;
      padding: 10px;
      width: 100%;
      height: 250px;
      margin: 0;
      overflow-y: auto;
      box-shadow: inset 0 0 15px rgba(0, 255, 0, 0.2);
    }
    .term-line { margin: 2px 0; color: #0f0; font-size: 14px; }
    .term-error { color: #ff3333; }
    .term-success { color: #ffd700; font-weight: bold; }
    .term-input-line { display: flex; color: #0f0; }
    .term-input {
      background: transparent;
      border: none;
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      flex-grow: 1;
      outline: none;
      margin-left: 5px;
    }

    /* CHATBOT */
    #chatbot-container {
      position: fixed;
      bottom: 90px;
      left: 20px;
      width: 300px;
      background: rgba(0,0,0,0.9);
      border: 2px solid #00ffff;
      border-radius: 8px;
      z-index: 9100;
      display: none;
      flex-direction: column;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
      font-size: 13px;
    }
    #chatbot-header {
      background: #003333;
      padding: 8px;
      font-weight: bold;
      color: #00ffff;
      border-bottom: 1px solid #00ffff;
      display: flex;
      justify-content: space-between;
    }
    #chat-messages {
      height: 150px;
      overflow-y: auto;
      padding: 10px;
      text-align: left;
    }
    .chat-msg { margin-bottom: 6px; line-height: 1.3; }
    .chat-msg.operator { color: #00ffff; }
    .chat-msg.system { color: #ffd700; font-style: italic; }
    .chat-msg.user { color: #aaa; }
    .chat-send-row { display: flex; gap: 6px; padding: 8px; border-top: 1px solid #333; }
    #chat-input { flex: 1; padding: 6px 8px; background: #111; border: 1px solid #555; color: #fff; border-radius: 4px; font-size: 12px; }
    #chat-send-btn { padding: 6px 12px; font-size: 12px; cursor: pointer; background: #003333; color: #00ffff; border: 1px solid #00ffff; border-radius: 4px; }
    #robot-operator-btn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 60px;
      height: 60px;
      background: rgba(0,0,0,0.8);
      border: 2px solid #00ffff;
      border-radius: 50%;
      z-index: 9000;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
      transition: all 0.3s;
    }
    #robot-operator-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
    }
    #robot-operator-btn.has-messages::after {
      content: '';
      position: absolute;
      top: -5px;
      right: -5px;
      width: 16px;
      height: 16px;
      background: #ff0000;
      border-radius: 50%;
      border: 2px solid #000;
      animation: pulse-red 1s infinite;
    }
    @keyframes pulse-red {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* MINIGAME */
    #minigame-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 10000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    /* CINEMATIC BANNER */
    #cinematic {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      z-index: 12000;
      display: none;
      padding: 18px 22px;
      border-radius: 14px;
      background: rgba(0,0,0,0.9);
      border: 2px solid var(--accent-color);
      box-shadow: 0 0 35px rgba(255,215,0,0.25);
      max-width: 700px;
      width: 90%;
      text-align: center;
    }
    #cinematic h3 { margin: 0 0 8px 0; color: var(--accent-color); }
    #cinematic p { margin: 0; color: #fff; opacity: 0.95; }

    /* EXIT FIREWORKS */
    .fireworks {
      font-size: 34px;
      letter-spacing: 6px;
      animation: firePulse 1.2s infinite alternate;
      text-shadow: 0 0 12px rgba(255,215,0,0.65);
    }
    @keyframes firePulse {
      from { transform: scale(1); opacity: 0.85; }
      to   { transform: scale(1.06); opacity: 1; }
    }

    /* KEYPAD STYLES (ROOM 5) */
    .keypad-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      width: 220px;
      margin: 10px auto;
      background: #222;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #444;
    }
    .keypad-btn {
      padding: 15px;
      background: #333;
      border: 1px solid #555;
      color: white;
      font-size: 18px;
      border-radius: 5px;
      cursor: pointer;
      margin: 0;
    }
    .keypad-btn:active { background: var(--accent-color); color: black; }
    .keypad-display {
      width: 220px;
      margin: 0 auto 10px auto;
      padding: 10px;
      background: #000;
      color: #0f0;
      font-family: monospace;
      font-size: 1.5em;
      text-align: center;
      border: 2px solid #555;
      border-radius: 5px;
    }

    @media (max-width: 860px) {
      :root { --hud-h: 88px; }
      #hud { font-size: 13px; }
      #timer { font-size: 14px; }
      button { font-size: 15px; }
    }
    @media (max-width: 520px) {
      :root { --hud-h: 112px; }
      #hud { gap: 6px 8px; }
      #settingsPanel, #teacherInfoPanel { right: 10px; width: 90vw; max-width: 320px; }
      body { padding-left: 10px; padding-right: 10px; }
      #backpack-btn { width: 60px; height: 60px; bottom: 10px; right: 10px; }
      #chatbot-container { bottom: 80px; left: 10px; width: 250px; }
      .draggable-window { width: 90%; left: 5% !important; top: 100px !important; transform: none !important; }
      #backpack-modal { right: 10px; bottom: 80px; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>
<!-- ğŸ•µï¸â€â™‚ï¸ SECRET: Î‘Î½ Î²ÏÎµÎ¹Ï‚ Î±Ï…Ï„ÏŒ Ï„Î¿ ÏƒÏ‡ÏŒÎ»Î¹Î¿, Ï„ÏÎ­Î¾Îµ adminOverride() ÏƒÏ„Î·Î½ ÎºÎ¿Î½ÏƒÏŒÎ»Î± -->

<div id="darkness-overlay"></div>

<div id="access-denied">ACCESS DENIED</div>

<div id="cinematic">
  <h3 id="cinematic-title">EVENT</h3>
  <p id="cinematic-text">...</p>
</div>

<div id="minigame-overlay">
  <h2 style="color:#0f0;">âš ï¸ DECRYPTION PROTOCOL âš ï¸</h2>
  <p>Î Î¬Ï„Î± Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ Ï€Î»Î®ÎºÏ„ÏÎ¿ Î³ÏÎ®Î³Î¿ÏÎ±!</p>
  <div id="minigame-target" style="font-size: 60px; font-weight: bold; color: yellow; margin: 20px;">X</div>
  <div id="minigame-progress" style="width: 300px; height: 10px; border: 1px solid #555; background: #222;">
    <div id="minigame-bar" style="width: 0%; height: 100%; background: #0f0;"></div>
  </div>
</div>

<div id="clue-popup">
  <h3 id="clue-title" style="margin: 0 0 10px 0; color: #33ff33;"></h3>
  <p id="clue-message" style="font-size: 1.2em; margin-bottom: 20px;"></p>
  <button onclick="closeCluePopup()">Î•ÎÎ¤Î‘ÎÎ•Î™</button>
</div>

<div id="robot-operator-btn" onclick="toggleChatbot()" title="ğŸ¤– The Operator - ÎšÎ¬Î½Îµ ÎºÎ»Î¹Îº Î³Î¹Î± Î½Î± Î´ÎµÎ¹Ï‚ Ï„Î± Î¼Î·Î½ÏÎ¼Î±Ï„Î±">ğŸ¤–</div>

<div id="chatbot-container">
  <div id="chatbot-header">
    <span>ğŸ¤– The Operator</span>
    <span onclick="toggleChatbot()" style="cursor:pointer;">_</span>
  </div>
  <div id="chat-messages">
    <div class="chat-msg system">System initialized. Operator is online.</div>
  </div>
  <div class="chat-send-row">
    <input type="text" id="chat-input" placeholder="Î¡ÏÏ„Î± Ï„Î¿Î½ Operator..." maxlength="200" autocomplete="off" onkeydown="if(event.key==='Enter') sendChatQuestion();">
    <button type="button" id="chat-send-btn" onclick="sendChatQuestion()">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®</button>
  </div>
</div>

<div id="backpack-btn" onclick="toggleBackpack()" title="Î†Î½Î¿Î¹Î³Î¼Î± Î£Î±ÎºÎ¹Î´Î¯Î¿Ï… (Toolkit)"></div>

<div id="backpack-modal">
  <div class="window-header" id="backpack-header">
    <span>ğŸ’ HACKER TOOLKIT</span>
    <span class="win-btn-close" onclick="toggleBackpack()"></span>
  </div>
  <div class="window-content">
    <div id="backpack-items-list">
      <span style="font-style:italic; font-size:12px; color:#aaa;">Scanning for assets...</span>
    </div>
    <button onclick="combineItems()" style="width:100%; margin-top:10px; font-size:12px; padding:5px; border:1px solid gold; color:gold; background:#333;">
      ğŸ§© Î£Ï…Î½Î´Ï…Î±ÏƒÎ¼ÏŒÏ‚ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ (Combine)
    </button>
  </div>
</div>

<div id="inspect-modal">
    <div class="window-header">
      <span>ğŸ” INSPECTION TOOL</span>
      <span class="win-btn-close" onclick="document.getElementById('inspect-modal').style.display='none'"></span>
    </div>
    <div id="inspect-icon">ğŸ“¦</div>
    <h3 id="inspect-title" style="color:#ffd700; margin:5px;">Item</h3>
    <p id="inspect-desc" style="font-style:italic; color:#ccc;">...</p>
    <div id="inspect-secret-area" style="display:none; color:lightgreen; border:1px dashed #444; padding:5px; margin-top:10px;"></div>
    <button class="inspect-btn" onclick="revealSecret()">ğŸ”„ Î•ÎÎ•Î¤Î‘Î£Î— / Î“Î¥Î¡Î™Î£ÎœÎ‘</button>
</div>

<div id="hudWrapper">
  <div id="hud">
    <div class="hud-left">
      <div id="playerInfo" class="hud-chip">ğŸ‘¤ Agent: -</div>
      <div id="difficultyIndicator" class="hud-chip"></div>
      <div id="progress" class="hud-chip">Î•ÎºÏ„ÏŒÏ‚ Î´Ï‰Î¼Î±Ï„Î¯Ï‰Î½</div>
    </div>
    <div class="hud-center">
      <div id="integrity-container" title="System Integrity">
        <div id="integrity-label">SYSTEM INTEGRITY</div>
        <div id="integrity-bar"></div>
      </div>
      <div id="score" class="hud-chip">â­ Î£ÎºÎ¿Ï: <span id="score-value">150</span></div>
      <div id="keysHud" class="hud-chip">ğŸ”‘</div>
      <div id="timer" style="display:none;">â³ 15:00</div>
    </div>
    <div class="hud-right">
      <button id="settingsBtn" onclick="toggleSettings()">âš™ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</button>
      <button id="teacherInfoBtn" onclick="toggleTeacherInfo()">â„¹ Î“Î¹Î± ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿ÏÏ‚</button>
    </div>
  </div>
</div>

<div id="teacherInfoPanel">
  <h4>Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î³Î¹Î± ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿ÏÏ‚ (Engagement Edition)</h4>
  <ul>
    <li><b>Scaffolding (Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¹ÎºÏ„Î¹ÎºÎ­Ï‚ Ï€Î±ÏÎµÎ¼Î²Î¬ÏƒÎµÎ¹Ï‚):</b> Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î²Î¿Î®Î¸ÎµÎ¹Î± Î±Ï€ÏŒ Ï„Î¿Î½ "Operator".</li>
    <li><b>Situated Learning (Î•Î½Ï„Î±Î³Î¼Î­Î½Î· Î¼Î¬Î¸Î·ÏƒÎ·):</b> Draggable Ï€Î±ÏÎ¬Î¸Ï…ÏÎ± (Ï€ÏÎ¿ÏƒÎ¿Î¼Î¿Î¯Ï‰ÏƒÎ· OS).</li>
    <li><b>Emotional (Î£Ï…Î½Î±Î¹ÏƒÎ¸Î·Î¼Î±Ï„Î¹ÎºÏŒ):</b> Panic Mode ÏŒÏ„Î±Î½ Ï€Î­Ï†Ï„ÎµÎ¹ Ï„Î¿ Integrity.</li>
    <li><b>Behavioral / Parsons (Î£Ï…Î¼Ï€ÎµÏÎ¹Ï†Î¿ÏÎ¹ÎºÏŒ):</b> Drag-and-drop ÎºÏÎ´Î¹ÎºÎ± (Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 6).</li>
    <li><b>Inspection (Î•Ï€Î¹Î¸ÎµÏÏÎ·ÏƒÎ·):</b> Î•Î¾ÎµÏÎµÏÎ½Î·ÏƒÎ· ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ ÏƒÏ„Î¿ Backpack (ÎºÏÏ…Ï†Î¬ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±).</li>
    <li><b>Interconnectivity (Î”Î¹Î±ÏƒÏÎ½Î´ÎµÏƒÎ·):</b> Î¤Î± Î´Ï‰Î¼Î¬Ï„Î¹Î± Î±Ï€Î±Î¹Ï„Î¿ÏÎ½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Î±Ï€ÏŒ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î±.</li>
  </ul>
</div>

<div id="settingsPanel">
  <strong>Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</strong><br>
  <label><input type="checkbox" id="muteSoundsCheckbox" onchange="toggleMuteSounds()"> Î£Î¯Î³Î±ÏƒÎ· Î®Ï‡Ï‰Î½ & Î¼Î¿Ï…ÏƒÎ¹ÎºÎ®Ï‚</label><br>
  <label><input type="checkbox" id="muteSpeechCheckbox" onchange="toggleMuteSpeech()"> Î£Î¯Î³Î±ÏƒÎ· Î¿Î¼Î¹Î»Î¯Î±Ï‚</label><br>
  <button type="button" onclick="testSound()" style="margin-top:6px; padding:4px 8px; font-size:12px;">ğŸ”Š Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î®Ï‡Î¿</button>
  <div style="margin-top:6px;">
    ÎœÎ­Î³ÎµÎ¸Î¿Ï‚ ÎºÎµÎ¹Î¼Î­Î½Î¿Ï…:
    <button onclick="changeFontSize(-0.1)" style="padding:2px 6px; font-size:11px;">A-</button>
    <button onclick="changeFontSize(0.1)"  style="padding:2px 6px; font-size:11px;">A+</button>
  </div>
</div>

<div id="progressMap"></div>

<div id="splash">
  <h1 style="color: #ffd700; text-shadow: 0 0 20px #ffd700;">ğŸ”’ Escape Room Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¹ÎºÎ®Ï‚</h1>
  <p style="color: #ffd700; font-size: 1.2em; margin-top: 0.3em; text-shadow: 0 0 12px #ffd700;">The Wiper Virus</p>
  <button onclick="enterGame()">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</button>
</div>

<div id="instructions" class="screen">
  <h1>ğŸ¯ Î£Ï„ÏŒÏ‡Î¿Ï‚ Ï„Î¿Ï… Escape Room</h1>
  <div class="text-box">
    <p><b>Î£Ï„ÏŒÏ‡Î¿Ï‚:</b> Î£Ï…Î»Î»Î¿Î³Î® ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ â†’ Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î¼Î·Ï‡Î±Î½Î¹ÏƒÎ¼Î¿Ï â†’ Î‘Ï€Î¿ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·/Î•ÎºÏ„Î­Î»ÎµÏƒÎ·.</p>
    <p>Î ÏÎ¬ÎºÏ„Î¿ÏÎ±, Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î´Î­Ï‡ÎµÏ„Î±Î¹ ÎµÏ€Î¯Î¸ÎµÏƒÎ·. ÎŸ "Operator" Î¸Î± ÏƒÎµ Î²Î¿Î·Î¸Î¬ÎµÎ¹.</p>
    <ul style="text-align:left; max-width:600px; margin:0 auto;">
      <li>ÎŸÎ¹ Server ÎµÎ¯Î½Î±Î¹ ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î¿Î¹. Î¨Î¬Î¾Îµ Î³Î¹Î± <b>Î£Î¤ÎŸÎ™Î§Î•Î™Î‘</b> (ğŸ“„) ÏƒÏ„Î¿ Ï‡ÏÏÎ¿.</li>
      <li>Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ <b>Terminal</b> Î³Î¹Î± ÎµÎ½Ï„Î¿Î»Î­Ï‚.</li>
      <li>Î•Ï€Î¹Î¸ÎµÏÏÎ·ÏƒÎµ Ï„Î± Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î± ÏƒÏ„Î¿ <b>Î£Î±ÎºÎ¯Î´Î¹Î¿</b> Î³Î¹Î± ÎºÏÏ…Î¼Î¼Î­Î½Î¿Ï…Ï‚ ÎºÏ‰Î´Î¹ÎºÎ¿ÏÏ‚!</li>
      <li><b>Î Î¡ÎŸÎ£ÎŸÎ§Î—:</b> Î‘Î½ Ï„Î¿ Integrity Ï€Î­ÏƒÎµÎ¹ ÎºÎ¬Ï„Ï‰ Î±Ï€ÏŒ 30%, Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î¼Ï€Î±Î¯Î½ÎµÎ¹ ÏƒÎµ Panic Mode.</li>
    </ul>
    <p style="color:#ff6b6b; font-style:italic;">ğŸ”´ WARNING: Î— Î±ÎºÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î± Ï„Î¿Ï… ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ Ï€Î­Ï†Ï„ÎµÎ¹ Î¼Îµ ÎºÎ¬Î¸Îµ Î»Î¬Î¸Î¿Ï‚!</p>
  </div>
  <button onclick="goTo('playerSetup')">Î‘Î ÎŸÎ”ÎŸÎ§Î— Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î—Î£</button>
</div>

<div id="playerSetup" class="screen">
  <h1>Î¡ÏÎ¸Î¼Î¹ÏƒÎ· Î ÏÎ¿Ï†Î¯Î» Î Î±Î¯ÎºÏ„Î·</h1>
  <div class="text-box"><p>Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î¿ ÏˆÎµÏ…Î´ÏÎ½Ï…Î¼ÏŒ ÏƒÎ¿Ï… ÎºÎ±Î¹ Î´Î¹Î¬Î»ÎµÎ¾Îµ avatar.</p></div>
  <div class="text-box">
    <label>Codename (Î¨ÎµÏ…Î´ÏÎ½Ï…Î¼Î¿):<br><input type="text" id="playerNameInput" placeholder="Ï€.Ï‡. Neo" style="padding:6px; margin-top:5px; width:60%;"></label>
  </div>
  <div class="text-box">
    <p>Î•Ï€Î¯Î»ÎµÎ¾Îµ Role/Avatar:</p>
    <div id="avatarContainer">
      <div class="avatar-option" data-avatar="hacker" onclick="selectAvatar('hacker', this)">ğŸ’» White Hat</div>
      <div class="avatar-option" data-avatar="robot"  onclick="selectAvatar('robot', this)">ğŸ¤– Bot Net</div>
      <div class="avatar-option" data-avatar="scientist" onclick="selectAvatar('scientist', this)">ğŸ›¡ï¸ SysAdmin</div>
    </div>
  </div>
  <button onclick="savePlayerSetup()">Î£Î¥ÎÎ”Î•Î£Î—</button>
</div>

<div id="intro" class="screen">
  <h1>âš ï¸ SECURITY BREACH DETECTED</h1>
  <div class="text-box"><p>ÎŸ Î¹ÏŒÏ‚ Î­Ï‡ÎµÎ¹ ÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÎ¹ Ï„Î¿ ÎµÏÎ³Î±ÏƒÏ„Î®ÏÎ¹Î¿. ÎŸ Operator ÏƒÏ…Î½Î´Î­ÎµÏ„Î±Î¹...</p></div>
  <div class="media-container">
    <video width="560" height="315" controls preload="metadata" poster="" style="max-width:100%;">
      <source src="intro.mp4" type="video/mp4">
      Î¤Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î±Î½Î±Ï€Î±ÏÎ±Î³Ï‰Î³Î®Ï‚ Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÏ„Î±Î¹ Î® Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ intro.mp4 Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ. Î’Î¬Î»Ï„Îµ Ï„Î¿ ÎºÎ±Ï„ÎµÎ²Î±ÏƒÎ¼Î­Î½Î¿ Î²Î¯Î½Ï„ÎµÎ¿ Ï‰Ï‚ intro.mp4 ÏƒÏ„Î¿ Î¯Î´Î¹Î¿ Ï†Î¬ÎºÎµÎ»Î¿ Î¼Îµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ HTML.
    </video>
    <div class="text-box blinking">ğŸ¥ Î‘Î½Î¬Î»Ï…ÏƒÎµ Ï„Î¿ Î²Î¯Î½Ï„ÎµÎ¿ Î³Î¹Î± Ï„ÏÏ‰Ï„Î¬ ÏƒÎ·Î¼ÎµÎ¯Î±!</div>
  </div>
  <button onclick="startGame()">Î•ÎšÎ¤Î•Î›Î•Î£Î— (START)</button>
  <button onclick="goTo('glossary')">Î’Î¬ÏƒÎ· Î³Î½ÏÏƒÎ·Ï‚ (Î“Î»Ï‰ÏƒÏƒÎ¬ÏÎ¹)</button>
</div>

<div id="room1" class="screen">
  <h2>Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 1: ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ ÏƒÏ„Î¿ Ï„ÎµÏÎ¼Î±Ï„Î¹ÎºÏŒ</h2>
  <div class="difficulty-badge difficulty-easy">ğŸŸ¢ Level 1</div>
  <div class="text-box story-box story-highlight" id="story-room1">
    Î¤Î¿ Ï„ÎµÏÎ¼Î±Ï„Î¹ÎºÏŒ ÎµÎ»Î­Î³Ï‡Î¿Ï… Î´ÎµÎ½ Î±Î½Ï„Î±Ï€Î¿ÎºÏÎ¯Î½ÎµÏ„Î±Î¹. Î“Î¹Î± Î½Î± ÎµÏ€Î±Î½Î­Î»Î¸ÎµÎ¹ Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÏƒÏ‰ÏƒÏ„Î® ÎµÎ½Ï„Î¿Î»Î® ÎµÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚.<br>
    <span style="color:#ffd700; font-size:0.9em;">ğŸ’¡ Î¨Î¬Î¾Îµ Î³Î¹Î± Î¿Î´Î·Î³Î¯ÎµÏ‚ Python ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿. Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎ±Î¹ Î­Î½Î± Post-It Ï€Î¿Ï… Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯Ï‚ Î±ÏÎ³ÏŒÏ„ÎµÏÎ±.</span>
  </div>

  <div class="interaction-layer">
    <div class="hotspot" style="top: 70%; left: 20%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room1', 'ğŸŸ¨', 'Post-It: Port 8080 (Î˜Î± Ï„Î¿ Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯Ï‚ Î±ÏÎ³ÏŒÏ„ÎµÏÎ±!)', this)">ğŸŸ¨</div>

    <div class="hotspot" style="top: 25%; left: 60%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room1', 'ğŸ', 'Python Manual: Î“Î¹Î± Î½Î± ÎµÎ¼Ï†Î±Î½Î¯ÏƒÎµÎ¹Ï‚ ÎºÎµÎ¯Î¼ÎµÎ½Î¿, Î³ÏÎ¬ÏˆÎµ print ÎºÎ±Î¹ Ï„Î¿ Î¼Î®Î½Ï…Î¼Î± ÏƒÎµ Ï€Î±ÏÎµÎ½Î¸Î­ÏƒÎµÎ¹Ï‚.', this)">ğŸ</div>

    <div class="hotspot hotspot-lock" id="lock-room1" style="top: 35%; left: 50%; width:90px;" title="ÎšÎ»ÎµÎ¹Î´Î±ÏÎ¹Î¬"
         onclick="attemptUnlock('room1', this)">ğŸ”’</div>

    <div class="hotspot" style="top: 85%; left: 60%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('ÎšÎ¿Ï…Ï„Î¬ÎºÎ¹ ÎºÎ±Ï†ÎµÎÎ½Î·Ï‚. Î‘Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î¿.', 'ğŸ¥¤')">ğŸ¥¤</div>
    <div class="hotspot" style="top: 20%; left: 80%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('ÎŸ Ï€Î¯Î½Î±ÎºÎ±Ï‚ Î­Ï‡ÎµÎ¹ ÏƒÎ²Î·ÏƒÎ¼Î­Î½ÎµÏ‚ Ï€ÏÎ¬Î¾ÎµÎ¹Ï‚.', 'ğŸ§®')">ğŸ§®</div>
    <div class="hotspot" style="top: 75%; left: 35%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('ÎœÏ€ÎµÏÎ´ÎµÎ¼Î­Î½Î± ÎºÎ±Î»ÏÎ´Î¹Î± Î´Î¹ÎºÏ„ÏÎ¿Ï….', 'ğŸ”Œ')">ğŸ”Œ</div>
  </div>

  <div id="giant-key-room1" class="giant-key" onclick="goToNextFrom('room1', 'room2')">ğŸ—ï¸</div>

  <div id="qblock-room1" class="draggable-window">
    <div class="window-header" id="term-header">
      <span>Î¤Î•Î¡ÎœÎ‘Î¤Î™ÎšÎŸ Î•ÎÎ•Î¡Î“ÎŸ</span>
      <span class="win-btn-close" onclick="document.getElementById('qblock-room1').style.display='none'"></span>
    </div>
    <div class="window-content" style="padding:0;">
      <p id="obj-room1" class="room-objective" style="display:none; font-weight:bold; margin:8px 10px 6px; padding:0;"></p>
      <p id="qtext-room1" class="hidden">Î ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î¿ ÎµÎºÎºÎ¯Î½Î·ÏƒÎ·Ï‚: Î³ÏÎ¬ÏˆÎµ Ï„Î·Î½ ÎµÎ½Ï„Î¿Î»Î® Ï€Î¿Ï… Î¸Î± ÎµÎ¼Ï†Î±Î½Î¯ÏƒÎµÎ¹ Ï„Î¿ "Hello".</p>

      <div class="terminal-window" id="term-room1" onclick="document.getElementById('term-input-1').focus()">
        <div id="term-output-1">
          <div class="term-line">----------------------------------------</div>
          <div class="term-line">Î•ÎšÎšÎ™ÎÎ—Î£Î— Î£Î¥Î£Î¤Î—ÎœÎ‘Î¤ÎŸÎ£â€¦</div>
          <div class="term-line">Î£Ï†Î¬Î»Î¼Î±: Î”ÎµÎ½ ÎµÎ½Ï„Î¿Ï€Î¯ÏƒÏ„Î·ÎºÎµ Î­Î¾Î¿Î´Î¿Ï‚.</div>
          <div class="term-line">Î‘Î½Î±Î¼ÎµÎ½ÏŒÎ¼ÎµÎ½Î¿ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î±: hello</div>
          <div class="term-line"></div>
          <div class="term-line">Î¤Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÎ¹ ÎµÎ½Ï„Î¿Î»Î®.</div>
          <div class="term-line">----------------------------------------</div>
        </div>
        <div class="term-input-line">
          <span>root@sys:~$</span>
          <input type="text" id="term-input-1" class="term-input" autocomplete="off">
        </div>
      </div>

      <div style="padding:10px;">
        <p id="feedback1"></p>
        <div id="key-earned-room1" class="key-earned"></div>
        <button onclick="showHint('room1')">ğŸ’¡ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·</button>
        <button onclick="repeatQuestion('room1')">ğŸ™ï¸ Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ· Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚ ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚</button>
      </div>
    </div>
  </div>

  <button onclick="goTo('intro')">ÎœÎµÎ½Î¿Ï</button>
  <button onclick="goTo('glossary')">Î“Î»Ï‰ÏƒÏƒÎ¬ÏÎ¹</button>
</div>

<div id="room2" class="screen">
  <h2>Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 2: Î‘Î½Ï„Î¹ÏƒÏ„Î¿Î¯Ï‡Î¹ÏƒÎµ Ï„Î¿Ï…Ï‚ ÏŒÏÎ¿Ï…Ï‚</h2>
  <div class="difficulty-badge difficulty-easy">ğŸŸ¢ Level 1</div>
  <div class="text-box story-box story-highlight" id="story-room2">
    Î¤Î¿ Î´Î¯ÎºÏ„Ï…Î¿ Î­Ï‡ÎµÎ¹ Î±Ï€Î¿ÏƒÏ…Î½Î´ÎµÎ¸ÎµÎ¯. Î¤Î± modules Ï€ÏÏ‰Ï„Î¿ÎºÏŒÎ»Î»Ï‰Î½ Î²ÏÎ¯ÏƒÎºÎ¿Î½Ï„Î±Î¹ ÏƒÎµ Î»Î¬Î¸Î¿Ï‚ Î¸Î­ÏƒÎ·.<br>
    <span style="color:#ffd700; font-size:0.9em;">ğŸ’¡ Î’ÏÎµÏ‚ Ï„Î¿ Manual Î”Î¹ÎºÏ„ÏÎ¿Ï… ÎºÎ±Î¹ Ï„Î· Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ· Î³Î¹Î± Î½Î± Î¼Î¬Î¸ÎµÎ¹Ï‚ Ï„Î¹Ï‚ Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡Î¯ÎµÏ‚ IP, DNS, HTTP.</span>
  </div>

  <div class="interaction-layer">
    <div class="hotspot" style="top: 15%; left: 75%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room2', 'ğŸ“˜', 'Manual Î”Î¹ÎºÏ„ÏÎ¿Ï…: IP=Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·, DNS=ÎŸÎ½ÏŒÎ¼Î±Ï„Î±', this)">ğŸ“˜</div>
    <div class="hotspot" style="top: 25%; left: 50%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room2', 'ğŸ“„', 'Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ· Î´Î¹ÎºÏ„ÏÎ¿Ï…: IP=Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·, DNS=Î¿Î½ÏŒÎ¼Î±Ï„Î±, HTTP=Ï€ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î¿.', this)">ğŸ“„</div>

    <div class="hotspot hotspot-lock" id="lock-room2" style="top: 45%; left: 15%; width:80px;" title="ÎšÎ»ÎµÎ¹Î´Î±ÏÎ¹Î¬"
         onclick="attemptUnlock('room2', this)">ğŸ”’</div>

    <div class="hotspot" style="top: 60%; left: 10%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('ÎˆÎ½Î± Ï€Î»Î±ÏƒÏ„Î¹ÎºÏŒ Ï†Ï…Ï„ÏŒ.', 'ğŸª´')">ğŸª´</div>
    <div class="hotspot" style="top: 85%; left: 50%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('ÎœÎ¹Î± Ï€Î±Î»Î¹Î¬ ÎºÎ±ÏÎ­ÎºÎ»Î±.', 'ğŸª‘')">ğŸª‘</div>
    <div class="hotspot" style="top: 10%; left: 40%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î›Î¬Î¼Ï€Î± Ï†Î¸Î¿ÏÎ¯Î¿Ï… Ï€Î¿Ï… Ï„ÏÎµÎ¼Î¿Ï€Î±Î¯Î¶ÎµÎ¹.', 'ğŸ’¡')">ğŸ’¡</div>
  </div>

  <div id="giant-key-room2" class="giant-key" onclick="triggerMinigame('room3')">ğŸ—ï¸</div>

  <div id="qblock-room2" style="display:none;">
    <p id="obj-room2" class="room-objective" style="display:none; font-weight:bold; margin:0 0 8px 0;"></p>
    <div class="media-container"><img src="images/network.png" alt="Î”Î¯ÎºÏ„Ï…Î¿" width="300"></div>
    <div class="text-box"><p id="qtext-room2">Î”Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î±Ï€Î¿ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚: ÏƒÏÏÎµ ÎºÎ¬Î¸Îµ Ï€ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î¿ ÏƒÏ„Î· ÏƒÏ‰ÏƒÏ„Î® Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î®.</p></div>
    
    <div class="drag-container" id="room2-pool">
      <div class="drag-item" draggable="true" id="IP">IP</div>
      <div class="drag-item" draggable="true" id="DNS">DNS</div>
      <div class="drag-item" draggable="true" id="HTTP">HTTP</div>
    </div>
    
    <div class="drag-container">
      <div class="drop-zone" data-answer="IP">Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î´Î¹Î±Î´Î¹ÎºÏ„ÏÎ¿Ï…</div>
      <div class="drop-zone" data-answer="DNS">Î£ÏÏƒÏ„Î·Î¼Î± Î¿Î½Î¿Î¼Î¬Ï„Ï‰Î½ Ï‡ÏÏÎ¿Ï…</div>
      <div class="drop-zone" data-answer="HTTP">Î ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î¿ ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚</div>
    </div>
    <button onclick="checkRoom2()">Î•Î Î‘ÎÎ‘Î¦ÎŸÎ¡Î‘ Î£Î¥ÎÎ”Î•Î£Î—Î£</button>
    <button onclick="resetRoom2()">Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬</button>
    <p id="feedback2"></p>
    <div id="key-earned-room2" class="key-earned"></div>
    <p id="hint-room2" class="hint-text"></p>
    <button onclick="showHint('room2')">ğŸ’¡ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·</button>
    <button onclick="repeatQuestion('room2')">ğŸ™ï¸ Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ· Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚</button>
  </div>

  <button onclick="goTo('intro')">ÎœÎµÎ½Î¿Ï</button>
  <button onclick="goTo('glossary')">Î“Î»Ï‰ÏƒÏƒÎ¬ÏÎ¹</button>
</div>

<div id="room3" class="screen">
  <h2>Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 3: Binary Encoding</h2>
  <div class="difficulty-badge difficulty-easy">ğŸŸ¢ Level 1</div>
  <div class="text-box story-box story-highlight" id="story-room3">
    Î£Ï†Î¬Î»Î¼Î± ÎºÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚. Î¤Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î±Ï€Î±Î¹Ï„ÎµÎ¯ ÏƒÏ‰ÏƒÏ„Î® Î´Ï…Î±Î´Î¹ÎºÎ® Î±Î½Î±Ï€Î±ÏÎ¬ÏƒÏ„Î±ÏƒÎ· Î³Î¹Î± Î½Î± Î´ÎµÏ‡Ï„ÎµÎ¯ Ï„Î¿ ÏƒÎ®Î¼Î±.<br>
    <span style="color:#ffd700; font-size:0.9em;">ğŸ’¡ Î§ÏÎµÎ¹Î¬Î¶ÎµÏƒÎ±Î¹ Ï„Î¿Î½ Î±ÏÎ¹Î¸Î¼ÏŒ 75. Î¨Î¬Î¾Îµ Î³Î¹Î± ASCII Chart ÎºÎ±Î¹ Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ· Î´Ï…Î±Î´Î¹ÎºÎ¿Ï ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿.</span>
  </div>
  <div class="interaction-layer">
    <div class="hotspot" style="top: 30%; left: 40%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room3', 'ğŸ“Œ', 'ASCII Chart: K = 75', this)">ğŸ“Œ</div>
    <div class="hotspot" style="top: 45%; left: 55%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room3', 'ğŸ“‹', 'Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ· Î´Ï…Î±Î´Î¹ÎºÎ¿Ï: ÎŸ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ 75 Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯ ÏƒÏ„Î¿ Î³ÏÎ¬Î¼Î¼Î± K.', this)">ğŸ“‹</div>
    <div class="hotspot hotspot-lock" id="lock-room3" style="top: 65%; left: 70%;" title="ÎšÎ»ÎµÎ¹Î´Î±ÏÎ¹Î¬"
         onclick="attemptUnlock('room3', this)">ğŸ”’</div>
         
    <div class="hotspot" style="top: 20%; left: 10%;" title="Log File"
         onclick="examine('LOG FILE #1: ÎŸ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿Ï‚ admin Ï€ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î½Î± Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®ÏƒÎµÎ¹ Ï„Î± Î±ÏÏ‡ÎµÎ¯Î±. ÎˆÎ»ÎµÎ³Îµ ÎºÎ¬Ï„Î¹ Î³Î¹Î± Ï„Î¿ ÏŒÏ„Î¹ Ï„Î± Î¼Î·Ï‡Î±Î½Î®Î¼Î±Ï„Î± Î¼Î¹Î»Î¬Î½Îµ Î¼ÏŒÎ½Î¿ Î¼Îµ 0 ÎºÎ±Î¹ 1...', 'ğŸ“‚')"
         ondblclick="showDeepScan('Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·: ÎŸ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ 75 ÏƒÎµ Î´Ï…Î±Î´Î¹ÎºÏŒ Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯ ÏƒÏ„Î¿ Î³ÏÎ¬Î¼Î¼Î± K (ASCII).')">ğŸ“‚</div>

    <div class="hotspot" style="top: 85%; left: 20%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î£Ï„Î¿Î¯Î²Î± Î¼Îµ Ï€Î±Î»Î¹Î¬ Ï€ÎµÏÎ¹Î¿Î´Î¹ÎºÎ¬.', 'ğŸ“š')">ğŸ“š</div>
    <div class="hotspot" style="top: 20%; left: 90%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î Î±ÏÎ¬Î¸Ï…ÏÎ¿ Î¼Îµ Î¸Î­Î±.', 'ğŸŒ§ï¸')">ğŸŒ§ï¸</div>
    <div class="hotspot" style="top: 50%; left: 10%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('ÎˆÎ½Î±Ï‚ ÎºÎ¬Î´Î¿Ï‚ ÏƒÎºÎ¿Ï…Ï€Î¹Î´Î¹ÏÎ½.', 'ğŸ—‘ï¸')">ğŸ—‘ï¸</div>
  </div>
  <div id="giant-key-room3" class="giant-key" onclick="goToNextFrom('room3', 'room4')">ğŸ—ï¸</div>
  
  <div id="qblock-room3" style="display:none;">
    <p id="obj-room3" class="room-objective" style="display:none; font-weight:bold; margin:0 0 8px 0;"></p>
    <div class="text-box"><p id="qtext-room3">Î‘Ï€Î¿ÎºÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·: ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î± ÏƒÏ‰ÏƒÏ„Î¬ bits Î³Î¹Î± Î½Î± Ï†Ï„Î¬ÏƒÎµÎ¹Ï‚ Ï„Î¿Î½ ÏƒÏ„ÏŒÏ‡Î¿.</p></div>
    
    <div class="bit-container">
        <button class="bit-btn" onclick="toggleBit(7, this)">0</button>
        <button class="bit-btn" onclick="toggleBit(6, this)">0</button>
        <button class="bit-btn" onclick="toggleBit(5, this)">0</button>
        <button class="bit-btn" onclick="toggleBit(4, this)">0</button>
        <button class="bit-btn" onclick="toggleBit(3, this)">0</button>
        <button class="bit-btn" onclick="toggleBit(2, this)">0</button>
        <button class="bit-btn" onclick="toggleBit(1, this)">0</button>
        <button class="bit-btn" onclick="toggleBit(0, this)">0</button>
    </div>
    
    <div class="text-box">
        Decimal Value: <span id="bit-val" class="bit-display">0</span>
    </div>
    
    <button onclick="checkBits()">ÎšÎ©Î”Î™ÎšÎŸÎ ÎŸÎ™Î—Î£Î— & Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î—</button>

    <p id="feedback3"></p>
    <div id="key-earned-room3" class="key-earned"></div>
    <p id="hint-room3" class="hint-text"></p>
    <button onclick="showHint('room3')">ğŸ’¡ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·</button>
    <button onclick="repeatQuestion('room3')">ğŸ™ï¸ Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ· Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚</button>
  </div>
  <button onclick="goTo('intro')">ÎœÎµÎ½Î¿Ï</button>
  <button onclick="goTo('glossary')">Î“Î»Ï‰ÏƒÏƒÎ¬ÏÎ¹</button>
</div>

<div id="room4" class="screen">
  <h2>Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 4: Î¥Î»Î¹ÎºÏŒ Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î® (Dark Sector)</h2>
  <div class="difficulty-badge difficulty-medium">ğŸŸ¡ Level 2</div>
  <div class="text-box story-box story-highlight" id="story-room4">
    Î¤Î¿ Firewall ÎµÎ¯Î½Î±Î¹ ÎµÎ½ÎµÏÎ³ÏŒ ÎºÎ±Î¹ Î¼Ï€Î»Î¿ÎºÎ¬ÏÎµÎ¹ Ï„Î·Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·. Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÏƒÏ‰ÏƒÏ„ÏŒ Port ÎºÎ±Î¹ Î¼ÎµÏ„Î¬ ÎµÏ€Î¹Î»Î¿Î³Î® ÎºÎ±Ï„Î¬Î»Î»Î·Î»Î¿Ï… Î¼Î­ÏƒÎ¿Ï… Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚.<br>
    <span style="color:red">Î Î¡ÎŸÎ£ÎŸÎ§Î—: Î”Î¹Î±ÎºÎ¿Ï€Î® ÏÎµÏÎ¼Î±Ï„Î¿Ï‚! Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿Î½ Ï†Î±ÎºÏŒ.</span><br>
    <span style="color:#ffd700; font-size:0.9em;">ğŸ’¡ Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ Toolkit (Î£Ï…Î½Î´Ï…Î±ÏƒÎ¼ÏŒÏ‚) Î³Î¹Î± Î½Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ Ï„Î·Î½ ÎµÎ¯ÏƒÎ¿Î´Î¿ Port.</span>
  </div>

  <div class="interaction-layer">
    <div class="hotspot" style="top: 10%; left: 15%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room4', 'ğŸ“', 'Note: Î— RAM Î±Î´ÎµÎ¹Î¬Î¶ÎµÎ¹ ÏŒÏ„Î±Î½ ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹ Ï„Î¿ ÏÎµÏÎ¼Î±.', this)">ğŸ“</div>

    <div class="hotspot hotspot-lock" id="lock-room4" style="top: 75%; left: 35%; width:100px;" title="ÎšÎ»ÎµÎ¹Î´Î±ÏÎ¹Î¬"
         onclick="attemptUnlock('room4', this)">ğŸ”’</div>

    <div class="hotspot" style="top: 50%; left: 50%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î‘Î½ÎµÎ¼Î¹ÏƒÏ„Î®ÏÎ±Ï‚ CPU ÏƒÏ„Î¿ full.', 'â„ï¸')">â„ï¸</div>
    <div class="hotspot" style="top: 85%; left: 80%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('ÎšÎ¿Ï…Ï„Î¯ Î¼Îµ Ï€Î±Î»Î¹Î­Ï‚ Î²Î¯Î´ÎµÏ‚.', 'ğŸ”©')">ğŸ”©</div>
    <div class="hotspot" id="note-room4" style="top: 60%; left: 20%; width:70px; height:70px; font-size:1.8em; border:2px solid #ffd700; display:none;" title="Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ· Ï„ÎµÏ‡Î½Î¹ÎºÎ¿Ï - ÎšÎ¬Î½Îµ ÎºÎ»Î¹Îº!" onclick="pickupItem('room4', 'ğŸ“‹', 'Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ· Ï„ÎµÏ‡Î½Î¹ÎºÎ¿Ï: ÎœÏŒÎ½Î¹Î¼Î· Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· â€“ Î¼ÏŒÎ½Î¿ Î¿ ÏƒÎºÎ»Î·ÏÏŒÏ‚ Î´Î¯ÏƒÎºÎ¿Ï‚ (HDD/SSD) Î´Î¹Î±Ï„Î·ÏÎµÎ¯ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï‡Ï‰ÏÎ¯Ï‚ ÏÎµÏÎ¼Î±.', this)">ğŸ“‹</div>
  </div>

  <div id="giant-key-room4" class="giant-key" onclick="goToNextFrom('room4', 'room5')">ğŸ—ï¸</div>

  <div id="qblock-room4" style="display:none;">
    <p id="obj-room4" class="room-objective" style="display:none; font-weight:bold; margin:0 0 8px 0;"></p>
    <div id="room4-part1">
      <div class="text-box" style="border-color:red;">ğŸ”’ FIREWALL ACTIVE.</div>
      <p>Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¸ÏÏÎ±Ï‚ (Port) Î³Î¹Î± ÎµÎ¯ÏƒÎ¿Î´Î¿. Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ Toolkit (Î£Ï…Î½Î´Ï…Î±ÏƒÎ¼ÏŒÏ‚) Î³Î¹Î± Î½Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î· ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®.</p>
      <input type="text" inputmode="numeric" id="input-port-room4" placeholder="XXXX" disabled>
      <button id="btn-port-room4" onclick="checkPortRoom4()" disabled>Î‘ÎÎŸÎ™Î“ÎœÎ‘ Î Î¡ÎŸÎ£Î’Î‘Î£Î—Î£</button>
      <p id="port-feedback" class="wrong"></p>
    </div>

    <div id="room4-part2" style="display:none;">
      <div class="media-container"><img src="images/hardware.png" alt="Hardware" width="300"></div>
      <div class="text-box"><p id="qtext-room4">Î”Î¹Î±Î³Î½Ï‰ÏƒÏ„Î¹ÎºÏŒÏ‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚: Ï€Î¿Î¹Î¿ ÎµÎ¾Î¬ÏÏ„Î·Î¼Î± Î´Î¹Î±Ï„Î·ÏÎµÎ¯ Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÏŒÏ„Î±Î½ ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹ Ï„Î¿ ÏÎµÏÎ¼Î±;</p></div>
      <div class="answers" id="answers-room4">
        <button onclick="checkAnswer('feedback4', true, null, 'room4')">Î£ÎºÎ»Î·ÏÏŒÏ‚ Î´Î¯ÏƒÎºÎ¿Ï‚ (HDD / SSD)</button>
        <button onclick="checkAnswer('feedback4', false, null, 'room4')">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÏ„Î®Ï‚ (CPU)</button>
        <button onclick="checkAnswer('feedback4', false, null, 'room4')">ÎšÎ¬ÏÏ„Î± Î³ÏÎ±Ï†Î¹ÎºÏÎ½ (GPU)</button>
      </div>
      <p id="feedback4"></p>
      <div id="key-earned-room4" class="key-earned"></div>
      <p id="hint-room4" class="hint-text"></p>
      <button onclick="showHint('room4')">ğŸ’¡ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·</button>
      <button onclick="repeatQuestion('room4')">ğŸ™ï¸ Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ· Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚</button>
    </div>
  </div>

  <button onclick="goTo('intro')">ÎœÎµÎ½Î¿Ï</button>
  <button onclick="goTo('glossary')">Î“Î»Ï‰ÏƒÏƒÎ¬ÏÎ¹</button>
</div>

<div id="room5" class="screen">
  <h2>Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 5: Î‘ÏƒÏ†Î±Î»Î®Ï‚ ÎšÏ‰Î´Î¹ÎºÏŒÏ‚</h2>
  <div class="difficulty-badge difficulty-medium">ğŸŸ¡ Level 2</div>
  <div class="text-box story-box story-highlight" id="story-room5">
    Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®. ÎŸ Î¹ÏŒÏ‚ ÎµÎ»Î­Î³Ï‡ÎµÎ¹ Î³Î¹Î± Î±Î´ÏÎ½Î±Î¼ÎµÏ‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚.<br>
    <span style="color:#ffd700; font-size:0.9em;">ğŸ’¡ Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î­Î½Î± Ï„ÏƒÎ±Î»Î±ÎºÏ‰Î¼Î­Î½Î¿ Ï‡Î±ÏÏ„Î¯ ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿. ÎšÎ¬Î½Îµ Inspect ÏƒÏ„Î¿ Toolkit Î³Î¹Î± Î½Î± Î´ÎµÎ¹Ï‚ Ï„Î¿ ÎºÏÏ…Ï†ÏŒ Î¼Î®Î½Ï…Î¼Î±.</span>
  </div>
  <div class="interaction-layer">
    <div class="hotspot" style="top: 55%; left: 10%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room5', 'ğŸ“„', 'Î¤ÏƒÎ±Î»Î±ÎºÏ‰Î¼Î­Î½Î¿ Ï‡Î±ÏÏ„Î¯... (ÎšÎ¬Î½Îµ Inspect ÏƒÏ„Î¿ ÏƒÎ±ÎºÎ¯Î´Î¹Î¿!)', this, 'PASSWORD: 1234')">ğŸ“„</div>

    <div class="hotspot hotspot-lock" id="lock-room5" style="top: 40%; left: 80%; width:90px;" title="ÎšÎ»ÎµÎ¹Î´Î±ÏÎ¹Î¬"
         onclick="attemptUnlock('room5', this)">ğŸ”’</div>

    <div class="hotspot" style="top: 90%; left: 50%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î¨Î¯Ï‡Î¿Ï…Î»Î± ÏƒÏ„Î¿ Ï€Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î¹Î¿.', 'ğŸª')"
         ondblclick="showDeepScan('Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·: ÎŸ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ Î²ÏÎ¯ÏƒÎºÎµÏ„Î±Î¹ ÏƒÎµ Ï‡Î±ÏÏ„Î¯ Ï€Î¿Ï… Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Inspect ÏƒÏ„Î¿ Î£Î±ÎºÎ¯Î´Î¹Î¿.')">ğŸª</div>
    <div class="hotspot" style="top: 10%; left: 30%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('ÎšÎ¬Î¼ÎµÏÎ± Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚.', 'ğŸ“¹')">ğŸ“¹</div>
    <div class="hotspot" style="top: 70%; left: 90%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î¤Î¿ Ï€Î¿Î½Ï„Î¯ÎºÎ¹ ÎºÎ¿Î»Î»Î¬ÎµÎ¹.', 'ğŸ–±ï¸')">ğŸ–±ï¸</div>
  </div>

  <div id="giant-key-room5" class="giant-key" onclick="goToNextFrom('room5', 'room6')">ğŸ—ï¸</div>

  <div id="qblock-room5" style="display:none;">
    <p id="obj-room5" class="room-objective" style="display:none; font-weight:bold; margin:0 0 8px 0;"></p>
    <div class="media-container"><img src="images/password.png" alt="Password" width="300"></div>
    <div class="text-box"><p id="qtext-room5">ADMIN ACCESS: ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î® Ï„ÎµÏ„ÏÎ±ÏˆÎ®Ï†Î¹Î¿Ï… ÎºÏ‰Î´Î¹ÎºÎ¿Ï ÎµÏ€Î±Î»Î®Î¸ÎµÏ…ÏƒÎ·Ï‚.</p></div>

    <input type="text" id="keypad-display" class="keypad-display" readonly placeholder="----">
    
    <div class="keypad-container">
      <button class="keypad-btn" onclick="kpPress(1)">1</button>
      <button class="keypad-btn" onclick="kpPress(2)">2</button>
      <button class="keypad-btn" onclick="kpPress(3)">3</button>
      <button class="keypad-btn" onclick="kpPress(4)">4</button>
      <button class="keypad-btn" onclick="kpPress(5)">5</button>
      <button class="keypad-btn" onclick="kpPress(6)">6</button>
      <button class="keypad-btn" onclick="kpClear()" style="background:#500;">CLR</button>
      <button class="keypad-btn" onclick="kpPress(0)">0</button>
      <button class="keypad-btn" onclick="kpEnter()" style="background:#050;">ENT</button>
    </div>

    <p id="feedback5"></p>
    <div id="key-earned-room5" class="key-earned"></div>
    <p id="hint-room5" class="hint-text"></p>
    <button onclick="showHint('room5')">ğŸ’¡ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·</button>
    <button onclick="repeatQuestion('room5')">ğŸ™ï¸ Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ· Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚</button>
  </div>
  <button onclick="goTo('intro')">ÎœÎµÎ½Î¿Ï</button>
  <button onclick="goTo('glossary')">Î“Î»Ï‰ÏƒÏƒÎ¬ÏÎ¹</button>
</div>

<div id="room6" class="screen">
  <h2>Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 6: ÎœÎ¹ÎºÏÏŒÏ‚ Î‘Î»Î³ÏŒÏÎ¹Î¸Î¼Î¿Ï‚ (Parsons)</h2>
  <div class="difficulty-badge difficulty-medium">ğŸŸ¡ Level 2</div>
  <div class="text-box story-box story-highlight" id="story-room6">
    ÎŸ Î±Î»Î³ÏŒÏÎ¹Î¸Î¼Î¿Ï‚ ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î¼Îµ ÏƒÏ†Î¬Î»Î¼Î± ÎµÏ€ÎµÎ¹Î´Î® Î· ÏÎ¿Î® ÎµÎ¯Î½Î±Î¹ Î±Î½Î±ÎºÎ±Ï„ÎµÎ¼Î­Î½Î·.<br>
    <span style="color:#ffd700; font-size:0.9em;">ğŸ’¡ Î’ÏÎµÏ‚ Ï„Î¿ Hint ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿ Î³Î¹Î± Î½Î± Î¼Î¬Î¸ÎµÎ¹Ï‚ Ï„Î· ÏƒÏ‰ÏƒÏ„Î® ÏƒÎµÎ¹ÏÎ¬.</span>
  </div>
  <div class="interaction-layer">
    <div class="hotspot" style="top: 25%; left: 30%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room6', 'ğŸ‘¨â€ğŸ«', 'Hint: Î ÏÏÏ„Î± Î±ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ, Î¼ÎµÏ„Î¬ Loop, Î¼ÎµÏ„Î¬ Print.', this)">ğŸ‘¨â€ğŸ«</div>

    <div class="hotspot hotspot-lock" id="lock-room6" style="top: 70%; left: 60%;" title="ÎšÎ»ÎµÎ¹Î´Î±ÏÎ¹Î¬"
         onclick="attemptUnlock('room6', this)">ğŸ”’</div>

    <div class="hotspot" style="top: 40%; left: 10%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î ÏÎ¿Ï„Î¶Î­ÎºÏ„Î¿ÏÎ±Ï‚.', 'ğŸ“½ï¸')">ğŸ“½ï¸</div>
    <div class="hotspot" style="top: 90%; left: 40%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î£Ï†Î¿Ï…Î³Î³Î¬ÏÎ¹.', 'ğŸ§½')">ğŸ§½</div>
    <div class="hotspot" style="top: 10%; left: 80%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î¡Î¿Î»ÏŒÎ¹.', 'ğŸ•°ï¸')">ğŸ•°ï¸</div>
  </div>

  <div id="giant-key-room6" class="giant-key" onclick="goToNextFrom('room6', 'room7')">ğŸ—ï¸</div>

  <div id="qblock-room6" style="display:none;">
    <p id="obj-room6" class="room-objective" style="display:none; font-weight:bold; margin:0 0 8px 0;"></p>
    <div class="text-box"><p id="qtext-room6">Î‘Î½Î±Î´Î¹Î¬Ï„Î±Î¾Î· ÏÎ¿Î®Ï‚: ÏƒÏÏÎµ Ï„Î¹Ï‚ ÎµÎ½Ï„Î¿Î»Î­Ï‚ ÏƒÏ„Î· ÏƒÏ‰ÏƒÏ„Î® ÏƒÎµÎ¹ÏÎ¬ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚.</p></div>
    
    <div class="parsons-container">
        <div id="parsons-source" class="drag-container" style="min-height:100px; background:rgba(0,0,0,0.3); width:100%; border:1px solid #555;">
            <div class="parsons-line" draggable="true" id="p1">print(total)</div>
            <div class="parsons-line" draggable="true" id="p2">total = 0</div>
            <div class="parsons-line" draggable="true" id="p3">for i in range(3):</div>
            <div class="parsons-line" draggable="true" id="p4">total = total + i</div>
        </div>
        
        <div style="font-size:20px;">â¬‡ï¸</div>
        
        <div id="parsons-target" class="parsons-drop-area"></div>
    </div>
    
    <button onclick="checkParsons()">Î•ÎšÎ¤Î•Î›Î•Î£Î—</button>
    <p id="feedback6"></p>
    <div id="key-earned-room6" class="key-earned"></div>
    <p id="hint-room6" class="hint-text"></p>
    <button onclick="showHint('room6')">ğŸ’¡ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·</button>
    <button onclick="repeatQuestion('room6')">ğŸ™ï¸ Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ· Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚</button>
  </div>

  <button onclick="goTo('intro')">ÎœÎµÎ½Î¿Ï</button>
  <button onclick="goTo('glossary')">Î“Î»Ï‰ÏƒÏƒÎ¬ÏÎ¹</button>
</div>

<div id="room7" class="screen">
  <h2>Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 7: Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ· ÏƒÎµ Python</h2>
  <div class="difficulty-badge difficulty-medium">ğŸŸ¡ Level 2</div>
  <div class="text-box story-box story-highlight" id="story-room7">
    ÎŸÎ¹ ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î­Ï‚ Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î½ Î­Î¾Î¿Î´Î¿ Î±Ï€ÏŒ ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ· Î¼Îµ Î²Î®Î¼Î±. Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï€ÏÎ¿Î²Î»Î­ÏˆÎµÎ¹Ï‚ Ï„Î·Î½ Î­Î¾Î¿Î´Î¿ Î³Î¹Î± Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÎ¹Ï‚.<br>
    <span style="color:#ffd700; font-size:0.9em;">ğŸ’¡ ÎˆÎ»ÎµÎ³Î¾Îµ Ï„Î·Î½ Î¿Î¸ÏŒÎ½Î· Ï€ÏÎ¿ÏƒÎ¿Î¼Î¿Î¹Ï‰Ï„Î® ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿ Î³Î¹Î± Î½Î± Î´ÎµÎ¹Ï‚ Ï„Î·Î½ Î­Î¾Î¿Î´Î¿. ÎœÎ·Î½ Î¾ÎµÏ‡Î¬ÏƒÎµÎ¹Ï‚ Î½Î± Î¼Î±Î¶Î­ÏˆÎµÎ¹Ï‚ Ï„Î¿ Fragment Î³Î¹Î± Ï„Î¿ Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 9.</span>
  </div>
  <div class="interaction-layer">
    <div class="hotspot" style="top: 80%; left: 50%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room7', 'ğŸ¤–', 'Robot: Step=2 ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ Ï€Î·Î´Î¬Î¼Îµ Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚ (0, 2...)', this)">ğŸ¤–</div>

    <div class="hotspot" style="top: 35%; left: 45%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room7', 'ğŸ”', 'Log Fragment A: ÎœÎ­ÏÎ¿Ï‚ 1 Î±Ï€ÏŒ 3 Î³Î¹Î± Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î²Î¬ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½. Î˜Î± Ï„Î¿ Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯Ï‚ ÏƒÏ„Î¿ Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 9 (Combine).', this)">ğŸ”</div>

    <div class="hotspot hotspot-lock" id="lock-room7" style="top: 30%; left: 85%;" title="ÎšÎ»ÎµÎ¹Î´Î±ÏÎ¹Î¬"
         onclick="attemptUnlock('room7', this)">ğŸ”’</div>

    <div class="hotspot" style="top: 15%; left: 10%;" title="Log File"
         onclick="examine('LOG FILE #2: ÎŸÎ¹ ÎµÏ€Î±Î½Î±Î»Î®ÏˆÎµÎ¹Ï‚ ÎºÎ¿Î»Î»Î¬Î½Îµ. Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î²ÏÏ‰ Ï„ÏÏŒÏ€Î¿ Î½Î± ÎºÎ¬Î½Ï‰ skip Ï„Î¿Ï…Ï‚ Î¶Ï…Î³Î¿ÏÏ‚ Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚... Î® Î¼Î®Ï€Ï‰Ï‚ Ï„Î¿Ï…Ï‚ Î¼Î¿Î½Î¿ÏÏ‚;', 'ğŸ“‚')">ğŸ“‚</div>
    <div class="hotspot" id="simulator-room7" style="top: 20%; left: 70%; display:none;" title="ÎŸÎ¸ÏŒÎ½Î· ÎµÎ¾ÏŒÎ´Î¿Ï…"
         onclick="examine('ÎŸÎ¸ÏŒÎ½Î· Ï€ÏÎ¿ÏƒÎ¿Î¼Î¿Î¹Ï‰Ï„Î®: range(0, 5, 2) â†’ ÎˆÎ¾Î¿Î´Î¿Ï‚: 0 2 4', 'ğŸ–¥ï¸')">ğŸ–¥ï¸</div>

    <div class="hotspot" style="top: 10%; left: 20%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('ÎœÏ€Î±Ï„Î±ÏÎ¯ÎµÏ‚.', 'ğŸ”‹')">ğŸ”‹</div>
    <div class="hotspot" style="top: 60%; left: 10%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î£Ï‡Î­Î´Î¹Î±.', 'ğŸ“')">ğŸ“</div>
    <div class="hotspot" style="top: 50%; left: 70%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('ÎšÎ±Ï„ÏƒÎ±Î²Î¯Î´Î¹.', 'ğŸ”§')">ğŸ”§</div>
  </div>

  <div id="giant-key-room7" class="giant-key" onclick="goToNextFrom('room7', 'room8')">ğŸ—ï¸</div>

  <div id="qblock-room7" style="display:none;">
    <p id="obj-room7" class="room-objective" style="display:none; font-weight:bold; margin:0 0 8px 0;"></p>
    <div class="media-container"><img src="images/loop.png" alt="Loop" width="300"></div>
    <div class="text-box"><p id="qtext-room7">Î‘Î½Î¬Î»Ï…ÏƒÎ· ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î®Ï‚: Ï€Î¿Î¹Î± Ï„Î¹Î¼Î® Î¸Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ ÏƒÏ„Î·Î½ Î­Î¾Î¿Î´Î¿;</p></div>
    <div class="text-box" style="text-align:left;">
      <pre style="text-align:left; background:rgba(0,0,0,0.6); padding:10px;">
for i in range(0, 5, 2):
    print(i, end=" ")</pre>
    </div>
    <div class="answers" id="answers-room7">
      <button onclick="checkAnswer('feedback7', true, null, 'room7')">0 2 4 </button>
      <button onclick="checkAnswer('feedback7', false, null, 'room7')">0 1 2 3 4 </button>
      <button onclick="checkAnswer('feedback7', false, null, 'room7')">1 3 5 </button>
    </div>
    <p id="feedback7"></p>
    <div id="key-earned-room7" class="key-earned"></div>
    <p id="hint-room7" class="hint-text"></p>
    <button onclick="showHint('room7')">ğŸ’¡ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·</button>
    <button onclick="repeatQuestion('room7')">ğŸ™ï¸ Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ· Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚</button>
  </div>

  <button onclick="goTo('intro')">ÎœÎµÎ½Î¿Ï</button>
  <button onclick="goTo('glossary')">Î“Î»Ï‰ÏƒÏƒÎ¬ÏÎ¹</button>
</div>

<div id="room8" class="screen">
  <h2>Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 8: Debugging</h2>
  <div class="difficulty-badge difficulty-hard">ğŸ”´ Level 3</div>
  <div class="text-box story-box story-highlight" id="story-room8">
    Î— Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Ï„Î±Ï…Ï„Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ Î±Ï€Î­Ï„Ï…Ï‡Îµ Î»ÏŒÎ³Ï‰ ÏƒÏ…Î½Ï„Î±ÎºÏ„Î¹ÎºÎ¿Ï ÏƒÏ†Î¬Î»Î¼Î±Ï„Î¿Ï‚.<br>
    <span style="color:#ffd700; font-size:0.9em;">ğŸ’¡ Î§ÏÎµÎ¹Î¬Î¶ÎµÏƒÎ±Î¹ Ï„Î¿ Debugger Tool (USB stick) ÏƒÏ„Î¿ Ï€Î¬Ï„Ï‰Î¼Î± Î³Î¹Î± Î½Î± ÏƒÎ±ÏÏÏƒÎµÎ¹Ï‚ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ±. ÎœÎ·Î½ Î¾ÎµÏ‡Î¬ÏƒÎµÎ¹Ï‚ Ï„Î¿ Fragment Î³Î¹Î± Ï„Î¿ Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 9.</span>
  </div>
  <div class="interaction-layer">
    <div class="hotspot" style="top: 10%; left: 60%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room8', 'ğŸŒ¡ï¸', 'Î˜ÎµÏÎ¼ÏŒÎ¼ÎµÏ„ÏÎ¿: Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ == Î³Î¹Î± ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ·.', this)">ğŸŒ¡ï¸</div>

    <div class="hotspot" style="top: 40%; left: 15%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room8', 'ğŸ§©', 'Cipher Fragment B: ÎœÎ­ÏÎ¿Ï‚ 2 Î±Ï€ÏŒ 3 Î³Î¹Î± Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î²Î¬ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½. Î˜Î± Ï„Î¿ Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯Ï‚ ÏƒÏ„Î¿ Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 9 (Combine).', this)">ğŸ§©</div>

    <div class="hotspot hotspot-lock" id="lock-room8" style="top: 60%; left: 40%; width:80px;" title="ÎšÎ»ÎµÎ¹Î´Î±ÏÎ¹Î¬"
         onclick="attemptUnlock('room8', this)">ğŸ”’</div>

    <div class="hotspot" style="top: 90%; left: 10%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î§ÎµÎ¹ÏÎ¹ÏƒÏ„Î®ÏÎ¹Î¿.', 'ğŸ›ï¸')">ğŸ›ï¸</div>
    <div class="hotspot" style="top: 30%; left: 90%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î Î±ÏÎ¬Î¸Ï…ÏÎ¿.', 'ğŸªŸ')">ğŸªŸ</div>
    <div class="hotspot" style="top: 50%; left: 20%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î£Ï…Î½Î±Î³ÎµÏÎ¼ÏŒÏ‚.', 'ğŸš¨')">ğŸš¨</div>
    <div class="hotspot" style="top: 80%; left: 65%; width:70px; height:70px; font-size:1.8em; border:2px solid #00ffff; animation: pulse-glow 2s infinite;" title="Debugger Tool (USB) - ÎšÎ¬Î½Îµ ÎºÎ»Î¹Îº!" onclick="pickupItem('room8', 'ğŸ”Œ', 'Debugger Tool (USB stick): Î£ÏÏÎµ Ï„Î¿ ÏƒÏ„Î·Î½ Î¿Î¸ÏŒÎ½Î· ÎºÏÎ´Î¹ÎºÎ± Î³Î¹Î± ÏƒÎ¬ÏÏ‰ÏƒÎ· ÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰Î½.', this)">ğŸ”Œ</div>
  </div>

  <div id="giant-key-room8" class="giant-key" onclick="goToNextFrom('room8', 'room9')">ğŸ—ï¸</div>

  <div id="qblock-room8" style="display:none;">
    <p id="obj-room8" class="room-objective" style="display:none; font-weight:bold; margin:0 0 8px 0;"></p>
    <div id="room8-need-debugger" class="text-box">
      <p>Î§ÏÎµÎ¹Î¬Î¶ÎµÏƒÎ±Î¹ Ï„Î¿ <b>Debugger Tool</b> Î³Î¹Î± Î½Î± ÏƒÎ±ÏÏÏƒÎµÎ¹Ï‚ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± ÎºÎ±Î¹ Î½Î± ÎµÎ½Ï„Î¿Ï€Î¯ÏƒÎµÎ¹Ï‚ Ï„Î¿ ÏƒÏ†Î¬Î»Î¼Î±. Î’ÏÎµÏ‚ Ï„Î¿ USB stick ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿ (ÏƒÏ„Î¿ Ï€Î¬Ï„Ï‰Î¼Î±) ÎºÎ±Î¹ Ï€Î¬Ï„Î± Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÏŒÏ„Î±Î½ Ï„Î¿ Î­Ï‡ÎµÎ¹Ï‚.</p>
      <button onclick="useDebuggerRoom8()">Î•Ï†Î±ÏÎ¼Î¿Î³Î® Debugger (ÏƒÎ¬ÏÏ‰ÏƒÎ· ÎºÏÎ´Î¹ÎºÎ±)</button>
      <button onclick="closePuzzleBackToRoom('room8')" style="margin-left:8px; background:#555;">Î Î¯ÏƒÏ‰ ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿</button>
    </div>
    <div id="room8-code-area" style="display:none;">
      <div class="text-box"><p id="qtext-room8">Î”Î¹Î±Î³Î½Ï‰ÏƒÏ„Î¹ÎºÏŒÏ‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚: ÎºÎ¬Î½Îµ ÎºÎ»Î¹Îº ÏƒÏ„Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿ Ï€Î¿Ï… Ï€ÏÎ¿ÎºÎ±Î»ÎµÎ¯ Ï„Î¿ ÏƒÏ†Î¬Î»Î¼Î±.</p></div>
      <div class="text-box" style="text-align:left; font-family:'Courier New', monospace; font-size:1.2em;">
         <span class="code-token" onclick="checkBug(false, 'if', this)">if</span>
         <span class="code-token" onclick="checkBug(false, 'password', this)">password</span>
         <span class="code-token" onclick="checkBug(true, '=', this)">=</span> <span class="code-token" onclick="checkBug(false, 'string1234', this)">"1234"</span>
         <span class="code-token" onclick="checkBug(false, 'colon', this)">:</span><br>
         &nbsp;&nbsp;<span class="code-token" onclick="checkBug(false, 'print', this)">print("Access Granted")</span>
      </div>
      <div id="room8-tooltip"></div>
    </div>

    <p id="feedback8"></p>
    <div id="key-earned-room8" class="key-earned"></div>
    <p id="hint-room8" class="hint-text"></p>
    <button onclick="showHint('room8')">ğŸ’¡ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·</button>
    <button onclick="repeatQuestion('room8')">ğŸ™ï¸ Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ· Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚</button>
  </div>

  <button onclick="goTo('intro')">ÎœÎµÎ½Î¿Ï</button>
  <button onclick="goTo('glossary')">Î“Î»Ï‰ÏƒÏƒÎ¬ÏÎ¹</button>
</div>

<div id="room9" class="screen">
  <h2>Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 9: Î’Î¬ÏƒÎµÎ¹Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½</h2>
  <div class="difficulty-badge difficulty-hard">ğŸ”´ Level 3</div>
  <div class="text-box story-box story-highlight" id="story-room9">
    Î— Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î´ÎµÎ½ ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±. Î›ÎµÎ¯Ï€ÎµÎ¹ Î· ÏƒÏ‰ÏƒÏ„Î® ÎµÎ½Ï„Î¿Î»Î® Î±Î½Î¬ÎºÏ„Î·ÏƒÎ·Ï‚.<br>
    <span style="color:#ffd700; font-size:0.9em;">ğŸ’¡ Î¨Î¬Î¾Îµ ÏƒÏ„Î¿Î½ ÎºÎ¬Î´Î¿ Î±Î½Î±ÎºÏÎºÎ»Ï‰ÏƒÎ·Ï‚ Î³Î¹Î± ÏƒÎºÎ¿Î½Î¬ÎºÎ¹ Î¼Îµ Ï…Ï€ÏŒÎ´ÎµÎ¹Î¾Î· SQL. Î§ÏÎµÎ¹Î¬Î¶ÎµÏƒÎ±Î¹ Ï„Î± 3 Fragments (A, B, C) Î³Î¹Î± Combine ÎºÎ±Î¹ Ï„Î¿ Master Key.</span>
  </div>

  <div class="interaction-layer">
    <div class="hotspot" style="top: 25%; left: 80%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room9', 'ğŸ—„ï¸', 'SQL Manual: SELECT Î³Î¹Î± Î±Î½Î¬ÎºÏ„Î·ÏƒÎ·.', this)">ğŸ—„ï¸</div>

    <div class="hotspot" style="top: 20%; left: 10%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room9', 'ğŸ—ƒï¸', 'Schema Fragment C: ÎœÎ­ÏÎ¿Ï‚ 3 Î±Ï€ÏŒ 3 Î³Î¹Î± Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î²Î¬ÏƒÎ·Ï‚. Î£Ï„Î¿ Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 9 ÎºÎ¬Î½Îµ Combine ÎºÎ±Î¹ Ï„Î± Ï„ÏÎ¯Î± Î¸ÏÎ±ÏÏƒÎ¼Î±Ï„Î± Î³Î¹Î± Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯.', this)">ğŸ—ƒï¸</div>

    <div class="hotspot hotspot-lock" id="lock-room9" style="top: 75%; left: 20%; width:100px;" title="ÎšÎ»ÎµÎ¹Î´Î±ÏÎ¹Î¬"
         onclick="attemptUnlock('room9', this)">ğŸ”’</div>

    <div class="hotspot" style="top: 50%; left: 50%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('ÎšÎ±Î»ÏÎ´Î¹Î± Server.', 'ğŸ”—')">ğŸ”—</div>
    <div class="hotspot" style="top: 10%; left: 10%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î Ï…ÏÎ¿ÏƒÎ²ÎµÏƒÏ„Î®ÏÎ±Ï‚.', 'ğŸ§¯')">ğŸ§¯</div>
    <div class="hotspot" style="top: 90%; left: 90%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î£ÎºÎ»Î·ÏÏŒÏ‚ Î´Î¯ÏƒÎºÎ¿Ï‚.', 'ğŸ’¾')">ğŸ’¾</div>
    <div class="hotspot" style="top: 88%; left: 45%; width:80px; height:80px; font-size:2em; border:2px solid #ffd700; animation: pulse-glow 2s infinite;" title="ÎšÎ¬Î´Î¿Ï‚ Î±Î½Î±ÎºÏÎºÎ»Ï‰ÏƒÎ·Ï‚ - Î£ÎºÎ¿Î½Î¬ÎºÎ¹ Î¼Î­ÏƒÎ±!" onclick="pickupItem('room9', 'ğŸ“', 'Î£ÎºÎ¿Î½Î¬ÎºÎ¹ SQL: Î˜Ï…Î¼Î®ÏƒÎ¿Ï…: SELECT Î³Î¹Î± Î´Î¹Î¬Î²Î±ÏƒÎ¼Î±, INSERT Î³Î¹Î± Î³ÏÎ¬ÏˆÎ¹Î¼Î¿.', this)">ğŸ—‘ï¸</div>
  </div>

  <div id="giant-key-room9" class="giant-key" onclick="goToNextFrom('room9', 'room10')">ğŸ—ï¸</div>

  <div id="qblock-room9" style="display:none;">
    <p id="obj-room9" class="room-objective" style="display:none; font-weight:bold; margin:0 0 8px 0;"></p>
    <div class="media-container"><img src="images/database.png" alt="db" width="300"></div>
    <div class="text-box"><p id="qtext-room9">Î‘Î½Î¬ÎºÏ„Î·ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½: Ï€Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ ÏƒÏ„Î¿ Ï„ÎµÏÎ¼Î±Ï„Î¹ÎºÏŒ Ï„Î·Î½ ÎµÎ½Ï„Î¿Î»Î® Ï€Î¿Ï… Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î±. (ÎÎ±Î½Î±Î´Î­Ï‚ Ï„Î¿ ÏƒÎºÎ¿Î½Î¬ÎºÎ¹ Ï€Î¿Ï… Î¼Î¬Î¶ÎµÏˆÎµÏ‚ ÏƒÏ„Î¿ toolkit Î±Î½ Î¾Î­Ï‡Î±ÏƒÎµÏ‚ Ï„Î·Î½ Ï…Ï€ÏŒÎ´ÎµÎ¹Î¾Î·.)</p></div>
    <div class="text-box" style="text-align:left; font-family:monospace; background:#111; padding:8px;">
      <span style="color:#0f0;">db&gt;</span> <input type="text" id="input-sql-room9" placeholder="ÎµÎ½Ï„Î¿Î»Î®..." style="width:180px; background:#222; color:#0f0; border:1px solid #333; padding:4px;" />
      <button onclick="submitSqlRoom9()">Î•ÎºÏ„Î­Î»ÎµÏƒÎ·</button>
    </div>
    <p id="feedback9"></p>
    <div id="key-earned-room9" class="key-earned"></div>
    <p id="hint-room9" class="hint-text"></p>
    <button onclick="showHint('room9')">ğŸ’¡ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·</button>
    <button onclick="repeatQuestion('room9')">ğŸ™ï¸ Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ· Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚</button>
  </div>

  <button onclick="goTo('intro')">ÎœÎµÎ½Î¿Ï</button>
  <button onclick="goTo('glossary')">Î“Î»Ï‰ÏƒÏƒÎ¬ÏÎ¹</button>
</div>

<div id="room10" class="screen">
  <h2 style="color:red; animation: blinker 0.5s infinite;">âš ï¸ FINAL NODE: SERVER CORE</h2>
  <div class="difficulty-badge difficulty-boss">â˜ ï¸ BOSS FIGHT</div>
  <div class="text-box story-box story-highlight" id="story-room10">
    ÎŸ Wiper Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚. Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ Ï€ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î¿ Î±Î½Ï„Î¹Î¼ÎµÏ„ÏÏ€Î¹ÏƒÎ·Ï‚ Î±Ï€ÎµÎ¹Î»Î®Ï‚.<br>
    <span style="color:#ffd700; font-size:0.9em;">ğŸ’¡ Î’ÏÎµÏ‚ Ï€ÏÏÏ„Î± Ï„Î¿ Intel ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿. ÎœÎµÏ„Î¬ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î³Î¹Î± Ï„Î¿ Ï„ÎµÎ»Î¹ÎºÏŒ ÏƒÏ„Î¬Î´Î¹Î¿.</span>
  </div>

  <div class="interaction-layer">
    <div class="hotspot" style="top: 50%; left: 50%;" title="Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿"
         onclick="pickupItem('room10', 'ğŸ“§', 'Intel: Phishing creates urgency!', this)">ğŸ“§</div>

    <div class="hotspot hotspot-lock" id="lock-room10" style="top: 40%; left: 85%; width:100px; height:100px;" title="ÎšÎ»ÎµÎ¹Î´Î±ÏÎ¹Î¬"
         onclick="attemptUnlock('room10', this)">ğŸ”’</div>

    <div class="hotspot" style="top: 80%; left: 20%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î§Î±ÏÏ„Î¹Î¬ Î¼Îµ Î¬ÏƒÏ‡ÎµÏ„ÎµÏ‚ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚.', 'ğŸ“')">ğŸ“</div>
    <div class="hotspot" style="top: 10%; left: 60%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î•Ï€Î¹Î³ÏÎ±Ï†Î® Î•ÎÎŸÎ”ÎŸÎ£.', 'ğŸšª')">ğŸšª</div>
    <div class="hotspot" style="top: 70%; left: 10%;" title="Î‘Î½Î¬Î»Ï…ÏƒÎ·" onclick="examine('Î¤Î¿ Ï€ÏŒÎ¼Î¿Î»Î¿ ÎµÎ¯Î½Î±Î¹ Ï‡Î±Î»Î±ÏƒÎ¼Î­Î½Î¿.', 'ğŸš«')">ğŸš«</div>
  </div>

  <div id="giant-key-room10" class="giant-key" onclick="goToNextFrom('room10', 'exit')">ğŸ—ï¸</div>

  <div id="qblock-room10" style="display:none;" class="boss-active text-box">
    <p id="obj-room10" class="room-objective" style="display:none; font-weight:bold; margin:0 0 8px 0;"></p>
    <div id="boss-status">VIRUS UPLOAD: <span id="boss-pct">0%</span></div>

    <div id="boss-step-1">
      <p><b>INBOX â€“ Î‘Ï€Î¿Î¸Î®ÎºÎ· Î±Ï€ÎµÎ¹Î»ÏÎ½:</b> Î”Î¹Î­Î³ÏÎ±ÏˆÎµ Ï„Î¿ email Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Phishing (Ï€Î¯ÎµÏƒÎ· Î³Î¹Î± Î¬Î¼ÎµÏƒÎ¿ ÎºÎ»Î¹Îº).</p>
      <div class="email-inbox">
        <div class="email-card" id="email-phishing">
          <div class="email-from">support@urgent-bank.xx</div>
          <div class="email-subject">ÎŸ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ ÎºÎ»ÎµÎ¯Î½ÎµÎ¹ Î£Î—ÎœÎ•Î¡Î‘! ÎšÎ»Î¹Îº ÎµÎ´Ï!</div>
          <div class="email-preview">Î ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÏ€Î¹Î²ÎµÎ²Î±Î¹ÏÏƒÎµÎ¹Ï‚ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÏƒÎ¿Ï… Î±Î¼Î­ÏƒÏ‰Ï‚ Î±Î»Î»Î¹ÏÏ‚ Î¿ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ Î¸Î± ÎºÎ»ÎµÎ¹Î´Ï‰Î¸ÎµÎ¯...</div>
          <button class="email-delete" onclick="bossFightStep(1, true)">Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
        </div>
        <div class="email-card" id="email-safe1">
          <div class="email-from">no-reply@gov.gr</div>
          <div class="email-subject">ÎŸÎ¹ Î²Î±Î¸Î¼Î¿Î¯ Î±Î½Î±ÏÏ„Î®Î¸Î·ÎºÎ±Î½</div>
          <div class="email-preview">ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± ÎµÎ»Î­Î³Î¾ÎµÎ¹Ï‚ Ï„Î¿Ï…Ï‚ Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¹ÎºÎ¿ÏÏ‚ Ï€Î¯Î½Î±ÎºÎµÏ‚ ÏƒÏ„Î¿ gov.gr...</div>
          <button class="email-delete" onclick="bossFightStep(1, false)">Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
        </div>
        <div class="email-card" id="email-safe2">
          <div class="email-from">newsletter@school.edu</div>
          <div class="email-subject">Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï€ÏÎ¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î¿Ï‚</div>
          <div class="email-preview">Î¤Î¿ Î½Î­Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î¼Î±Î¸Î·Î¼Î¬Ï„Ï‰Î½ Î¸Î± Î±Î½Î±ÏÏ„Î·Î¸ÎµÎ¯ Ï„Î·Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î· ÎµÎ²Î´Î¿Î¼Î¬Î´Î±...</div>
          <button class="email-delete" onclick="bossFightStep(1, false)">Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
        </div>
      </div>
    </div>

    <div id="boss-step-2" style="display:none;">
      <p><b>Î Î¬Î½ÎµÎ» Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚:</b> Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Ï€Î¿Ï… Î¼Ï€Î»Î¿ÎºÎ¬ÏÎµÎ¹ Î¼Î· ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´Î¿Ï„Î·Î¼Î­Î½ÎµÏ‚ ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹Ï‚.</p>
      <div class="security-panel">
        <div class="security-option" onclick="bossFightStep(2, false)"><span class="sec-icon">ğŸ›¡ï¸</span> Antivirus â€“ ÏƒÎ¬ÏÏ‰ÏƒÎ· Î±ÏÏ‡ÎµÎ¯Ï‰Î½</div>
        <div class="security-option correct-option" onclick="bossFightStep(2, true)"><span class="sec-icon">ğŸ”¥</span> Firewall â€“ Ï†ÏÎ±Î³Î® ÏƒÏ…Î½Î´Î­ÏƒÎµÏ‰Î½</div>
        <div class="security-option" onclick="bossFightStep(2, false)"><span class="sec-icon">ğŸ””</span> IDS â€“ Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·</div>
      </div>
    </div>

    <div id="boss-step-3" style="display:none;">
      <p><b>Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ server:</b> Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï„Î¿ Î±ÏƒÏ†Î±Î»Î­Ï‚ ÎºÎ±Î½Î¬Î»Î¹ Î³Î¹Î± Î¼ÎµÏ„Î¬Î´Î¿ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.</p>
      <div class="protocol-choice">
        <div class="protocol-option" onclick="bossFightStep(3, false)">http://secure-server.local â€“ HTTP</div>
        <div class="protocol-option correct-option" onclick="bossFightStep(3, true)">https://secure-server.local â€“ HTTPS</div>
      </div>
    </div>

    <p id="feedback10"></p>
    <div id="key-earned-room10" class="key-earned"></div>
  </div>

  <button onclick="goTo('intro')">ÎœÎµÎ½Î¿Ï</button>
</div>

<div id="glossary" class="screen">
  <h2>Î“Î»Ï‰ÏƒÏƒÎ¬ÏÎ¹ Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¹ÎºÎ®Ï‚</h2>
  <div class="text-box">
    <ul style="text-align:left; max-width:650px; margin:0 auto;">
      <li><b>IP:</b> <a href="https://el.wikipedia.org/wiki/IP" target="_blank">Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î´Î¹Î±Î´Î¹ÎºÏ„ÏÎ¿Ï…</a>.</li>
      <li><b>DNS:</b> <a href="https://el.wikipedia.org/wiki/Domain_Name_System" target="_blank">Î£ÏÏƒÏ„Î·Î¼Î± Î¿Î½Î¿Î¼Î¬Ï„Ï‰Î½ Ï‡ÏÏÎ¿Ï…</a>.</li>
      <li><b>RAM:</b> <a href="https://el.wikipedia.org/wiki/RAM" target="_blank">ÎœÎ½Î®Î¼Î· Ï„Ï…Ï‡Î±Î¯Î±Ï‚ Ï€ÏÎ¿ÏƒÏ€Î­Î»Î±ÏƒÎ·Ï‚</a>.</li>
      <li><b>Firewall:</b> <a href="https://el.wikipedia.org/wiki/Firewall" target="_blank">Î¤ÎµÎ¯Ï‡Î¿Ï‚ Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î±Ï‚</a>.</li>
      <li><b>Python:</b> <a href="https://el.wikipedia.org/wiki/Python" target="_blank">Î“Î»ÏÏƒÏƒÎ± Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï</a>.</li>
      <li><b>HDD / SSD:</b> <a href="https://el.wikipedia.org/wiki/%CE%A3%CE%BA%CE%BB%CE%B7%CF%81%CF%8C%CF%82_%CE%B4%CE%AF%CF%83%CE%BA%CE%BF%CF%82" target="_blank">ÎœÎ¿Î½Î¬Î´ÎµÏ‚ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚</a>.</li>
      <li><b>Phishing:</b> <a href="https://el.wikipedia.org/wiki/%CE%97%CE%BB%CE%B5%CE%BA%CF%84%CF%81%CE%BF%CE%BD%CE%B9%CE%BA%CF%8C_%C2%AB%CF%88%CE%AC%CF%81%CE%B5%CE%BC%CE%B1%C2%BB" target="_blank">Î—Î»ÎµÎºÏ„ÏÎ¿Î½Î¹ÎºÏŒ "ÏˆÎ¬ÏÎµÎ¼Î±"</a>.</li>
      <li><b>Î‘Î»Î³ÏŒÏÎ¹Î¸Î¼Î¿Ï‚:</b> <a href="https://el.wikipedia.org/wiki/%CE%91%CE%BB%CE%B3%CF%8C%CF%81%CE%B9%CE%B8%CE%BC%CE%BF%CF%82" target="_blank">Î£ÎµÎ¹ÏÎ¬ ÎµÎ½Ï„Î¿Î»ÏÎ½</a>.</li>
    </ul>
  </div>
  <button onclick="goTo(lastScreen)">Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î®</button>
</div>

<div id="exit" class="screen">
  <h1>MISSION ACCOMPLISHED ğŸ‰</h1>
  <div class="media-container">
    <img src="images/escape.png" alt="Î‘Ï€ÏŒÎ´ÏÎ±ÏƒÎ· Escape Room" width="300">
  </div>

  <div class="text-box">
    <div class="fireworks">âœ¨ğŸ†âœ¨ğŸ‡âœ¨</div>
    <p id="exitCongrats"></p>
    <p class="epilogue">ÎŸ Î¹ÏŒÏ‚ ÎµÎ¾Î¿Ï…Î´ÎµÏ„ÎµÏÏÎ¸Î·ÎºÎµ. Î¤Î¿ ÎµÏÎ³Î±ÏƒÏ„Î®ÏÎ¹Î¿ ÎµÎ¯Î½Î±Î¹ Î±ÏƒÏ†Î±Î»Î­Ï‚. Î— Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ.</p>
    <p>System Integrity: <span id="finalScore"></span> / <span id="maxScore"></span></p>
    <p id="achievement"></p>
  </div>

  <div id="celebration"></div>

  <div id="extraAchievements" class="text-box"></div>
  <div id="report" class="text-box"></div>

  <div id="studentStats" class="text-box student-stats-wrapper">
    <h3 class="student-stats-title">ğŸ“Š Î‘Î½Î¬Î»Ï…ÏƒÎ· Î•Ï€Î¹Î´ÏŒÏƒÎµÏ‰Î½ Î±Î½Î¬ Node</h3>
    <div id="studentStatsContent" class="student-stats-content"></div>
  </div>

  <div class="text-box">
    <h3>Session Logs (JSON)</h3>
    <textarea id="sessionLog" style="width:100%; height:180px; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre; overflow-wrap: normal; overflow-x: auto;"></textarea>
    <br>
    <button onclick="downloadJSON()">ğŸ“¥ Î›Î®ÏˆÎ· JSON</button>
    <button onclick="downloadCSV()">ğŸ“¥ Î›Î®ÏˆÎ· CSV (Excel)</button>
    <button onclick="downloadCertificate()">ğŸ† Î›Î®ÏˆÎ· Î Î¹ÏƒÏ„Î¿Ï€Î¿Î¹Î·Ï„Î¹ÎºÎ¿Ï (PDF)</button>
  </div>

  <button onclick="restartGame()">Î Î±Î¯Î¾Îµ Î¾Î±Î½Î¬ (REBOOT)</button>
</div>

<div id="gameOver" class="screen">
  <h1 style="color: #ff0000; text-shadow: 0 0 20px #ff0000;">âš ï¸ SYSTEM FAILURE âš ï¸</h1>
  <div class="media-container">
    <div style="font-size: 120px; animation: pulseRed 1s infinite;">ğŸ’€</div>
  </div>

  <div class="text-box" style="background: rgba(100, 0, 0, 0.3); border: 3px solid #ff0000;">
    <h2 style="color: #ff6666;">ÎŸ Ï‡ÏÏŒÎ½Î¿Ï‚ Ï„ÎµÎ»ÎµÎ¯Ï‰ÏƒÎµ!</h2>
    <p style="font-size: 1.2em; margin: 20px 0;">
      Î¤Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î±Ï€Î­Ï„Ï…Ï‡Îµ. ÎŸ Î¹ÏŒÏ‚ Î­Ï‡ÎµÎ¹ ÎºÎ±Ï„Î±Î»Î¬Î²ÎµÎ¹ Ï„Î¿ ÎµÏÎ³Î±ÏƒÏ„Î®ÏÎ¹Î¿.
    </p>
    <p style="color: #ffd700; font-weight: bold; margin: 20px 0;">
      Î¤Î¹ Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚;
    </p>
    
    <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
      <button onclick="restartGame()" style="background: #ff0000; padding: 15px 30px; font-size: 1.1em; border: 2px solid #fff;">
        ğŸ”„ Î ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± Î¾Î±Î½Î¬
      </button>
      <button onclick="continueWithPenalty()" style="background: #ffaa00; padding: 15px 30px; font-size: 1.1em; border: 2px solid #fff;">
        âš¡ Î£Ï…Î½Î­Ï‡ÎµÎ¹Î± Î¼Îµ Ï€Î¿Î¹Î½Î®
      </button>
    </div>
    
    <p style="margin-top: 30px; font-size: 0.9em; color: #ccc;">
      <strong>Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·:</strong> Î‘Î½ ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹Ï‚ "Î£Ï…Î½Î­Ï‡ÎµÎ¹Î± Î¼Îµ Ï€Î¿Î¹Î½Î®", Î¸Î± Ï‡Î¬ÏƒÎµÎ¹Ï‚ 50 Ï€ÏŒÎ½Ï„Î¿Ï…Ï‚ Î±Î»Î»Î¬ Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÎ¹Ï‚ Î±Ï€ÏŒ Ï„Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿ Ï€Î¿Ï… ÏƒÏ„Î±Î¼Î¬Ï„Î·ÏƒÎµÏ‚.
    </p>
  </div>
</div>

<script>
/* ------------------ LOGGING SYSTEM (THESIS) ------------------ */
let actionLog = [];

function logAction(type, room, details) {
    const entry = {
        timestamp: new Date().toISOString(),
        elapsedTime: sessionStartTime ? Math.round((new Date() - sessionStartTime) / 1000) : 0,
        type: type,
        room: room,
        details: details,
        currentScore: score,
        currentIntegrity: integrity
    };
    actionLog.push(entry);
    console.log("LOG:", entry);
}

/* ------------------ CONFIG ------------------ */
const KEY_DISPLAY_MS = 2000;
const roomConfig = {
  room1:  { title: "Python Injector",    baseScore: 10, wrongPenalty: 2, hintPenalty: 2, difficulty: "Level 1", diffEmoji: "ğŸŸ¢", skillArea: "Python",    difficultyKey: "easy", isDark: false },
  room2:  { title: "Network Protocols",  baseScore: 10, wrongPenalty: 2, hintPenalty: 2, difficulty: "Level 1", diffEmoji: "ğŸŸ¢", skillArea: "Networks",  difficultyKey: "easy", isDark: false },
  room3:  { title: "Binary Decryption",  baseScore: 10, wrongPenalty: 2, hintPenalty: 2, difficulty: "Level 1", diffEmoji: "ğŸŸ¢", skillArea: "Binary",    difficultyKey: "easy", isDark: false },
  room4:  { title: "Server Hardware",    baseScore: 15, wrongPenalty: 3, hintPenalty: 3, difficulty: "Level 2", diffEmoji: "ğŸŸ¡", skillArea: "Hardware",  difficultyKey: "medium", isDark: true }, // Flashlight active
  room5:  { title: "Security Clearance", baseScore: 15, wrongPenalty: 3, hintPenalty: 3, difficulty: "Level 2", diffEmoji: "ğŸŸ¡", skillArea: "Security",  difficultyKey: "medium", isDark: false },
  room6:  { title: "Algorithm Debug",    baseScore: 15, wrongPenalty: 3, hintPenalty: 3, difficulty: "Level 2", diffEmoji: "ğŸŸ¡", skillArea: "Python",    difficultyKey: "medium", isDark: false },
  room7:  { title: "Loop Iteration",     baseScore: 15, wrongPenalty: 3, hintPenalty: 3, difficulty: "Level 2", diffEmoji: "ğŸŸ¡", skillArea: "Python",    difficultyKey: "medium", isDark: false },
  room8:  { title: "Logic Gates",        baseScore: 20, wrongPenalty: 5, hintPenalty: 4, difficulty: "Level 3", diffEmoji: "ğŸ”´", skillArea: "Logic",      difficultyKey: "hard", isDark: false },
  room9:  { title: "SQL Injection",      baseScore: 20, wrongPenalty: 5, hintPenalty: 4, difficulty: "Level 3", diffEmoji: "ğŸ”´", skillArea: "Databases", difficultyKey: "hard", isDark: false },
  room10: { title: "BOSS: The Wiper",    baseScore: 30, wrongPenalty: 5, hintPenalty: 0, difficulty: "BOSS",   diffEmoji: "â˜ ï¸", skillArea: "Mixed",      difficultyKey: "hard", isDark: false } 
};
const totalRooms = Object.keys(roomConfig).length;
const roomObjectives = {
  room1: "Î£Ï„ÏŒÏ‡Î¿Ï‚: Î•ÎºÏ„Î­Î»ÎµÏƒÎµ Ï„Î·Î½ ÎµÎ½Ï„Î¿Î»Î® Ï€Î¿Ï… ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÎ¹ \"Hello\" ÏƒÏ„Î¿ Ï„ÎµÏÎ¼Î±Ï„Î¹ÎºÏŒ.",
  room2: "Î£Ï„ÏŒÏ‡Î¿Ï‚: Î•Ï€Î±Î½Î±Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎµ Ï„Î± Ï€ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î± ÏƒÏ„Î¿Ï…Ï‚ ÏƒÏ‰ÏƒÏ„Î¿ÏÏ‚ Î¿ÏÎ¹ÏƒÎ¼Î¿ÏÏ‚.",
  room3: "Î£Ï„ÏŒÏ‡Î¿Ï‚: Î¡ÏÎ¸Î¼Î¹ÏƒÎµ Ï„Î± bits ÏÏƒÏ„Îµ Î½Î± Ï€Î±ÏÎ±Ï‡Î¸ÎµÎ¯ Î· Ï„Î¹Î¼Î® 75.",
  room4: "Î£Ï„ÏŒÏ‡Î¿Ï‚: Î Î±ÏÎ¬ÎºÎ±Î¼ÏˆÎ· Firewall (Port) ÎºÎ±Î¹ ÎµÏ€Î¹Î»Î¿Î³Î® ÏƒÏ‰ÏƒÏ„Î¿Ï ÎµÎ¾Î±ÏÏ„Î®Î¼Î±Ï„Î¿Ï‚ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚.",
  room5: "Î£Ï„ÏŒÏ‡Î¿Ï‚: Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® ÎºÏ‰Î´Î¹ÎºÎ¿Ï ÎµÏ€Î±Î»Î®Î¸ÎµÏ…ÏƒÎ·Ï‚.",
  room6: "Î£Ï„ÏŒÏ‡Î¿Ï‚: Î‘Î½Î±Î´Î¹Î¬Ï„Î±Î¾Îµ Ï„Î¹Ï‚ ÎµÎ½Ï„Î¿Î»Î­Ï‚ ÏƒÏ„Î· ÏƒÏ‰ÏƒÏ„Î® ÏƒÎµÎ¹ÏÎ¬ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚.",
  room7: "Î£Ï„ÏŒÏ‡Î¿Ï‚: Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ Ï„Î·Î½ Î­Î¾Î¿Î´Î¿ Ï„Î·Ï‚ ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ·Ï‚ Î¼Îµ step=2.",
  room8: "Î£Ï„ÏŒÏ‡Î¿Ï‚: Î•Î½Ï„ÏŒÏ€Î¹ÏƒÎµ Ï„Î¿ ÏƒÏ…Î½Ï„Î±ÎºÏ„Î¹ÎºÏŒ ÏƒÏ†Î¬Î»Î¼Î± (ÎºÎ»Î¹Îº ÏƒÏ„Î¿ Î»Î¬Î¸Î¿Ï‚ ÏƒÏÎ¼Î²Î¿Î»Î¿).",
  room9: "Î£Ï„ÏŒÏ‡Î¿Ï‚: Î•ÎºÏ„Î­Î»ÎµÏƒÎµ ÏƒÏ‰ÏƒÏ„Î® ÎµÎ½Ï„Î¿Î»Î® Î±Î½Î¬ÎºÏ„Î·ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.",
  room10: "Î£Ï„ÏŒÏ‡Î¿Ï‚: Î‘Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ· Î±Ï€ÎµÎ¹Î»Î®Ï‚ â†’ Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î¬Î¼Ï…Î½Î±Ï‚ â†’ Î‘ÏƒÏ†Î±Î»Î®Ï‚ Î¼ÎµÏ„Î¬Î´Î¿ÏƒÎ·."
};

let MAX_SCORE = 0;
for (let id in roomConfig) MAX_SCORE += roomConfig[id].baseScore;

let lastScreen = "intro";
let score = 150; // Score starts at 150, penalties subtract from it
let roomItemsFound = {};
let inventory = [];
let solvedRooms = {};
let perRoomScore = {};
let attempts = {};
let hintsUsed = {};
let roomVisited = {};
let roomTime = {};
let currentRoomId = null;
let roomEnterTime = null;
let keysCollected = { easy: 0, medium: 0, hard: 0 };
let keyEarnedInRoom = {};
let virusInterval = null;
let bossIntroShown = false; // one-time Room 10 intro cinematic
let hintMildShown = {};     // tiered hints: room3, room8
let room10IntelCollected = false;
let unreadChatMessages = 0;  // counter for unread chat messages (robot indicator)

// NEW: Global flag for terminal init
let termInit = false;

/* SPECIAL FLAGS FOR ROOM 1 */
let room1Clues = { port: false, manual: false };

/* PLAYER PROFILE */
let playerProfile = { name: "", avatar: "hacker", pre: { python: null, networks: null, security: null } };
let sessionStartTime = null;
let sessionEndTime = null;

/* AUDIO */
let muteSounds = false;
let muteSpeech = false;
let fontScale = 1.0;
let audioUnlocked = false;

let correctSound = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
let wrongSound   = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
let clickSound   = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");
let unlockSound  = new Audio("https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg");
let doorSound    = new Audio("https://actions.google.com/sounds/v1/doors/door_creaks.ogg");
let applauseSound = new Audio("https://actions.google.com/sounds/v1/crowds/battle_crowd_celebrate.ogg");
let bgMusic      = new Audio("https://actions.google.com/sounds/v1/ambiences/busy_city.ogg");
bgMusic.loop = true; bgMusic.volume = 0.3;

/* BGM: Ï„Î¿Ï€Î¹ÎºÎ¬ MP3 Î±Ï€ÏŒ Ï†Î¬ÎºÎµÎ»Î¿ sounds */
const BGM_TRACKS = {
  room1: "sounds/tech.mp3",   room6: "sounds/tech.mp3",   room7: "sounds/tech.mp3",   room8: "sounds/tech.mp3",   room9: "sounds/tech.mp3",
  room4: "sounds/drone.mp3",
  room10: "sounds/action.mp3",
  room2: "sounds/mystery.mp3", room3: "sounds/mystery.mp3", room5: "sounds/mystery.mp3"
};
let bgMusicPlayer = new Audio("sounds/mystery.mp3");
bgMusicPlayer.loop = true;
bgMusicPlayer.volume = 0.22;
let currentBGM = null;
let victoryMusic = new Audio("sounds/victory.mp3");
victoryMusic.volume = 0.5;

function playBGMForScreen(screenId) {
  if (!gameStarted) { stopBGM(); return; }
  if (muteSounds) { try { bgMusicPlayer.pause(); } catch(e) {} currentBGM = null; return; }
  let src = screenId && screenId.startsWith("room") ? (BGM_TRACKS[screenId] || "sounds/mystery.mp3") : "sounds/mystery.mp3";
  if (currentBGM === src) return;
  currentBGM = src;
  try {
    bgMusicPlayer.pause();
    bgMusicPlayer.currentTime = 0;
    bgMusicPlayer.src = src;
    bgMusicPlayer.loop = true;
    bgMusicPlayer.volume = 0.22;
    bgMusicPlayer.play().catch(function(){});
  } catch(e) {}
}
function stopBGM() {
  currentBGM = null;
  try { bgMusicPlayer.pause(); bgMusicPlayer.currentTime = 0; } catch(e) {}
}

let shortCircuitSound = new Audio("https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_short.ogg");
let digitalClickSound = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");
let lockClickSound    = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
let victorySound      = new Audio("https://actions.google.com/sounds/v1/crowds/battle_crowd_celebrate.ogg");
let ambientLoopSound  = new Audio("https://actions.google.com/sounds/v1/ambiences/city_park_ambience.ogg");
let mysteriousSound   = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
let codeRunSound      = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");
ambientLoopSound.loop = true;
ambientLoopSound.volume = 0.15;
victorySound.volume = 0.6;
applauseSound.volume = 0.5;
mysteriousSound.volume = 0.35;
codeRunSound.volume = 0.4;

const allGameSounds = [correctSound, wrongSound, clickSound, unlockSound, doorSound, applauseSound, shortCircuitSound, digitalClickSound, lockClickSound, victorySound, mysteriousSound, codeRunSound];

/** Unlock audio so sounds can play later (browsers block until user gesture). Call on START or Test sound click. */
function unlockAllAudio() {
  if (audioUnlocked) return;
  audioUnlocked = true;
  allGameSounds.forEach(function(a) {
    try {
      a.volume = 0.01;
      a.play().then(function() { a.pause(); a.currentTime = 0; }).catch(function(){});
    } catch(e) {}
  });
  try { bgMusic.volume = 0.01; bgMusic.play().then(function() { bgMusic.pause(); bgMusic.currentTime = 0; }).catch(function(){}); } catch(e) {};
  try { ambientLoopSound.volume = 0.01; ambientLoopSound.play().then(function() { ambientLoopSound.pause(); ambientLoopSound.currentTime = 0; }).catch(function(){}); } catch(e) {};
  try { bgMusicPlayer.volume = 0.01; bgMusicPlayer.play().then(function() { bgMusicPlayer.pause(); bgMusicPlayer.currentTime = 0; }).catch(function(){}); } catch(e) {};
  // Restore volumes (so later plays are audible)
  bgMusic.volume = 0.3;
  ambientLoopSound.volume = 0.15;
  bgMusicPlayer.volume = 0.22;
  correctSound.volume = 1;
  wrongSound.volume = 1;
  clickSound.volume = 1;
  unlockSound.volume = 1;
  doorSound.volume = 1;
  applauseSound.volume = 0.5;
  shortCircuitSound.volume = 1;
  digitalClickSound.volume = 1;
  lockClickSound.volume = 1;
  victorySound.volume = 0.6;
  mysteriousSound.volume = 0.35;
  codeRunSound.volume = 0.4;
}

/** Test sound: unlock and play so user can verify. */
function testSound() {
  unlockAllAudio();
  if (muteSounds) { alert("ÎÎµÎ¼Ï€Î»Î¿ÎºÎ¬ÏÎµÏ„Îµ Ï€ÏÏÏ„Î± Ï„Î· Â«Î£Î¯Î³Î±ÏƒÎ· Î®Ï‡Ï‰Î½ & Î¼Î¿Ï…ÏƒÎ¹ÎºÎ®Ï‚Â» Î³Î¹Î± Î½Î± Î±ÎºÎ¿ÏÏƒÎµÏ„Îµ Î®Ï‡Î¿."); return; }
  try { wrongSound.currentTime = 0; wrongSound.volume = 0.5; wrongSound.play().catch(function(){ alert("Î”ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎµ Î½Î± Ï€Î±Î¯Î¾ÎµÎ¹ Î¿ Î®Ï‡Î¿Ï‚. Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¬Î»Î»Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Ï€ÎµÏÎ¹Î®Î³Î·ÏƒÎ·Ï‚ Î® ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î¿ volume. Î£Îµ Î±Î½Î¿Î¯Î³Î¼Î± Ï‰Ï‚ file:// Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Live Server Î® Ï†Î¹Î»Î¿Î¾ÎµÎ½Î¯Î±."); }); } catch(e) { alert("Î£Ï†Î¬Î»Î¼Î± Î®Ï‡Î¿Ï…: " + e); }
}

/** Unlock audio on first click anywhere (Chrome/Windows often needs user gesture). */
var audioUnlockOnce = false;
function tryUnlockAudioOnFirstClick() {
  if (audioUnlockOnce) return;
  audioUnlockOnce = true;
  unlockAllAudio();
  document.removeEventListener("click", tryUnlockAudioOnFirstClick);
  document.removeEventListener("keydown", tryUnlockAudioOnFirstClick);
}
document.addEventListener("click", tryUnlockAudioOnFirstClick, { once: true, passive: true });
document.addEventListener("keydown", tryUnlockAudioOnFirstClick, { once: true, passive: true });

const sfxMap = { success: correctSound, wrong: wrongSound, shortCircuit: shortCircuitSound, digitalClick: digitalClickSound, lockClick: lockClickSound, door: doorSound, victory: victorySound };
function playSfx(name) {
  if (muteSounds) return;
  const s = sfxMap[name] || (name === "unlock" ? unlockSound : null);
  if (!s) return;
  try { s.pause(); s.currentTime = 0; s.play().catch(()=>{}); } catch(e) {}
}

/* TIMER & INTEGRITY */
let timeLeft = 900;
let timerInterval = null;
let gameStarted = false;
let integrity = 100;

/* ENGAGEMENT METRICS */
let chatInteractions = 0;
let minigameAttempts = 0;
let combineAttempts = 0;
let idleTimer = null;

/* ---------- HELPERS ---------- */

function triggerGlitch() {
  document.body.classList.add('glitch-active');
  setTimeout(() => document.body.classList.remove('glitch-active'), 400);
}

function cinematic(title, text, ms=1200){
  const box = document.getElementById("cinematic");
  const t = document.getElementById("cinematic-title");
  const p = document.getElementById("cinematic-text");
  if(!box || !t || !p) return;
  t.innerText = title;
  p.innerText = text;
  box.style.display = "block";
  setTimeout(()=> box.style.display="none", ms);
}
function deny(message){
  triggerGlitch();
  if (!muteSounds) { wrongSound.currentTime = 0; wrongSound.play().catch(()=>{}); }
  document.getElementById('clue-title').innerText = "ACCESS DENIED";
  document.getElementById('clue-title').style.color = "red";
  document.getElementById('clue-message').innerText = message;
  document.getElementById('clue-popup').style.display = 'block';
  addChatMessage("Operator", message, "operator");
  logAction("DENY", currentRoomId, message);
}

function resetStructures() {
  solvedRooms = {}; perRoomScore = {}; attempts = {}; hintsUsed = {};
  roomVisited = {}; roomTime = {}; keyEarnedInRoom = {};
  keysCollected = { easy: 0, medium: 0, hard: 0 };
  roomItemsFound = {}; inventory = [];
  room1Clues = { port: false, manual: false };
  integrity = 100;
  score = 150; // Score starts at 150
  actionLog = [];
  clearInterval(virusInterval);
  termInit = false; // Reset terminal flag

  for (let id in roomConfig) {
    roomItemsFound[id] = false;
    solvedRooms[id] = false;
    perRoomScore[id] = roomConfig[id].baseScore;
    attempts[id] = 0;
    hintsUsed[id] = 0;
    roomVisited[id] = false;
    roomTime[id] = 0;
    keyEarnedInRoom[id] = false;
  }

  updateKeysHud();
  updateInventoryUI();
  updateIntegrityUI();
  const scoreEl = document.getElementById("score-value");
  if (scoreEl) scoreEl.innerText = Math.max(0, score);
  updateHUD('intro');

  chatInteractions = 0;
  minigameAttempts = 0;
  combineAttempts = 0;
  hintMildShown = {};
  room10IntelCollected = false;
  bossIntroShown = false;
  unreadChatMessages = 0;
  const chat = document.getElementById('chatbot-container');
  const robotBtn = document.getElementById('robot-operator-btn');
  if (chat) chat.style.display = 'none';
  if (robotBtn) {
    robotBtn.classList.remove('has-messages');
    robotBtn.title = 'ğŸ¤– The Operator';
  }
  const inp9 = document.getElementById("input-sql-room9");
  if (inp9) { inp9.value = ""; inp9.placeholder = "ÎµÎ½Ï„Î¿Î»Î®..."; }

  const inp = document.getElementById("input-port-room4");
  const btn = document.getElementById("btn-port-room4");
  if(inp && btn) { inp.disabled = true; btn.disabled = true; }

  const need8 = document.getElementById("room8-need-debugger");
  const code8 = document.getElementById("room8-code-area");
  if (need8 && code8) { need8.style.display = "block"; code8.style.display = "none"; }
  
  document.body.classList.remove('panic-mode'); // ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÎºÏŒÎºÎºÎ¹Î½Î·Ï‚ Î¿Î¸ÏŒÎ½Î·Ï‚ ÏƒÏ„Î¿ Restart
}

resetStructures();

/* INTEGRITY WITH PANIC MODE */
function updateIntegrityUI() {
  const bar = document.getElementById('integrity-bar');
  if(!bar) return;
  bar.style.width = integrity + "%";
  
  // LOGIC FIX: Î•Î´Ï ÎµÎ»Î­Î³Ï‡Î¿Ï…Î¼Îµ Ï„Î¿ Panic Mode
  if(integrity < 30) {
      bar.style.background = "red";
      document.body.classList.add('panic-mode'); // Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÎºÏŒÎºÎºÎ¹Î½Î·Ï‚ Î¿Î¸ÏŒÎ½Î·Ï‚
  } else {
      document.body.classList.remove('panic-mode'); // Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·
      if(integrity < 60) bar.style.background = "yellow";
      else bar.style.background = "lightgreen";
  }
}
function damageIntegrity(amount) {
  integrity = Math.max(0, integrity - amount);
  updateIntegrityUI();
  document.body.style.transform = "translateX(5px)";
  setTimeout(()=> document.body.style.transform = "translateX(-5px)", 50);
  setTimeout(()=> document.body.style.transform = "none", 100);
}

/* GAMEPLAY */
function normalizeClueText(text) {
  if (!text || typeof text !== 'string') return text;
  let t = text.trim();
  t = t.replace(/Log Fragment A: /g, "Î˜ÏÎ±ÏÏƒÎ¼Î± Î‘: ").replace(/Cipher Fragment B: /g, "Î˜ÏÎ±ÏÏƒÎ¼Î± Î’: ").replace(/Schema Fragment C: /g, "Î˜ÏÎ±ÏÏƒÎ¼Î± Î“: ");
  const prefixes = ["Post-It: ", "Python Manual: ", "Manual Î”Î¹ÎºÏ„ÏÎ¿Ï…: ", "ASCII Chart: ", "Note: ", "Hint: ", "Robot: ", "Log Fragment A: ", "Cipher Fragment B: ", "Î˜ÎµÏÎ¼ÏŒÎ¼ÎµÏ„ÏÎ¿: ", "SQL Manual: ", "Schema Fragment C: ", "Intel: ", "Debugger Tool (USB stick): "];
  for (const p of prefixes) { if (t.startsWith(p)) { t = t.slice(p.length).trim(); break; } }
  return t || text;
}

function pickupItem(roomId, icon, text, element, hiddenSecret=null) {
  if (roomId === 'room1') {
    if (text.includes("Port")) {
      if (room1Clues.port) return;
      room1Clues.port = true;
    } else if (text.includes("Manual")) {
      if (room1Clues.manual) return;
      room1Clues.manual = true;
    }
  }
  if (roomId === 'room10' && text.includes('Intel')) room10IntelCollected = true;

  inventory.push({ icon, text, roomId, secret: hiddenSecret });
  logAction("PICKUP", roomId, text);

  const displayText = normalizeClueText(text);
  document.getElementById('clue-title').innerText = "Î£Î¤ÎŸÎ™Î§Î•Î™ÎŸ ÎšÎ‘Î¤Î‘Î“Î¡Î‘Î¦Î—ÎšÎ•";
  document.getElementById('clue-title').style.color = "#33ff33";
  document.getElementById('clue-message').innerHTML = displayText + "<br><br><i>(Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Toolkit)</i>";
  document.getElementById('clue-popup').style.display = 'block';

  const btn = document.getElementById('backpack-btn');
  btn.classList.add('backpack-wiggle');
  setTimeout(()=> btn.classList.remove('backpack-wiggle'), 500);

  updateInventoryUI();

  addChatMessage("System", `New Asset: ${displayText.substring(0, 40)}${displayText.length > 40 ? '...' : ''}`, "system");

  const lock = document.querySelector(`#lock-${roomId}`);
  if(lock) lock.classList.add('pulse-active');

  playSfx("digitalClick");
  if (element) element.style.display = 'none';

  if (roomId === 'room10' && text.includes('Intel')) {
    const storyEl = document.getElementById("story-room10");
    if (storyEl) storyEl.innerHTML = "ÎŸ Wiper Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚. Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ Ï€ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î¿ Î±Î½Ï„Î¹Î¼ÎµÏ„ÏÏ€Î¹ÏƒÎ·Ï‚ Î±Ï€ÎµÎ¹Î»Î®Ï‚.<br><span style=\"color:#ffd700; font-size:0.9em;\">ğŸ’¡ Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î³Î¹Î± Ï„Î¿ Ï„ÎµÎ»Î¹ÎºÏŒ ÏƒÏ„Î¬Î´Î¹Î¿.</span>";
    addChatMessage("Operator", "Intel ÏƒÏ…Î»Î»Î­Ï‡Ï„Î·ÎºÎµ. Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ ÏŒÏ„Î±Î½ ÎµÎ¯ÏƒÎ±Î¹ Î­Ï„Î¿Î¹Î¼Î¿Ï‚.", "operator");
  }
}

function examine(text, icon) {
  if(!muteSounds) clickSound.play().catch(()=>{});
  document.getElementById('clue-title').innerText = "Î“Î¡Î—Î“ÎŸÎ¡Î— Î£Î‘Î¡Î©Î£Î—";
  document.getElementById('clue-title').style.color = "#33ff33";
  document.getElementById('clue-message').innerText = text;
  document.getElementById('clue-popup').style.display = 'block';
  logAction("EXAMINE", currentRoomId, text);
}
function closeCluePopup() { document.getElementById('clue-popup').style.display = 'none'; }

function showDeepScan(msg) {
  document.getElementById('clue-title').innerText = "DEEP SCAN";
  document.getElementById('clue-title').style.color = "#33ff33";
  document.getElementById('clue-message').innerText = msg;
  document.getElementById('clue-popup').style.display = 'block';
}

function toggleBackpack() {
  const modal = document.getElementById('backpack-modal');
  modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
}

// INSPECT ITEM LOGIC
let currentInspectItem = null;
function inspectItem(index) {
    currentInspectItem = inventory[index];
    const modal = document.getElementById('inspect-modal');
    document.getElementById('inspect-icon').innerText = currentInspectItem.icon;
    document.getElementById('inspect-title').innerText = "Asset #" + (index+1);
    document.getElementById('inspect-desc').innerText = normalizeClueText(currentInspectItem.text);
    document.getElementById('inspect-secret-area').style.display = 'none';
    modal.style.display = 'block';
}

function revealSecret() {
    const area = document.getElementById('inspect-secret-area');
    if(currentInspectItem && currentInspectItem.secret) {
        area.style.display = 'block';
        area.innerHTML = "<b>HIDDEN DATA DECRYPTED:</b><br>" + currentInspectItem.secret;
        playSfx("lockClick");
    } else {
        area.style.display = 'block';
        area.innerHTML = "No hidden data found.";
    }
}

function updateInventoryUI() {
  const list = document.getElementById('backpack-items-list');
  if(!list) return;
  if(inventory.length === 0) {
    list.innerHTML = '<span style="font-style:italic; font-size:12px; color:#aaa;">No assets found...</span>';
    return;
  }
  list.innerHTML = '';
  inventory.forEach((item, index) => {
    let div = document.createElement('div');
    div.className = 'bp-item';
    const displayText = normalizeClueText(item.text);
    div.innerText = item.icon;
    div.title = displayText;
    div.onclick = () => inspectItem(index); // Changed to Inspect
    list.appendChild(div);
  });
}

function getCollectedCountForRoom(rId) {
    return inventory.filter(i => i.roomId === rId).length;
}

function attemptUnlock(roomId, element) {
  let canUnlock = false;

  // -- ROOM 1 LOGIC --
  if (roomId === 'room1') {
    if (room1Clues.port && room1Clues.manual) {
      canUnlock = true;
    } else {
      deny("Î›ÎµÎ¯Ï€Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±: Î‘Ï€Î±Î¹Ï„Î¿ÏÎ½Ï„Î±Î¹ Ï„Î¿ Manual ÎšÎ‘Î™ Ï„Î¿ Port Number.");
      return;
    }
  }

  // -- ROOM 2 & 3 LOGIC (2/2 ITEMS FOR UNLOCK - ESCAPE ROOM SEARCH) --
  else if (roomId === 'room2') {
    if (getCollectedCountForRoom('room2') >= 2) canUnlock = true;
    else {
      deny("Î›ÎµÎ¯Ï€Î¿Ï…Î½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±! Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î²ÏÎµÎ¹Ï‚ ÎºÎ±Î¹ Ï„Î± 2 Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î± ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿ (Manual & Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·) Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÎ¹Ï‚.");
      return;
    }
  }
  else if (roomId === 'room3') {
    if (getCollectedCountForRoom('room3') >= 2) canUnlock = true;
    else {
      deny("Î›ÎµÎ¯Ï€Î¿Ï…Î½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±! Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î²ÏÎµÎ¹Ï‚ ÎºÎ±Î¹ Ï„Î± 2 Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î± ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿ (ASCII Chart & Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·) Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÎ¹Ï‚.");
      return;
    }
  }

  // -- ROOM 7 & 8 LOGIC (STRICT ITEM COUNT) --
  else if (roomId === 'room7') {
      if (getCollectedCountForRoom('room7') >= 2) canUnlock = true;
      else {
          deny("Î›ÎµÎ¯Ï€Î¿Ï…Î½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±! Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î²ÏÎµÎ¹Ï‚ ÎºÎ±Î¹ Ï„Î± 2 Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î± (Robot & Fragment) Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÎ¹Ï‚.");
          return;
      }
  }
  else if (roomId === 'room8') {
      if (getCollectedCountForRoom('room8') >= 2) canUnlock = true;
      else {
          deny("Î›ÎµÎ¯Ï€Î¿Ï…Î½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±! Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î²ÏÎµÎ¹Ï‚ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 2 Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î± (Î˜ÎµÏÎ¼ÏŒÎ¼ÎµÏ„ÏÎ¿, Fragment Î® Debugger) Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÎ¹Ï‚.");
          return;
      }
  }

  // -- ROOM 9 LOGIC (NEEDS MASTER KEY) --
  else if (roomId === 'room9') {
    const hasMasterKey = inventory.some(i => i.text.includes("SQL MASTER KEY"));
    if (!hasMasterKey) {
      deny("Î¤Î¿ Node 9 Î±Ï€Î±Î¹Ï„ÎµÎ¯ SQL MASTER KEY. Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î²ÏÎµÎ¹Ï‚ Ï„Î± Fragments ÏƒÏ„Î± Room 7, 8 ÎºÎ±Î¹ 9 ÎºÎ±Î¹ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚ Combine.");
      return;
    }
    canUnlock = true;
  }

  // -- GENERIC LOGIC FOR OTHER ROOMS --
  else {
    canUnlock = inventory.some(i => i.roomId === roomId);
  }

  if (roomId === 'room10' && canUnlock && !room10IntelCollected) {
    deny("Î’ÏÎµÏ‚ Ï€ÏÏÏ„Î± Ï„Î¿ Intel ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿ Ï€ÏÎ¹Î½ Î¾ÎµÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÎ¹Ï‚.");
    return;
  }

  if (canUnlock) {
    playSfx("lockClick");
    if(element) element.classList.remove('pulse-active');
    
    // LIGHTS ON
    if (roomConfig[roomId] && roomConfig[roomId].isDark) {
        document.getElementById('darkness-overlay').style.display = 'none';
    }
    
    // VIRUS STORM
    if(roomId === 'room10') {
        startVirusStorm();
    }

    const qblock = document.getElementById("qblock-" + roomId);
    if(qblock) {
      qblock.style.display = "block";
      if (roomId === "room8") {
        const hasDbg = inventory.some(i => i.text && i.text.includes("Debugger Tool"));
        const needEl = document.getElementById("room8-need-debugger");
        const codeEl = document.getElementById("room8-code-area");
        if (needEl && codeEl) {
          if (hasDbg) { needEl.style.display = "none"; codeEl.style.display = "block"; }
          else { needEl.style.display = "block"; codeEl.style.display = "none"; }
        }
      }
      // Room 4: Show note only when puzzle is unlocked
      if (roomId === "room4") {
        const note = document.getElementById("note-room4");
        if (note) note.style.display = "block";
        // Port input remains disabled until combine is done
      }
      // Room 7: Show simulator only when puzzle is unlocked
      if (roomId === "room7") {
        const simulator = document.getElementById("simulator-room7");
        if (simulator) simulator.style.display = "block";
      }
      var objEl = document.getElementById("obj-" + roomId);
      if (objEl && roomObjectives[roomId]) { objEl.textContent = roomObjectives[roomId]; objEl.style.display = "block"; }
      if(qblock.classList.contains("draggable-window")){
          qblock.style.top = "50%";
          qblock.style.left = "50%";
      } else {
          qblock.scrollIntoView({behavior: "smooth"});
      }

      // --- BOSS INTRO (ROOM 10) ---
      if (roomId === 'room10' && !bossIntroShown) {
          bossIntroShown = true;
          const storyR10 = document.getElementById("story-room10");
          if (storyR10) storyR10.innerHTML = "ÎŸ Wiper Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚.<br><span style=\"color:#ffd700; font-size:0.9em;\">ğŸ’¡ Î”ÏÎ¬ÏƒÎµ Î³ÏÎ®Î³Î¿ÏÎ± ÏƒÏ„Î± Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰.</span>";
          cinematic("âš ï¸ BOSS ONLINE", "ÎŸ Wiper Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ Upload. ÎšÏÎ¬Ï„Î± Ï„Î·Î½ ÏˆÏ…Ï‡ÏÎ±Î¹Î¼Î¯Î± ÏƒÎ¿Ï… ÎºÎ±Î¹ Î±Ï€Î¬Î½Ï„Î·ÏƒÎµ ÏƒÏ‰ÏƒÏ„Î¬ Î³Î¹Î± Î½Î± Ï„Î¿Î½ ÏƒÏ„Î±Î¼Î±Ï„Î®ÏƒÎµÎ¹Ï‚.", 1800);
          addChatMessage("Operator", "BOSS ALERT: ÎŸ Wiper ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ. Î”ÏÎ¬ÏƒÎµ Î³ÏÎ®Î³Î¿ÏÎ± ÏƒÏ„Î± Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰.", "operator");
          setTimeout(() => { if(!muteSpeech) speak("Î”ÏÎ¬ÏƒÎµ Î³ÏÎ®Î³Î¿ÏÎ± ÏƒÏ„Î± Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰."); }, 2000);
      }

      const layer = document.querySelector("#" + roomId + " .interaction-layer");
      if(layer && roomId !== 'room1') layer.style.display = "none";

      // --- ROOM 1: system message (no quiz wording) ---
      if (roomId === 'room1') {
          speak("Î ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î¿ ÎµÎºÎºÎ¯Î½Î·ÏƒÎ·Ï‚: Î³ÏÎ¬ÏˆÎµ Ï„Î·Î½ ÎµÎ½Ï„Î¿Î»Î® Ï€Î¿Ï… Î¸Î± ÎµÎ¼Ï†Î±Î½Î¯ÏƒÎµÎ¹ Ï„Î¿ Hello.");
      } else if (roomId !== 'room4') {
          repeatQuestion(roomId);
      }
    }
    logAction("UNLOCK_PUZZLE", roomId, "Success");
  } else {
    deny("ÎšÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î¿. ÎšÎ¬Î½Îµ Î­ÏÎµÏ…Î½Î± ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿ ÎºÎ±Î¹ Î¼Î¬Î¶ÎµÏˆÎµ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±.");
  }
}

function goToNextFrom(currentRoom, nextRoom) {
  const k = document.getElementById("giant-key-" + currentRoom);
  if(k) k.style.display = "none";
  playSfx("door");
  goTo(nextRoom);
}

/* UI */
function toggleSettings() {
  const p = document.getElementById("settingsPanel");
  if (!p) return;
  p.style.display = (p.style.display === "none" || !p.style.display) ? "block" : "none";
}

function toggleTeacherInfo() {
  const p = document.getElementById("teacherInfoPanel");
  if (!p) return;
  p.style.display = (p.style.display === "none" || !p.style.display) ? "block" : "none";
}

function toggleMuteSounds() {
  muteSounds = document.getElementById("muteSoundsCheckbox").checked;
  if(muteSounds) { try { bgMusic.pause(); ambientLoopSound.pause(); bgMusicPlayer.pause(); } catch(e) {} currentBGM = null; }
  else if(gameStarted) { playBGMForScreen(currentRoomId || lastScreen || "intro"); }
}
function toggleMuteSpeech() { muteSpeech = document.getElementById("muteSpeechCheckbox").checked; if(muteSpeech) speechSynthesis.cancel(); }
function changeFontSize(delta) {
  fontScale += delta;
  if(fontScale<0.8) fontScale=0.8;
  if(fontScale>1.4) fontScale=1.4;
  document.documentElement.style.fontSize = (fontScale*100)+"%";
}

/* HUD */
function updateHUD(screenId) {
  let icon = "ğŸ‘¤";
  if (playerProfile.avatar === "hacker") icon = "ğŸ’»";
  else if (playerProfile.avatar === "robot") icon = "ğŸ¤–";
  else if (playerProfile.avatar === "scientist") icon = "ğŸ›¡ï¸";

  document.getElementById("playerInfo").innerText = icon + " Agent: " + (playerProfile.name || "Unknown");
  let roomIndex = (screenId && screenId.startsWith("room")) ? screenId.replace("room","") : 0;
  document.getElementById("progress").innerText = (roomIndex > 0 && roomIndex <= totalRooms) ? "Î”Ï‰Î¼Î¬Ï„Î¹Î¿ " + roomIndex + "/" + totalRooms : "Standby";
  const scoreEl = document.getElementById("score-value");
  if (scoreEl) scoreEl.innerText = Math.max(0, score); // Score never goes below 0
  else document.getElementById("score").innerText = "â­ Î£ÎºÎ¿Ï: " + Math.max(0, score);

  const d = document.getElementById("difficultyIndicator");
  if(d) {
    if(screenId && screenId.startsWith("room")) {
      const cfg = roomConfig[screenId];
      d.innerText = `${cfg.diffEmoji} ${cfg.difficulty} â€¢ ${cfg.title}`;
    } else d.innerText = "";
  }
}
function updateKeysHud() {
  const el = document.getElementById("keysHud");
  if (!el) return;
  const parts = [];
  if (keysCollected.easy > 0) parts.push(`ğŸŸ¢ ${keysCollected.easy}`);
  if (keysCollected.medium > 0) parts.push(`ğŸŸ¡ ${keysCollected.medium}`);
  if (keysCollected.hard > 0) parts.push(`ğŸ”´ ${keysCollected.hard}`);
  el.innerText = parts.length ? `ğŸ”‘ ${parts.join("  ")}` : "ğŸ”‘";
}
function updateProgressMap(screenId) {
  initProgressMap();
  const isRoom = screenId && screenId.startsWith("room");
  for (let id in roomConfig) {
    const dot = document.getElementById("dot-" + id);
    if (!dot) continue;
    dot.classList.remove("room-dot-active");
    if (solvedRooms[id]) dot.classList.add("room-dot-solved");
    if (isRoom && id === screenId) dot.classList.add("room-dot-active");
  }
}
function initProgressMap() {
  const map = document.getElementById("progressMap");
  if(!map) return;
  if(map.children.length === 0) {
    for (let i = 1; i <= totalRooms; i++) {
      let dot = document.createElement("div");
      dot.className = "room-dot";
      dot.id = "dot-room" + i;
      map.appendChild(dot);
    }
  }
}

/* ---------- SPEECH HELPERS & PHONETICS (FINAL) ---------- */
function fixPhonetics(text) {
  let t = text || "";
  // Remove emoji/icons before speech synthesis
  t = t.replace(/[\u{1F300}-\u{1F9FF}]/gu, ''); // Emoji range
  t = t.replace(/[\u{2600}-\u{26FF}]/gu, ''); // Miscellaneous symbols
  t = t.replace(/[\u{2700}-\u{27BF}]/gu, ''); // Dingbats
  t = t.replace(/\s+/g, " ").trim();
  t = t.replace(/\b3\s*ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚\b/gi, "Ï„ÏÎµÎ¹Ï‚ ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚");
  // Fragment A/B/C â†’ Î´Î¹Î±Î²Î¬Î¶Î¿Î½Ï„Î±Î¹ ÎºÎ±Î¸Î±ÏÎ¬ Ï‰Ï‚ Î­Î¹, Î¼Ï€Î¹, ÏƒÎ¹
  t = t.replace(/\bFragment A\b/gi, "Î¸ÏÎ±ÏÏƒÎ¼Î± Î­Î¹");
  t = t.replace(/\bFragment B\b/gi, "Î¸ÏÎ±ÏÏƒÎ¼Î± Î¼Ï€Î¹");
  t = t.replace(/\bFragment C\b/gi, "Î¸ÏÎ±ÏÏƒÎ¼Î± ÏƒÎ¹");
  t = t.replace(/Î˜ÏÎ±ÏÏƒÎ¼Î± Î‘\b/g, "Î¸ÏÎ±ÏÏƒÎ¼Î± Î­Î¹");
  t = t.replace(/Î˜ÏÎ±ÏÏƒÎ¼Î± Î’\b/g, "Î¸ÏÎ±ÏÏƒÎ¼Î± Î¼Ï€Î¹");
  t = t.replace(/Î˜ÏÎ±ÏÏƒÎ¼Î± Î“\b/g, "Î¸ÏÎ±ÏÏƒÎ¼Î± ÏƒÎ¹");
  
  const rep = [
    [/\bback\s*up\b/gi, "Î¼Ï€Î±Îº Î±Ï€"], 
    [/\bbackup\b/gi, "Î¼Ï€Î±Îº Î±Ï€"],
    [/\bfragment\b/gi, "Ï†ÏÎ¬Î³ÎºÎ¼ÎµÎ½Ï„"],
    [/\bfragments\b/gi, "Ï†ÏÎ¬Î³ÎºÎ¼ÎµÎ½Ï„Ï‚"],
    [/\bpasswords?\b/gi, "Ï€Î¬ÏƒÎ³Î¿Ï…Î¿ÏÎ½Ï„"], 
    [/\bfirewall\b/gi, "Ï†Î¬Î¹ÏÎ³Î¿Ï…Î¿Î»"],
    [/\bserver\b/gi, "ÏƒÎ­ÏÎ²ÎµÏ"], 
    [/\bterminal\b/gi, "Ï„Î­ÏÎ¼Î¹Î½Î±Î»"],
    [/\btoolkit\b/gi, "Ï„Î¿ÏÎ»ÎºÎ¹Ï„"], 
    [/\bcombine\b/gi, "ÎºÎ¿Î¼Ï€Î¬Î¹Î½"],
    [/\bport\b/gi, "Ï€ÏŒÏÏ„"], 
    [/\bnode\b/gi, "Î½ÏŒÎ¿Ï…Î½Ï„"],
    [/\bphishing\b/gi, "Ï†Î¯ÏƒÎ¹Î½Î³Îº"], 
    [/\bsql\b/gi, "ÎµÏ‚ ÎºÎ¹Î¿Ï… ÎµÎ»"],
    [/\bselect\b/gi, "ÏƒÎµÎ»Î­ÎºÏ„"], 
    [/\bhttps\b/gi, "Î­Î¹Ï„Ï‚ Ï„Î¹ Ï„Î¹ Ï€Î¹ ÎµÏ‚"],
    [/\bhttp\b/gi, "Î­Î¹Ï„Ï‚ Ï„Î¹ Ï„Î¹ Ï€Î¹"], 
    [/\bpython\b/gi, "Ï€Î¬Î¹Î¸Î¿Î½"],
    [/\bhdd\b/gi, "Î­Î¹Ï„Ï‚ Î½Ï„Î¹ Î½Ï„Î¹"], 
    [/\bssd\b/gi, "ÎµÏ‚ ÎµÏ‚ Î½Ï„Î¹"],
    [/\btotal\b/gi, "Ï„ÏŒÏ„Î±Î»"], 
    [/\bdecrypt\b/gi, "Î½Ï„Î¹ÎºÏÎ¯Ï€Ï„"],
    [/\bprint\b/gi, "Ï€ÏÎ¯Î½Ï„"], 
    [/\bloop\b/gi, "Î»Î¿ÏÏ€"],
    [/\brange\b/gi, "ÏÎ­Î¹Î½Ï„Î¶"], 
    [/\bif\b/gi, "Î¯Ï†"],
    [/\belse\b/gi, "Î­Î»Ï‚"], 
    [/\bhardware\b/gi, "Ï‡Î¬ÏÎ½Ï„Î³Î¿Ï…ÎµÏ"],
    [/\bsoftware\b/gi, "ÏƒÏŒÏ†Ï„Î³Î¿Ï…ÎµÏ"], 
    [/\bvirus\b/gi, "Î²Î¬Î¹ÏÎ¿Ï…Ï‚"],
    [/\bantivirus\b/gi, "Î±Î½Ï„Î¹Î²Î¬Î¹ÏÎ¿Ï…Ï‚"], 
    [/\bwiper\b/gi, "Î³Î¿Ï…Î¬Î¹Ï€ÎµÏ"], 
    [/\boperator\b/gi, "ÏŒÏ€ÎµÏÎµÏŠÏ„Î¿Ï"],
    [/\baccess\b/gi, "Î¬Î¾ÎµÏ‚"], 
    [/\bdenied\b/gi, "Î½Ï„Î¹Î½Î¬Î¹Î½Ï„"],
    [/\bsystem\b/gi, "ÏƒÎ¯ÏƒÏ„ÎµÎ¼"], 
    [/\bintegrity\b/gi, "Î¹Î½Ï„Î­Î³ÎºÏÎ¹Ï„Î¹"],
    [/\bloading\b/gi, "Î»ÏŒÎ¿Ï…Î½Ï„Î¹Î½Î³Îº"], 
    [/\berror\b/gi, "Î­ÏÏÎ¿Ï"],
    [/\bsuccess\b/gi, "ÏƒÎ±Î¾Î­Ï‚"], 
    [/\binsert\b/gi, "Î¹Î½ÏƒÎ­ÏÏ„"],
    [/\bupdate\b/gi, "Î±Ï€Î½Ï„Î­Î¹Ï„"], 
    [/\bascii\b/gi, "Î¬ÏƒÎºÎ¹"],
    [/\blogs\b/gi, "Î»Î¿Î³Ï‚"],
    [/\blog\b/gi, "Î»Î¿Î³"],
    [/\badmin\b/gi, "Î±Î½Ï„Î¼Î¹Î½"]
  ];
  rep.forEach(([r, v]) => t = t.replace(r, v));
  t = t.replace(/\bthe wiper\b/gi, "Î´Îµ Î³Î¿Ï…Î¬Î¹Ï€ÎµÏ");
  return t;
}

function speak(text) {
  if (muteSpeech) return;
  if (!text) return;
  if (speechSynthesis.speaking) speechSynthesis.cancel();
  const safeText = fixPhonetics(text);
  const u = new SpeechSynthesisUtterance(safeText);
  u.lang = "el-GR";
  speechSynthesis.speak(u);
}
function speakLoss(reason, points) {
  if (muteSpeech) return;
  if (!points || points <= 0) return;
  let word = (points === 1 ? "Ï€ÏŒÎ½Ï„Î¿" : "Ï€ÏŒÎ½Ï„Î¿Ï…Ï‚");
  let prefix = "";
  if (reason === "wrong") prefix = "Î›Î¬Î¸Î¿Ï‚ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·. ";
  else if (reason === "hint") prefix = "Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµÏ‚ Ï…Ï€ÏŒÎ´ÎµÎ¹Î¾Î·. ";
  speak(prefix + "ÎˆÏ‡Î±ÏƒÎµÏ‚ " + points + " " + word + ".");
}

/* SCORE - max 3 wrong penalties per room so repeated same wrong answer doesn't zero out */
const MAX_WRONG_PENALTIES_PER_ROOM = 3;
function applyWrongPenalty(roomId) {
  if (solvedRooms[roomId]) return;
  const wrongCount = attempts[roomId] || 0;
  if (wrongCount > MAX_WRONG_PENALTIES_PER_ROOM) return; /* no further score/integrity deduction */
  const p = roomConfig[roomId].wrongPenalty;
  perRoomScore[roomId] = Math.max(0, perRoomScore[roomId] - p);
  score = Math.max(0, score - p);
  damageIntegrity(5);
  updateHUD(roomId);
  speakLoss("wrong", p);
  triggerGlitch();
  if (!muteSounds) { wrongSound.currentTime = 0; wrongSound.play().catch(()=>{}); }
  logAction("WRONG_ANSWER", roomId, `Penalty: -${p}`);
}

function showHint(roomId) {
  // Tiered hints: room3, room8 â€” first click = mild (no penalty), second = strong (penalty)
  if ((roomId === 'room3' || roomId === 'room8') && !hintMildShown[roomId]) {
    let mild = "";
    if (roomId === 'room3') mild = "ÎŸ ÏƒÏ„ÏŒÏ‡Î¿Ï‚ ÎµÎ¯Î½Î±Î¹ Î­Î½Î±Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚. Î£ÎºÎ­ÏˆÎ¿Ï… Ï€ÏÏ‚ Ï„Î± 0 ÎºÎ±Î¹ 1 ÏƒÎµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ­Ï‚ Î¸Î­ÏƒÎµÎ¹Ï‚ ÏƒÏ‡Î·Î¼Î±Ï„Î¯Î¶Î¿Ï…Î½ Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚.";
    if (roomId === 'room8') mild = "Î£Ï„Î¿ if, Î³Î¹Î± Î½Î± ÎµÎ»Î­Î³Î¾ÎµÎ¹Ï‚ Î¹ÏƒÏŒÏ„Î·Ï„Î± Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Î´ÏÎ¿ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚â€”Ï„Î¿ Î­Î½Î± Î¼ÏŒÎ½Î¿ ÎºÎ¬Î½ÎµÎ¹ ÎºÎ¬Ï„Î¹ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÏŒ.";
    hintMildShown[roomId] = true;
    let el = document.getElementById("hint-" + roomId);
    if (el) el.innerText = "ğŸ’¡ " + mild + " (Ï€ÏÏÏ„Î· Ï…Ï€ÏŒÎ´ÎµÎ¹Î¾Î·, Ï‡Ï‰ÏÎ¯Ï‚ penalty)";
    addChatMessage("Operator", "Hint: " + mild, "operator");
    return;
  }

  let text = "";
  if(roomId==='room1') text = "Î£Ï„Î¿ Python Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏƒÎ±Î¹ Ï„Î·Î½ ÎµÎ½Ï„Î¿Î»Î® Ï€Î¿Ï… ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÎ¹ ÎºÎµÎ¯Î¼ÎµÎ½Î¿. Î¨Î¬Î¾Îµ ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿ Î³Î¹Î± Î¿Î´Î·Î³Î¯ÎµÏ‚Â· Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î¶Î·Ï„Î¬ÎµÎ¹ Î½Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ Ï„Î¿ Hello.";
  if(roomId==='room2') text = "ÎšÎ¬Î¸Îµ ÏŒÏÎ¿Ï‚ (IP, DNS, HTTP) Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯ ÏƒÎµ Î¼Î¹Î± Î­Î½Î½Î¿Î¹Î±: Î· Î¼Î¯Î± ÏƒÎµ Î´Î¹ÎµÏ…Î¸ÏÎ½ÏƒÎµÎ¹Ï‚, Î· Î¬Î»Î»Î· ÏƒÎµ Î¿Î½ÏŒÎ¼Î±Ï„Î±, Î· Î¬Î»Î»Î· ÏƒÎµ ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î± web. Î£ÏÏÎµ ÎºÎ¬Î¸Îµ ÏŒÏÎ¿ ÏƒÏ„Î¿ Î¿ÏÎ¹ÏƒÎ¼ÏŒ Ï€Î¿Ï… Ï„Î±Î¹ÏÎ¹Î¬Î¶ÎµÎ¹.";
  if(roomId==='room3') text = "ÎŸ ÏƒÏ„ÏŒÏ‡Î¿Ï‚ ÎµÎ¯Î½Î±Î¹ Î­Î½Î±Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚. Î£ÎºÎ­ÏˆÎ¿Ï… Î´Ï…Î±Î´Î¹ÎºÏŒ: ÎºÎ¬Î¸Îµ Î¸Î­ÏƒÎ· bit Î­Ï‡ÎµÎ¹ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ® Â«Î´ÏÎ½Î±Î¼Î·Â». Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î¿ ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿ Ï€Î¿Ï… ÏƒÎ¿Ï… Î»Î­ÎµÎ¹ Ï€Î¿Î¹Î¿Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚.";
  if(roomId==='room4') text = "Î§ÏÎµÎ¹Î¬Î¶ÎµÏƒÎ±Î¹ Python Manual + Port 8080 (Post-It) Î±Ï€ÏŒ Ï„Î¿ Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 1 Î³Î¹Î± Combine. ÎœÎµÏ„Î¬ Ï„Î·Î½ ÎµÎ¯ÏƒÎ¿Î´Î¿ Port, Î±Ï€Î¬Î½Ï„Î·ÏƒÎµ Ï€Î¿Î¹Î¿ ÎµÎ¾Î¬ÏÏ„Î·Î¼Î± Î´Î¹Î±Ï„Î·ÏÎµÎ¯ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï‡Ï‰ÏÎ¯Ï‚ ÏÎµÏÎ¼Î±.";
  if(roomId==='room5') text = "Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Ï‡Î±ÏÏ„Î¯ Î¼Îµ ÎºÏÏ…Ï†Î® Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯Î±. Î ÏÏ‚ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î´ÎµÎ¹Ï‚ ÎºÏÏ…Ï†Î¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÏƒÎµ Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î± Ï„Î¿Ï… Î£Î±ÎºÎ¹Î´Î¯Î¿Ï…;";
  if(roomId==='room6') text = "Î£Îµ ÎºÎ¬Î¸Îµ Î±Î»Î³ÏŒÏÎ¹Î¸Î¼Î¿: Ï€ÏÏÏ„Î± Î±ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·, Î¼ÎµÏ„Î¬ ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ· (loop), Î¼ÎµÏ„Î¬ Î· Ï€ÏÎ¬Î¾Î· Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ loop, Ï„Î­Î»Î¿Ï‚ Î­Î¾Î¿Î´Î¿Ï‚. Î Î¿Î¹Î± ÏƒÎµÎ¹ÏÎ¬ Î­Ï‡ÎµÎ¹ Î½ÏŒÎ·Î¼Î±;";
  if(roomId==='room7') text = "ÎˆÎ»ÎµÎ³Î¾Îµ Ï„Î·Î½ Î¿Î¸ÏŒÎ½Î· Ï€ÏÎ¿ÏƒÎ¿Î¼Î¿Î¹Ï‰Ï„Î® ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿ Î³Î¹Î± Ï„Î·Î½ Î­Î¾Î¿Î´Î¿ range(0, 5, 2).";
  if(roomId==='room8') text = "ÎœÎ¬Î¶ÎµÏˆÎµ Ï„Î¿ Debugger Tool (USB) ÎºÎ±Î¹ Ï€Î¬Ï„Î± Â«Î•Ï†Î±ÏÎ¼Î¿Î³Î® DebuggerÂ». Î£Ï„Î¿ if, Î³Î¹Î± Î¹ÏƒÏŒÏ„Î·Ï„Î± Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Î´ÏÎ¿ Î¯Î´Î¹Î¿Î¹ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚ (==), ÏŒÏ‡Î¹ Î­Î½Î± (=).";
  if(roomId==='room9') text = "Î£ÎºÎ¿Î½Î¬ÎºÎ¹ ÏƒÏ„Î¿Î½ ÎºÎ¬Î´Î¿ Î±Î½Î±ÎºÏÎºÎ»Ï‰ÏƒÎ·Ï‚: SELECT Î³Î¹Î± Î´Î¹Î¬Î²Î±ÏƒÎ¼Î±. Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ Ï„Î·Î½ ÎµÎ½Ï„Î¿Î»Î® ÏƒÏ„Î¿ Ï„ÎµÏÎ¼Î±Ï„Î¹ÎºÏŒ.";
  if(roomId==='room10') text = "Î”Î¹Î­Î³ÏÎ±ÏˆÎµ Ï„Î¿ phishing email. Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ Firewall. Î•Ï€Î¯Î»ÎµÎ¾Îµ HTTPS Î³Î¹Î± Î±ÏƒÏ†Î±Î»Î® ÏƒÏÎ½Î´ÎµÏƒÎ·.";

  let el = document.getElementById("hint-" + roomId);
  const hp = roomConfig[roomId].hintPenalty;
  if(el) el.innerText = "ğŸ’¡ " + text + " (-" + hp + " Î²Î±Î¸Î¼Î¿Î¯)";

  if (!solvedRooms[roomId]) {
    hintsUsed[roomId]++;
    perRoomScore[roomId] = Math.max(0, perRoomScore[roomId] - hp);
    score = Math.max(0, score - hp);
    damageIntegrity(2);
    updateHUD(roomId);
    speakLoss("hint", hp);
    addChatMessage("Operator", `Hint: ${text}`, "operator");
    logAction("HINT_USED", roomId, text);
  }
}

function awardKeyOnce(roomId) {
  if (keyEarnedInRoom[roomId]) return;
  keyEarnedInRoom[roomId] = true;
  keysCollected[roomConfig[roomId].difficultyKey]++;
  updateKeysHud();
}
function showKeyEarned(roomId) {
  const el = document.getElementById("key-earned-" + roomId);
  if (!el) return;
  el.className = "key-earned show";
  el.innerHTML = `<span style='font-size:2em'>âœ… ACCESS GRANTED</span>`;
  addChatMessage("System", `Node ${roomId} Secured. Access Granted.`, "system");
  playSfx("success"); // Sound when key appears
  setTimeout(() => { el.classList.remove("show"); el.style.display = "none"; }, KEY_DISPLAY_MS);
}

/* ROOM 1 TERMINAL - FIXED */
function initTerminalRoom1(){
  if(termInit) return; // FIX: Î‘Ï€Î¿Ï†Ï…Î³Î® Î´Î¹Ï€Î»Î®Ï‚ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚
  const termInput1 = document.getElementById('term-input-1');
  if(!termInput1) return;

  termInput1.addEventListener('keydown', function(e) {
    if(e.key === 'Enter') {
      const cmd = this.value.trim();
      const out = document.getElementById('term-output-1');
      if(!out) return;

      // "Code running" sound when student submits a command
      if (!muteSounds) { try { codeRunSound.currentTime = 0; codeRunSound.play().catch(()=>{}); } catch(err) {} }

      out.innerHTML += `<div class="term-line" style="color:#fff;">root@sys:~$ ${cmd}</div>`;
      this.value = '';

      const ok = cmd.startsWith('print') && (cmd.includes('"') || cmd.includes("'")) && /hello/i.test(cmd);
      if(ok) {
        out.innerHTML += `<div class="term-line term-success">>> Hello</div>`;
        out.innerHTML += `<div class="term-line term-success">>> Î£ÏÏƒÏ„Î·Î¼Î± ÎµÎ½ÎµÏÎ³ÏŒ.</div>`;
        checkAnswer('feedback1', true, null, 'room1');
        
        // --- NEW: AUTO-CLOSE WINDOW ON SUCCESS ---
        setTimeout(() => {
            document.getElementById('qblock-room1').style.display = 'none';
        }, 1500);

      } else {
        out.innerHTML += `<div class="term-line term-error">Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Ï„Î±Î¾Î·Ï‚. Î— ÎµÎ½Ï„Î¿Î»Î® Î´ÎµÎ½ Ï€Î±ÏÎ®Î³Î±Î³Îµ Ï„Î¿ Î±Î½Î±Î¼ÎµÎ½ÏŒÎ¼ÎµÎ½Î¿ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î±.</div>`;
        checkAnswer('feedback1', false, null, 'room1');
      }
      const term = document.getElementById("term-room1");
      if(term) term.scrollTop = term.scrollHeight;
    }
  });
  termInit = true;
}

/* ROOM 3 BIT FLIPPER */
let currentBits = [0,0,0,0,0,0,0,0];
function toggleBit(index, btn) {
    currentBits[index] = currentBits[index] === 0 ? 1 : 0;
    btn.innerText = currentBits[index];
    if(currentBits[index]===1) btn.classList.add('active'); else btn.classList.remove('active');
    
    let val = 0;
    for(let i=0; i<8; i++) {
        if(currentBits[i]===1) val += Math.pow(2, i);
    }
    document.getElementById('bit-val').innerText = val + " (Target: 75)";
}
function checkBits() {
    let val = 0;
    for(let i=0; i<8; i++) { if(currentBits[i]===1) val += Math.pow(2, i); }
    if(val === 75) checkAnswer('feedback3', true, null, 'room3');
    else checkAnswer('feedback3', false, null, 'room3');
}

/* ROOM 4 PORT */
function checkPortRoom4() {
  let val = document.getElementById('input-port-room4').value.trim();
  if(val === "8080") {
    document.getElementById('room4-part1').style.display = 'none';
    document.getElementById('room4-part2').style.display = 'block';
    cinematic("FIREWALL DOWN", "Î Î­ÏÎ±ÏƒÎµÏ‚ Ï„Î¿ Port check. Î ÏÎ¿Ï‡ÏÏÎ± ÏƒÏ„Î¿ hardware!", 1300);
    playSfx("success");
    addChatMessage("System", "Firewall Down. Hardware Access Open.", "system");
    speak("Firewall Down. Î Î¿Î¹Î¿ ÎµÎ¾Î¬ÏÏ„Î·Î¼Î± Î´Î¹Î±Ï„Î·ÏÎµÎ¯ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÏŒÏ„Î±Î½ ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹ Ï„Î¿ ÏÎµÏÎ¼Î±;");
    logAction("PUZZLE_STEP", "room4", "Port 8080 Entered");
  } else {
    document.getElementById('port-feedback').innerText = "âŒ Î›Î±Î½Î¸Î±ÏƒÎ¼Î­Î½Î· ÎµÏ€Î¹Î»Î¿Î³Î®. Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ Toolkit (Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 1) Î³Î¹Î± Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ Port.";
    damageIntegrity(5);
    if (!muteSounds) { wrongSound.currentTime = 0; wrongSound.play().catch(()=>{}); }
    logAction("WRONG_ANSWER", "room4", "Wrong Port: " + val);
  }
}

/* ROOM 5 KEYPAD LOGIC */
function kpPress(num) {
  const d = document.getElementById('keypad-display');
  if(d.value.length < 4) d.value += num;
}
function kpClear() { document.getElementById('keypad-display').value = ""; }
function kpEnter() {
  const d = document.getElementById('keypad-display');
  if(d.value === "1234") {
    checkAnswer('feedback5', true, null, 'room5');
  } else {
    d.value = "ERR";
    triggerGlitch();
    setTimeout(kpClear, 500);
    checkAnswer('feedback5', false, null, 'room5');
  }
}

/* ROOM 6 PARSONS */
function checkParsons() {
    const target = document.getElementById('parsons-target');
    const kids = target.children;
    if(kids.length < 4) { alert("Î£ÏÏÎµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÎµÎ½Ï„Î¿Î»Î­Ï‚!"); return; }
    
    if(kids[0].id==='p2' && kids[1].id==='p3' && kids[2].id==='p4' && kids[3].id==='p1') {
        checkAnswer('feedback6', true, null, 'room6');
    } else {
        checkAnswer('feedback6', false, null, 'room6');
    }
}

/* ROOM 9 TERMINAL (type SELECT â€“ clue in recycling bin) */
function submitSqlRoom9() {
  if (solvedRooms['room9']) return;
  const inp = document.getElementById('input-sql-room9');
  const val = (inp && inp.value) ? inp.value.trim().toUpperCase() : '';
  const correct = (val === 'SELECT');
  attempts['room9']++;
  const fb = document.getElementById('feedback9');
  if (correct) {
    if (fb) fb.innerHTML = "<span class='correct'>âœ… Î•Î½Ï„Î¿Î»Î® Î±Ï€Î¿Î´ÎµÎºÏ„Î®. Î— Î²Î¬ÏƒÎ· Î±Î½Ï„Î±Ï€Î¿ÎºÏÎ¯Î½ÎµÏ„Î±Î¹.<br><small>ÎšÎ­ÏÎ´Î¹ÏƒÎµÏ‚ ÎšÎ»ÎµÎ¹Î´Î¯ Î•Ï€Î¹Ï€Î­Î´Î¿Ï… 3. Î†Î½Î¿Î¹Î¾Îµ Î· Î­Î¾Î¿Î´Î¿Ï‚ Ï„Î¿Ï… Î´Ï‰Î¼Î±Ï„Î¯Î¿Ï….</small></span>";
    solvedRooms['room9'] = true;
    awardKeyOnce('room9');
    showKeyEarned('room9');
    logAction("SOLVED", "room9", "SELECT entered");
    playSfx("success");
    const gkey = document.getElementById("giant-key-room9");
    if (gkey) gkey.style.display = "block";
    const qblock = document.getElementById("qblock-room9");
    if (qblock) qblock.style.display = "none";
  } else {
    if (fb) fb.innerHTML = "<span class='wrong'>âŒ Î•Î½Ï„Î¿Î»Î® Î±Ï€Î¿ÏÏÎ¯Ï†Î¸Î·ÎºÎµ. Î”Î¹Î¬Î²Î±ÏƒÎµ Ï„Î¿ ÏƒÎºÎ¿Î½Î¬ÎºÎ¹ ÏƒÏ„Î¿Î½ ÎºÎ¬Î´Î¿ Î±Î½Î±ÎºÏÎºÎ»Ï‰ÏƒÎ·Ï‚.</span>";
    applyWrongPenalty('room9');
    if (!muteSounds) { wrongSound.currentTime = 0; wrongSound.play().catch(()=>{}); }
    logAction("WRONG_ANSWER", "room9", "Wrong: " + val);
  }
}

function closePuzzleBackToRoom(roomId) {
  const qblock = document.getElementById("qblock-" + roomId);
  const layer = document.querySelector("#" + roomId + " .interaction-layer");
  if (qblock) qblock.style.display = "none";
  if (layer) layer.style.display = "block";
}

function useDebuggerRoom8() {
  const hasDebugger = inventory.some(i => i.text && i.text.includes("Debugger Tool"));
  const needEl = document.getElementById("room8-need-debugger");
  const codeEl = document.getElementById("room8-code-area");
  if (hasDebugger && needEl && codeEl) {
    needEl.style.display = "none";
    codeEl.style.display = "block";
    playSfx("success");
    if (document.getElementById("feedback8")) document.getElementById("feedback8").innerHTML = "<span class='correct'>âœ“ Debugger ÎµÏ†Î±ÏÎ¼ÏŒÏƒÏ„Î·ÎºÎµ. ÎŸ ÎºÏÎ´Î¹ÎºÎ±Ï‚ ÎµÎ¯Î½Î±Î¹ Î¿ÏÎ±Ï„ÏŒÏ‚.</span>";
    logAction("PUZZLE_STEP", "room8", "Debugger applied");
  } else {
    alert("Î ÏÏÏ„Î± Î¼Î¬Î¶ÎµÏˆÎµ Ï„Î¿ Debugger Tool (USB stick) ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿. Î Î¬Ï„Î± Â«Î Î¯ÏƒÏ‰ ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿Â» Î³Î¹Î± Î½Î± Ï„Î¿ Ï€Î¬ÏÎµÎ¹Ï‚.");
  }
}

/* ROOM 8 SPOT THE BUG */
function checkBug(isError, tokenText, element) {
    if(isError) {
        checkAnswer('feedback8', true, null, 'room8');
    } else {
        triggerGlitch();
        // Show educational tooltip instead of alert
        showRoom8Tooltip(tokenText, element);
        damageIntegrity(5);
        logAction("WRONG_ANSWER", "room8", "Clicked wrong token: " + tokenText);
    }
}

function showRoom8Tooltip(tokenText, element) {
    const tooltip = document.getElementById("room8-tooltip");
    if (!tooltip) return;
    
    // Educational messages for each token
    const messages = {
        'if': 'Î¤Î¿ "if" ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„Î® ÎµÎ½Ï„Î¿Î»Î® Python. Î¤Î¿ Ï€ÏÏŒÎ²Î»Î·Î¼Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î¿Î½ Ï„ÎµÎ»ÎµÏƒÏ„Î® ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ·Ï‚.',
        'password': 'Î¤Î¿ "password" ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„Î® Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î®. Î¤Î¿ Ï€ÏÏŒÎ²Î»Î·Î¼Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î¿Î½ Ï„ÎµÎ»ÎµÏƒÏ„Î® ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ·Ï‚.',
        'string1234': 'Î¤Î¿ "1234" ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„Î® Ï„Î¹Î¼Î® string. Î¤Î¿ Ï€ÏÏŒÎ²Î»Î·Î¼Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î¿Î½ Ï„ÎµÎ»ÎµÏƒÏ„Î® ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ·Ï‚.',
        'colon': 'Î¤Î¿ ":" ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„ÏŒÏ‚ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎ±Ï‚ Î³Î¹Î± Ï„Î·Î½ if statement. Î¤Î¿ Ï€ÏÏŒÎ²Î»Î·Î¼Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î¿Î½ Ï„ÎµÎ»ÎµÏƒÏ„Î® ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ·Ï‚.',
        'print': 'Î¤Î¿ "print" ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„Î® ÎµÎ½Ï„Î¿Î»Î® Python. Î¤Î¿ Ï€ÏÏŒÎ²Î»Î·Î¼Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î¿Î½ Ï„ÎµÎ»ÎµÏƒÏ„Î® ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ·Ï‚.'
    };
    
    const message = messages[tokenText] || 'Î‘Ï…Ï„ÏŒ Ï„Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿ Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ ÏƒÏ‰ÏƒÏ„ÏŒ. Î¨Î¬Î¾Îµ Î³Î¹Î± Ï„Î¿ ÏƒÏ…Î½Ï„Î±ÎºÏ„Î¹ÎºÏŒ Î»Î¬Î¸Î¿Ï‚ ÏƒÏ„Î¿Î½ Ï„ÎµÎ»ÎµÏƒÏ„Î® ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ·Ï‚!';
    
    tooltip.textContent = message;
    tooltip.style.display = 'block';
    
    // Position tooltip near the clicked element
    if (element) {
        const rect = element.getBoundingClientRect();
        tooltip.style.left = (rect.left + rect.width / 2) + 'px';
        tooltip.style.top = (rect.top - 60) + 'px';
        tooltip.style.transform = 'translateX(-50%)';
    } else {
        // Fallback: center of screen
        tooltip.style.left = '50%';
        tooltip.style.top = '40%';
        tooltip.style.transform = 'translate(-50%, -50%)';
    }
    
    // Auto-hide after 4 seconds
    setTimeout(() => {
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    }, 4000);
}

/* GENERIC CHECK ANSWER */
function checkAnswer(feedbackId, correct, nextScreen, roomId) {
  let rId = roomId || (nextScreen && nextScreen.startsWith("room") ? nextScreen : null);
  if (!rId) return;
  if (solvedRooms[rId]) return;

  attempts[rId]++;

  let fb = document.getElementById(feedbackId);

  if (correct) {
    if (fb) {
      const successMsg = { room1: "âœ… Î•ÎºÏ„Î­Î»ÎµÏƒÎ· ÎµÏ€Î¹Ï„Ï…Ï‡Î®Ï‚. Î¤Î¿ Ï„ÎµÏÎ¼Î±Ï„Î¹ÎºÏŒ Î±Î½Ï„Î±Ï€Î¿ÎºÏÎ¯Î½ÎµÏ„Î±Î¹.", room2: "âœ… Î£ÏÎ½Î´ÎµÏƒÎ· Î±Ï€Î¿ÎºÎ±Ï„Î±ÏƒÏ„Î¬Î¸Î·ÎºÎµ. Î¡Î¿Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ÎµÎ½ÎµÏÎ³Î®.", room3: "âœ… Î‘Ï€Î¿ÎºÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· ÎµÏ€Î¹Ï„Ï…Ï‡Î®Ï‚. Î¤Î¿ ÏƒÎ®Î¼Î± Î­Î³Î¹Î½Îµ Î±Ï€Î¿Î´ÎµÎºÏ„ÏŒ.", room4: "âœ… Î£Ï‰ÏƒÏ„Î® ÎµÏ€Î¹Î»Î¿Î³Î®. Î¤Î¿ backup Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Ï„ÎµÎ¯.", room5: "âœ… Î ÏÏŒÏƒÎ²Î±ÏƒÎ· ÎµÏ€Î¹Ï„ÏÎ¬Ï€Î·ÎºÎµ.", room6: "âœ… Î•ÎºÏ„Î­Î»ÎµÏƒÎ· ÎµÏ€Î¹Ï„Ï…Ï‡Î®Ï‚. ÎŸ Î±Î»Î³ÏŒÏÎ¹Î¸Î¼Î¿Ï‚ ÏƒÏ„Î±Î¸ÎµÏÎ¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ.", room7: "âœ… Î— Î­Î¾Î¿Î´Î¿Ï‚ Ï„Î±Î¹ÏÎ¹Î¬Î¶ÎµÎ¹ Î¼Îµ Ï„Î¿ log. Î£Ï…Î½Î­Ï‡ÎµÎ¹Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚.", room8: "âœ… Î”Î¹ÏŒÏÎ¸Ï‰ÏƒÎ· ÎµÏ†Î±ÏÎ¼ÏŒÏƒÏ„Î·ÎºÎµ. Î— Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± ÏƒÏ…Î½ÎµÏ‡Î¯Î¶ÎµÏ„Î±Î¹.", room9: "âœ… Î•Î½Ï„Î¿Î»Î® Î±Ï€Î¿Î´ÎµÎºÏ„Î®. Î— Î²Î¬ÏƒÎ· Î±Î½Ï„Î±Ï€Î¿ÎºÏÎ¯Î½ÎµÏ„Î±Î¹.", room10: "âœ… Î ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î¿ Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ." };
      const keyLine = rId === 'room10' ? "Ï„Î¿ Ï„ÎµÎ»Î¹ÎºÏŒ ÎºÎ»ÎµÎ¹Î´Î¯" : (roomConfig[rId] && { easy: "ÎšÎ»ÎµÎ¹Î´Î¯ Î•Ï€Î¹Ï€Î­Î´Î¿Ï… 1", medium: "ÎšÎ»ÎµÎ¹Î´Î¯ Î•Ï€Î¹Ï€Î­Î´Î¿Ï… 2", hard: "ÎšÎ»ÎµÎ¹Î´Î¯ Î•Ï€Î¹Ï€Î­Î´Î¿Ï… 3" }[roomConfig[rId].difficultyKey]) || "ÎºÎ»ÎµÎ¹Î´Î¯";
      fb.innerHTML = "<span class='correct'>" + (successMsg[rId] || "âœ… Î ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î¿ Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ.") + "<br><small>ÎšÎ­ÏÎ´Î¹ÏƒÎµÏ‚ " + keyLine + ". Î†Î½Î¿Î¹Î¾Îµ Î· Î­Î¾Î¿Î´Î¿Ï‚ Ï„Î¿Ï… Î´Ï‰Î¼Î±Ï„Î¯Î¿Ï….</small></span>";
    }
    solvedRooms[rId] = true;
    awardKeyOnce(rId);
    showKeyEarned(rId);
    logAction("SOLVED", rId, "Correct Answer");
    playSfx("success");

    const gkey = document.getElementById("giant-key-" + rId);
    if(gkey) gkey.style.display = "block";

    if(rId !== 'room1') {
      const qblock = document.getElementById("qblock-" + rId);
      if(qblock) qblock.style.display = "none";
    }

  } else {
    if (fb) {
      const failMsg = { room1: "âŒ Î£Ï†Î¬Î»Î¼Î± ÎµÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚. ÎˆÎ»ÎµÎ³Î¾Îµ ÏƒÏÎ½Ï„Î±Î¾Î· ÎºÎ±Î¹ ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î¹ÎºÎ¬.", room2: "âŒ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Ï€Î¿ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚. ÎšÎ¬Ï€Î¿Î¹Î¿ module ÎµÎ¯Î½Î±Î¹ ÏƒÎµ Î»Î¬Î¸Î¿Ï‚ Î¸Î­ÏƒÎ·.", room3: "âŒ Î›Î¬Î¸Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·. Î¡ÏÎ¸Î¼Î¹ÏƒÎµ Î¾Î±Î½Î¬ Ï„Î± bits.", room4: "âŒ Î›Î±Î½Î¸Î±ÏƒÎ¼Î­Î½Î· ÎµÏ€Î¹Î»Î¿Î³Î®. Î¤Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï„Î·ÏÎ®ÏƒÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î­Ï„ÏƒÎ¹.", room5: "âŒ Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ· ÎºÏ‰Î´Î¹ÎºÎ¿Ï. ÎÎ­Î± Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î±.", room6: "âŒ Î£Ï†Î¬Î»Î¼Î± ÏÎ¿Î®Ï‚. ÎšÎ¬Ï€Î¿Î¹Î± ÎµÎ½Ï„Î¿Î»Î® ÎµÎ¯Î½Î±Î¹ ÏƒÎµ Î»Î¬Î¸Î¿Ï‚ Î¸Î­ÏƒÎ·.", room7: "âŒ Î— Î­Î¾Î¿Î´Î¿Ï‚ Î´ÎµÎ½ Ï„Î±Î¹ÏÎ¹Î¬Î¶ÎµÎ¹. ÎÎ±Î½Î±Î­Î»ÎµÎ³Î¾Îµ Ï„Î¿ Î²Î®Î¼Î± (step).", room8: "âŒ Î”ÎµÎ½ Î®Ï„Î±Î½ Î±Ï…Ï„ÏŒ. Î¤Î¿ ÏƒÏ†Î¬Î»Î¼Î± Ï€Î±ÏÎ±Î¼Î­Î½ÎµÎ¹.", room9: "âŒ Î•Î½Ï„Î¿Î»Î® Î±Ï€Î¿ÏÏÎ¯Ï†Î¸Î·ÎºÎµ. Î›Î±Î½Î¸Î±ÏƒÎ¼Î­Î½Î· ÎµÎ½Ï„Î¿Î»Î®.", room10: "âŒ ÎŸ Î¹ÏŒÏ‚ Ï€ÏÎ¿ÏƒÎ±ÏÎ¼ÏŒÎ¶ÎµÏ„Î±Î¹. Î¤Î¿ Ï€ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î¿ Î±Ï€Î­Ï„Ï…Ï‡Îµ." };
      fb.innerHTML = "<span class='wrong'>" + (failMsg[rId] || "âŒ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±Ï‚.") + "</span>";
    }
    applyWrongPenalty(rId);
  }
}

/* BOSS FIGHT */
function startVirusStorm() {
    virusInterval = setInterval(() => {
        if(solvedRooms['room10']) { clearInterval(virusInterval); return; }
        const p = document.createElement('div');
        p.className = 'virus-popup';
        p.style.top = (75 + Math.random() * 20) + '%';
        p.style.left = (5 + Math.random() * 90) + '%';
        p.innerHTML = "âš ï¸ SYSTEM FAILURE <div class='virus-close' onclick='this.parentElement.remove()'>X</div>";
        document.body.appendChild(p);
        setTimeout(() => { if(p.parentElement) p.remove(); }, 8500);
    }, 3500);
}

function bossFightStep(step, isCorrect) {
  let fb = document.getElementById('feedback10');
  if(!isCorrect) {
    fb.innerHTML = "âŒ ÎŸ Î¹ÏŒÏ‚ Ï€ÏÎ¿ÏƒÎ±ÏÎ¼ÏŒÎ¶ÎµÏ„Î±Î¹. Î¤Î¿ Ï€ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î¿ Î±Ï€Î­Ï„Ï…Ï‡Îµ.";
    damageIntegrity(10);
    triggerGlitch();
    if (!muteSounds) { wrongSound.currentTime = 0; wrongSound.play().catch(()=>{}); }
    logAction("WRONG_ANSWER", "room10", "Step " + step + " Failed");
    return;
  }

  playSfx("success");
  document.getElementById('boss-step-'+step).style.display = 'none';
  logAction("BOSS_STEP", "room10", "Step " + step + " Cleared");

  if(step < 3) {
    let next = step + 1;
    document.getElementById('boss-pct').innerText = (step * 33) + "%";

    // --- BETWEEN-STEPS NARRATIVE (ADDITIVE) ---
    const bossBeat = {
      1: { title: "PHISHING IDENTIFIED", text: "ÎšÎ±Î»Î® Î´Î¿Ï…Î»ÎµÎ¹Î¬. ÎŸ Wiper Î´ÎµÎ½ ÏƒÎµ Î¾ÎµÎ³Î­Î»Î±ÏƒÎµ. Î ÏÎ¿Ï‡ÏÏÎ± ÏƒÏ„Î·Î½ Î¬Î¼Ï…Î½Î±." },
      2: { title: "FIREWALL ENGAGED",   text: "Î¤Î¿ Ï„ÎµÎ¯Ï‡Î¿Ï‚ ÏƒÎ·ÎºÏÎ¸Î·ÎºÎµ. ÎŸ Wiper Ï€Î¹Î­Î¶ÎµÎ¹. Î¤ÏÏÎ± ÎµÎ¾Î±ÏƒÏ†Î¬Î»Î¹ÏƒÎµ Ï„Î¿ Web ÎºÎ±Î½Î¬Î»Î¹." }
    };
    const beat = bossBeat[step];
    if (beat) {
      cinematic(beat.title, beat.text, 3200);
      addChatMessage("Wiper", step === 1 ? "â€¦you resisted." : "â€¦still not enough.", "operator");
    }

    // Reveal next step after message has been visible long enough to read
    setTimeout(() => {
      const nextEl = document.getElementById('boss-step-'+next);
      if(nextEl) nextEl.style.display = 'block';
    }, 3200);
  } else {
    document.getElementById('boss-pct').innerText = "100%";
    solvedRooms['room10'] = true;
    clearInterval(virusInterval); // Stop storm
    document.querySelectorAll('.virus-popup').forEach(p => p.remove());
    
    awardKeyOnce('room10');
    showKeyEarned('room10');
    logAction("SOLVED", "room10", "Boss Defeated");
    document.getElementById("giant-key-room10").style.display = "block";
    document.getElementById("qblock-room10").style.display = "none";
    const h2 = document.querySelector("#room10 h2");
    if(h2) h2.innerText = "SERVER SECURED";
    cinematic("VIRUS PURGED", "ÎŸ Wiper ÎµÎ¾Î¿Ï…Î´ÎµÏ„ÎµÏÏÎ¸Î·ÎºÎµ!", 1400);
    speak("ÎŸ Î¹ÏŒÏ‚ ÎµÎ¾Î¿Ï…Î´ÎµÏ„ÎµÏÏÎ¸Î·ÎºÎµ. Î ÏÎ¿Ï‡ÏÏÎ± ÏƒÏ„Î·Î½ Î­Î¾Î¿Î´Î¿.");
  }
}

/* DRAG & DROP: ROOM 2 (CLASSIC) */
let draggedItem = null;
function initRoom2Drag(){
  const items = document.querySelectorAll('#room2-pool .drag-item');
  items.forEach(item => {
    item.addEventListener('dragstart', (e)=> {
        draggedItem = item;
        e.dataTransfer.effectAllowed = 'move';
        item.style.opacity = '0.5';
    });
    item.addEventListener('dragend', () => {
        item.style.opacity = '1';
        draggedItem = null;
    });
  });

  const zones = document.querySelectorAll('#room2 .drop-zone, #room2-pool');
  zones.forEach(zone => {
    zone.addEventListener('dragover', (e) => { e.preventDefault(); });
    zone.addEventListener('drop', (e)=> {
      e.preventDefault();
      if(draggedItem && draggedItem.classList.contains('drag-item')) {
          zone.appendChild(draggedItem);
      }
    });
  });
}

function checkRoom2() {
  if (solvedRooms['room2']) return;
  attempts['room2']++;
  let ok = true;
  document.querySelectorAll('.drop-zone').forEach(zone => {
    let needed = zone.getAttribute("data-answer");
    let child = zone.querySelector('.drag-item');
    if(!child || child.id !== needed) ok = false;
  });
  if(ok) checkAnswer('feedback2', true, null, 'room2');
  else checkAnswer('feedback2', false, null, 'room2');
}
function resetRoom2() {
  let c = document.getElementById('room2-pool');
  document.querySelectorAll('.drag-item').forEach(item => c.appendChild(item));
  document.getElementById('feedback2').innerHTML = "";
}

/* DRAG & DROP: ROOM 6 (PARSONS STRICT) */
function initParsonsDrag(){
  // Logic specifically for parsons lines
  document.querySelectorAll('.parsons-line').forEach(item => {
    item.addEventListener('dragstart', (e)=> {
        draggedItem = item;
        e.dataTransfer.effectAllowed = 'move';
        item.style.opacity = '0.5';
    });
    item.addEventListener('dragend', () => {
        item.style.opacity = '1';
        draggedItem = null;
    });
  });

  // Zones for Room 6 only
  const pZones = document.querySelectorAll('.parsons-drop-area, #parsons-source');
  pZones.forEach(zone => {
    zone.addEventListener('dragover', (e) => { e.preventDefault(); });
    zone.addEventListener('drop', (e)=> {
      e.preventDefault();
      if(draggedItem && draggedItem.classList.contains('parsons-line')) {
          zone.appendChild(draggedItem);
      }
    });
  });
}

/* MINIGAME */
function triggerMinigame(nextRoom) {
  document.getElementById('minigame-overlay').style.display = 'flex';
  let hits = 0;
  const targetEl = document.getElementById('minigame-target');
  const bar = document.getElementById('minigame-bar');
  const letters = ['A', 'S', 'D', 'W', 'SPACE'];

  let gameInterval = setInterval(() => {
    targetEl.innerText = letters[Math.floor(Math.random() * letters.length)];
  }, 1000);

  const keyHandler = (e) => {
    const overlay = document.getElementById('minigame-overlay');
    if(overlay.style.display === 'flex') {
      const req = targetEl.innerText;
      let pressed = e.key.toUpperCase();
      if (e.code === 'Space') pressed = 'SPACE';

      if(pressed === req) {
        hits++;
        bar.style.width = (hits * 20) + "%";
        if(hits >= 5) {
          clearInterval(gameInterval);
          overlay.style.display = 'none';
          document.removeEventListener('keydown', keyHandler);
          goToNextFrom('room2', nextRoom);
        }
      } else {
        hits = Math.max(0, hits - 1);
        bar.style.width = (hits * 20) + "%";
      }
      minigameAttempts++;
    }
  };
  document.addEventListener('keydown', keyHandler);
}

/* COMBINE SYSTEM */
function combineItems() {
  combineAttempts++;

  // --- Î Î¡ÎŸÎ¤Î•Î¡Î‘Î™ÎŸÎ¤Î—Î¤Î‘ 1: SQL MASTER KEY (Î“Î¹Î± Ï„Î¿ Room 9) ---
  const hasA = inventory.some(i => i.text.includes("Log Fragment A"));
  const hasB = inventory.some(i => i.text.includes("Cipher Fragment B"));
  const hasC = inventory.some(i => i.text.includes("Schema Fragment C"));
  const alreadyHasKey = inventory.some(i => i.text.includes("SQL MASTER KEY"));

  if (hasA && hasB && hasC) {
    if (alreadyHasKey) {
        alert("ÎˆÏ‡ÎµÎ¹Ï‚ Î®Î´Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Ï„Î¿ SQL MASTER KEY.");
        return;
    }
    inventory.push({
      icon: "ğŸ—ï¸",
      text: "SQL MASTER KEY: SELECT name FROM students WHERE class='A'",
      roomId: "combine",
      secret: "CODE: 9999 (Not really needed here, just a key)"
    });
    updateInventoryUI();
    cinematic("MASTER KEY FORGED", "ğŸ—ï¸ SQL MASTER KEY Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ! Î¤ÏÏÎ± Ï„Î¿ Node 9 Î¾ÎµÎºÎ»ÎµÎ¹Î´ÏÎ½ÎµÎ¹.", 1500);
    addChatMessage("System", "Combine OK: A+B+C â†’ SQL MASTER KEY created.", "system");
    if(!muteSpeech) speak("Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Ï„Î¿ SQL master key. Î¤Î¿ node ÎµÎ½Î½Î­Î± Î¾ÎµÎºÎ»ÎµÎ¹Î´ÏÎ½ÎµÎ¹.");
    logAction("COMBINE", "inventory", "Created SQL Master Key");
    return;
  }

  // --- PARTIAL FEEDBACK: 2/3 SQL FRAGMENTS ---
  const fragmentCount = (hasA ? 1 : 0) + (hasB ? 1 : 0) + (hasC ? 1 : 0);
  if (fragmentCount === 2) {
    const missing = !hasA ? "A" : (!hasB ? "B" : "C");
    alert(`Î•Î¯ÏƒÎ±Î¹ Ï€Î¿Î»Ï ÎºÎ¿Î½Ï„Î¬: Î­Ï‡ÎµÎ¹Ï‚ 2/3 SQL Fragments. Î£Î¿Ï… Î»ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ Fragment ${missing}. Î¨Î¬Î¾Îµ ÏƒÏ„Î± Nodes 7, 8 ÎºÎ±Î¹ 9 ÎºÎ±Î¹ Î¾Î±Î½Î±ÎºÎ¬Î½Îµ Combine.`);
    addChatMessage("Operator", `2/3 Fragments Î²ÏÎ­Î¸Î·ÎºÎ±Î½. Î›ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ Fragment ${missing} (Nodes 7, 8, 9).`, "operator");
    return;
  }

  if (hasA || hasB || hasC) {
      if (!hasA || !hasB || !hasC) {
          alert("Î ÏÎ¿ÏƒÏ€Î±Î¸ÎµÎ¯Ï‚ Î½Î± Ï†Ï„Î¹Î¬Î¾ÎµÎ¹Ï‚ Ï„Î¿ Master Key, Î±Î»Î»Î¬ ÏƒÎ¿Ï… Î»ÎµÎ¯Ï€Î¿Ï…Î½ ÎºÎ¿Î¼Î¼Î¬Ï„Î¹Î± (Fragments A, B, C). Î¨Î¬Î¾Îµ ÏƒÏ„Î± Î´Ï‰Î¼Î¬Ï„Î¹Î± 7, 8 ÎºÎ±Î¹ 9.");
          return;
      }
  }

  // --- Î Î¡ÎŸÎ¤Î•Î¡Î‘Î™ÎŸÎ¤Î—Î¤Î‘ 2: FIREWALL PORT (Î“Î¹Î± Ï„Î¿ Room 4) ---
  const hasManual = inventory.some(i => i.text.includes("Python Manual"));
  const hasPort = inventory.some(i => i.text.includes("Port 8080"));

  // --- PARTIAL FEEDBACK: MANUAL / PORT PAIR ---
  if (hasManual && !hasPort) {
    alert("ÎˆÏ‡ÎµÎ¹Ï‚ Ï„Î¿ Python Manual, Î±Î»Î»Î¬ ÏƒÎ¿Ï… Î»ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ Port 8080 (Post-It) Î±Ï€ÏŒ Ï„Î¿ Node 1. Î’ÏÎµÏ‚ Ï„Î¿ ÎºÎ±Î¹ Î¾Î±Î½Î±ÎºÎ¬Î½Îµ Combine.");
    addChatMessage("Operator", "Î£Î¿Ï… Î»ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ Port 8080 (Post-It) Î±Ï€ÏŒ Ï„Î¿ Node 1.", "operator");
    return;
  }
  if (!hasManual && hasPort) {
    alert("ÎˆÏ‡ÎµÎ¹Ï‚ Ï„Î¿ Port 8080 (Post-It), Î±Î»Î»Î¬ ÏƒÎ¿Ï… Î»ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ Python Manual Î±Ï€ÏŒ Ï„Î¿ Node 1. Î’ÏÎµÏ‚ Ï„Î¿ ÎºÎ±Î¹ Î¾Î±Î½Î±ÎºÎ¬Î½Îµ Combine.");
    addChatMessage("Operator", "Î£Î¿Ï… Î»ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ Python Manual Î±Ï€ÏŒ Ï„Î¿ Node 1.", "operator");
    return;
  }

  if (hasManual && hasPort) {
    const inp = document.getElementById("input-port-room4");
    const btn = document.getElementById("btn-port-room4");
    
    if (inp && inp.disabled === true) {
      inp.disabled = false;
      btn.disabled = false;
      inp.placeholder = "XXXX";
      inp.focus();
      const portFb = document.getElementById("port-feedback");
      if (portFb) portFb.innerText = "âœ“ Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ ÎµÎ½ÎµÏÎ³Î®. Î¤Î¿ Port ÎµÎ¯Î½Î±Î¹ 8080.";
      cinematic("FIREWALL OVERRIDE", "Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ Î· ÎµÎ¯ÏƒÎ¿Î´Î¿Ï‚ Port. Î¤Î¿ Port ÎµÎ¯Î½Î±Î¹ 8080.", 1300);
      addChatMessage("System", "Combine OK: Manual + Port â†’ Firewall Port input enabled.", "system");
      if(!muteSpeech) speak("ÎŸ ÏƒÏ…Î½Î´Ï…Î±ÏƒÎ¼ÏŒÏ‚ Ï€Î­Ï„Ï…Ï‡Îµ. Î¤Î¿ Ï€ÏŒÏÏ„ ÎµÎ¯Î½Î±Î¹ 8080.");
      logAction("COMBINE", "inventory", "Unlocked Room 4 Port");
    } else {
        alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î¬Î»Î»Î¿Ï‚ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿Ï‚ ÏƒÏ…Î½Î´Ï…Î±ÏƒÎ¼ÏŒÏ‚ Î±Ï…Ï„Î® Ï„Î· ÏƒÏ„Î¹Î³Î¼Î®.");
    }
    return;
  }

  // --- NARRATIVE ONLY: Manual + ASCII Chart â†’ Decoded Hint (no room unlock) ---
  const hasAsciiChart = inventory.some(i => i.text.includes("ASCII Chart"));
  if (hasManual && hasAsciiChart) {
    cinematic("DECODED HINT", "Manual + ASCII Chart: Î¤Î¿ Î³ÏÎ¬Î¼Î¼Î± K = 75 ÏƒÎµ Î´ÎµÎºÎ±Î´Î¹ÎºÏŒ. Î£Ï„Î¿ Node 3 (Binary), ÏƒÏ‡Î·Î¼Î¬Ï„Î¹ÏƒÎµ Ï„Î¿Î½ Î±ÏÎ¹Î¸Î¼ÏŒ 75 Î¼Îµ Ï„Î± bit.", 2000);
    addChatMessage("System", "Decoded: K=75. Î§ÏÎ®ÏƒÎ¹Î¼Î¿ Î³Î¹Î± Ï„Î¿ Binary Node (Node 3).", "system");
    logAction("COMBINE", "inventory", "Decoded Hint: Manual + ASCII Chart");
    return;
  }

  alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿Ï‚ ÏƒÏ…Î½Î´Ï…Î±ÏƒÎ¼ÏŒÏ‚ Î¼Îµ Ï„Î± Ï„Ï‰ÏÎ¹Î½Î¬ Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î±.");
  addChatMessage("Operator", "Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ ÏƒÏ‰ÏƒÏ„Î¬ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Î³Î¹Î± Combine Î±ÎºÏŒÎ¼Î±.", "operator");
}

/* CHATBOT */
const operatorKB = {
  room1: { concept: "Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 1: Python Ï„ÎµÏÎ¼Î±Ï„Î¹ÎºÏŒ. Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î· ÎµÎ½Ï„Î¿Î»Î® Ï€Î¿Ï… ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÎ¹ ÎºÎµÎ¯Î¼ÎµÎ½Î¿.", guidedHint: "Î¨Î¬Î¾Îµ ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿ Î³Î¹Î± Î¿Î´Î·Î³Î¯ÎµÏ‚. Î£Ï„Î¿ Python Î³ÏÎ¬Ï†Î¿Ï…Î¼Îµ Ï„Î·Î½ ÎµÎ½Ï„Î¿Î»Î® ÎºÎ±Î¹ Ï„Î¿ Î¼Î®Î½Ï…Î¼Î± ÏƒÎµ Ï€Î±ÏÎµÎ½Î¸Î­ÏƒÎµÎ¹Ï‚ Î¼Îµ ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î¹ÎºÎ¬." },
  room2: { concept: "Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 2: Î ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î± Î´Î¹ÎºÏ„ÏÎ¿Ï…. IP, DNS, HTTP.", guidedHint: "ÎšÎ¬Î¸Îµ ÏŒÏÎ¿Ï‚ Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯ ÏƒÎµ Î¼Î¹Î± Î­Î½Î½Î¿Î¹Î± (Î´Î¹ÎµÏ…Î¸ÏÎ½ÏƒÎµÎ¹Ï‚, Î¿Î½ÏŒÎ¼Î±Ï„Î±, ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î± web). Î£ÏÏÎµ ÎºÎ¬Î¸Îµ ÏŒÏÎ¿ ÏƒÏ„Î¿ Î¿ÏÎ¹ÏƒÎ¼ÏŒ Ï€Î¿Ï… Ï„Î±Î¹ÏÎ¹Î¬Î¶ÎµÎ¹." },
  room3: { concept: "Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 3: Î”Ï…Î±Î´Î¹ÎºÏŒ. Î£Ï„ÏŒÏ‡Î¿Ï‚ Î­Î½Î±Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚.", guidedHint: "ÎšÎ¬Î¸Îµ Î¸Î­ÏƒÎ· bit Î­Ï‡ÎµÎ¹ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ® Î´ÏÎ½Î±Î¼Î·. Î¨Î¬Î¾Îµ ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿ Ï€Î¿Î¹Î¿Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Î¶Î·Ï„Î¬ÎµÎ¹ Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î±." },
  room4: { concept: "Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 4: Firewall (Port) ÎºÎ±Î¹ hardware.", guidedHint: "Î¤Î¿ Port Î²ÏÎ¯ÏƒÎºÎµÏ„Î±Î¹ ÏƒÎµ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î±Ï€ÏŒ Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 1Â· Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Combine. ÎœÎµÏ„Î¬ Ï„Î·Î½ ÎµÎ¯ÏƒÎ¿Î´Î¿ Port: Ï€Î¿Î¹Î¿ ÎµÎ¾Î¬ÏÏ„Î·Î¼Î± ÎºÏÎ±Ï„Î¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï‡Ï‰ÏÎ¯Ï‚ ÏÎµÏÎ¼Î±;" },
  room5: { concept: "Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 5: ÎšÏ‰Î´Î¹ÎºÏŒÏ‚. ÎšÏÏ…Ï†Î¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î±.", guidedHint: "Î†Î½Î¿Î¹Î¾Îµ Ï„Î¿ Î£Î±ÎºÎ¯Î´Î¹Î¿ ÎºÎ±Î¹ Î­Î»ÎµÎ³Î¾Îµ Ï„Î± Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î±â€”Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„ÏÏŒÏ€Î¿Ï‚ Î½Î± Î´ÎµÎ¹Ï‚ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± Î±Ï€ÏŒ Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿." },
  room6: { concept: "Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 6: Î‘Î»Î³ÏŒÏÎ¹Î¸Î¼Î¿Ï‚ (ÏƒÎµÎ¹ÏÎ¬ ÎµÎ½Ï„Î¿Î»ÏÎ½).", guidedHint: "Î£ÎºÎ­ÏˆÎ¿Ï…: Ï€ÏÏÏ„Î± Î±ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·, Î¼ÎµÏ„Î¬ ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ·, Î¼ÎµÏ„Î¬ Î· Ï€ÏÎ¬Î¾Î· Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ loop, Ï„Î­Î»Î¿Ï‚ Î­Î¾Î¿Î´Î¿Ï‚." },
  room7: { concept: "Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 7: Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ· Î¼Îµ Î²Î®Î¼Î± 2.", guidedHint: "ÎŒÏ„Î±Î½ Ï„Î¿ Î²Î®Î¼Î± ÎµÎ¯Î½Î±Î¹ 2, Î´ÎµÎ½ Ï€Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Ï„Î¹Î¼Î­Ï‚. Î Î¿Î¹ÎµÏ‚ Ï„Î¹Î¼Î­Ï‚ Î±Ï€ÏŒ 0 Î¼Î­Ï‡ÏÎ¹ 4 Î¸Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„Î¿ÏÎ½;" },
  room8: { concept: "Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 8: Î£Ï…Î½Ï„Î±ÎºÏ„Î¹ÎºÏŒ. Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· ÏƒÎµ if.", guidedHint: "Î£Ï„Î¿ Python, Î³Î¹Î± Î¹ÏƒÏŒÏ„Î·Ï„Î± ÏƒÎµ if Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Î´ÏÎ¿ Î¯Î´Î¹Î¿Î¹ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚. Î Î¿Î¹Î¿ ÏƒÏÎ¼Î²Î¿Î»Î¿ ÎµÎ´Ï ÎµÎ¯Î½Î±Î¹ Î»Î¬Î¸Î¿Ï‚;" },
  room9: { concept: "Î”Ï‰Î¼Î¬Ï„Î¹Î¿ 9: SQL. Î‘Î½Î¬ÎºÏ„Î·ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.", guidedHint: "ÎœÎ¯Î± ÎµÎ½Ï„Î¿Î»Î® Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± (ÏŒÏ‡Î¹ ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®/ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·). Î“Î¹Î± Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯: Î¸ÏÎ±ÏÏƒÎ¼Î±Ï„Î± Î±Ï€ÏŒ Ï„ÏÎ¯Î± Î´Ï‰Î¼Î¬Ï„Î¹Î± ÎºÎ±Î¹ Combine." },
  room10: { concept: "Î¤ÎµÎ»Î¹ÎºÏŒ: Phishing, Firewall, Î±ÏƒÏ†Î±Î»Î­Ï‚ Web.", guidedHint: "Î Î¿Î¹Î¿ Î¼Î®Î½Ï…Î¼Î± Ï€Î¹Î­Î¶ÎµÎ¹ Î³Î¹Î± Î¬Î¼ÎµÏƒÎ¿ ÎºÎ»Î¹Îº; Î¤Î¹ Î¼Ï€Î»Î¿ÎºÎ¬ÏÎµÎ¹ Î¼Î· ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´Î¿Ï„Î·Î¼Î­Î½ÎµÏ‚ ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹Ï‚; Î Î¿Î¹Î¿ Ï€ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î¿ web Î­Ï‡ÎµÎ¹ S;" }
};
const glossaryTerms = { IP: "Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î´Î¹Î±Î´Î¹ÎºÏ„ÏÎ¿Ï…", DNS: "Î£ÏÏƒÏ„Î·Î¼Î± Î¿Î½Î¿Î¼Î¬Ï„Ï‰Î½", RAM: "ÎœÎ½Î®Î¼Î· Ï„Ï…Ï‡Î±Î¯Î±Ï‚ Ï€ÏÎ¿ÏƒÏ€Î­Î»Î±ÏƒÎ·Ï‚", Firewall: "Î¤ÎµÎ¯Ï‡Î¿Ï‚ Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î±Ï‚", Python: "Î“Î»ÏÏƒÏƒÎ± Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï", Phishing: "Î—Î»ÎµÎºÏ„ÏÎ¿Î½Î¹ÎºÏŒ ÏˆÎ¬ÏÎµÎ¼Î±", "HDD": "ÎœÎ¿Î½Î¬Î´Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚", SQL: "Î“Î»ÏÏƒÏƒÎ± ÎµÏÏ‰Ï„Î·Î¼Î¬Ï„Ï‰Î½ Î²Î¬ÏƒÎµÏ‰Î½", HTTPS: "Î‘ÏƒÏ†Î±Î»Î­Ï‚ Ï€ÏÏ‰Ï„ÏŒÎºÎ¿Î»Î»Î¿ Web" };

function isUnintelligible(text) {
  if (!text || text.length < 2) return false;
  if (/[\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff\u0600-\u06ff]/.test(text)) return true;
  const allowed = text.match(/[a-zA-Z\u0370-\u03ff0-9\s.,;?!'\"-]/g);
  const ratio = allowed ? allowed.length / text.length : 0;
  return ratio < 0.5;
}

function getOperatorResponse(question) {
  const raw = (question || "").trim();
  const q = raw.toLowerCase();
  if (!q) return "Î“ÏÎ¬ÏˆÎµ ÎºÎ¬Ï„Î¹ Î³Î¹Î± Î½Î± ÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚.";
  if (isUnintelligible(raw)) {
    logAction("CHAT_RESPONSE", currentRoomId, "Unintelligible");
    return "Î”ÎµÎ½ ÎºÎ±Ï„Î±Î»Î±Î²Î±Î¯Î½Ï‰. Î“ÏÎ¬ÏˆÎµ ÏƒÏ„Î± Î•Î»Î»Î·Î½Î¹ÎºÎ¬ Î® Î‘Î³Î³Î»Î¹ÎºÎ¬ Î³Î¹Î± Î½Î± ÏƒÎµ Î²Î¿Î·Î¸Î®ÏƒÏ‰â€”Î´ÎµÎ½ Î´Î¯Î½Ï‰ Ï€Î¿Ï„Î­ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·, Î¼ÏŒÎ½Î¿ Î¿Î´Î·Î³Î¯ÎµÏ‚.";
  }
  const askAnswer = /\b(Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·|Î»ÏÏƒÎ·|Ï€Î¿Î¹Î¿ ÎµÎ¯Î½Î±Î¹|Ï„Î¹ ÎµÎ¯Î½Î±Î¹ Î· Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·|answer|solution|Ï„Î¹ Î±Ï€Î±Î½Ï„Î¬Ï‰|Ï€Î¿Î¹Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯|Ï„Î¹ Ï€Î±Ï„Î¬Ï‰|Ï„Î¹ Î³ÏÎ¬Ï†Ï‰|Ï„Î¹ Ï€Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³Ï|Ï€Î¿Î¹Î± Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·|Ï€ÎµÏ‚ Î¼Î¿Ï… Ï„Î·Î½|Ï€ÎµÎ¯Ï„Îµ Ï„Î·Î½|Î· Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·|Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ|correct answer|right answer)\b/i.test(q) || /^(Ï„Î¹|Ï€Î¿Î¹Î¿|Ï€Ï‰Ï‚|Î³Î¹Î±Ï„Î¹)\s/i.test(q) && (q.includes("Î±Ï€Î±Î½Ï„") || q.includes("ÏƒÏ‰ÏƒÏ„") || q.includes("ÎºÎ¿Ï…Î¼Ï€") || q.length < 25);
  if (askAnswer) {
    logAction("CHAT_RESPONSE", currentRoomId, "Refused direct answer");
    return "Î”ÎµÎ½ Î´Î¯Î½Ï‰ Ï€Î¿Ï„Î­ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·â€”Î¼ÏŒÎ½Î¿ Î²Î¿Î®Î¸ÎµÎ¹Î±. Î£ÎºÎ­ÏˆÎ¿Ï… Ï„Î·Î½ Î­Î½Î½Î¿Î¹Î±Â· Î±Î½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏƒÎ±Î¹ Î¿Î´Î·Î³Î¯Î±, Ï€Î¬Ï„Î·ÏƒÎµ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·.";
  }
  if (currentRoomId && roomConfig[currentRoomId] && !solvedRooms[currentRoomId]) {
    const kb = operatorKB[currentRoomId];
    if (kb) {
      const reply = kb.concept + " " + kb.guidedHint + " Î‘Î½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏƒÎ±Î¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ· Î²Î¿Î®Î¸ÎµÎ¹Î±, Ï€Î¬Ï„Î·ÏƒÎµ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·.";
      logAction("CHAT_RESPONSE", currentRoomId, reply.substring(0, 80));
      return reply;
    }
  }
  for (const [term, def] of Object.entries(glossaryTerms)) {
    if (q.includes(term.toLowerCase())) {
      const out = term + ": " + def + ".";
      logAction("CHAT_RESPONSE", currentRoomId, out.substring(0, 80));
      return out;
    }
  }
  const fallback = "Î¡ÏÏ„Î± Î³Î¹Î± Ï„Î·Î½ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÎµÏÎ³Î±ÏƒÎ¯Î± (Ï€.Ï‡. Ï„Î¹ ÎºÎ¬Î½Ï‰ ÎµÎ´Ï;) Î® Î³Î¹Î± ÏŒÏÎ¿Ï…Ï‚ (IP, DNS, Python, Îº.Î¬.). Î”ÎµÎ½ Î´Î¯Î½Ï‰ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚â€”Î¼ÏŒÎ½Î¿ Î¿Î´Î·Î³Î¯ÎµÏ‚.";
  logAction("CHAT_RESPONSE", currentRoomId, fallback);
  return fallback;
}

function sendChatQuestion() {
  const inp = document.getElementById("chat-input");
  if (!inp) return;
  const question = inp.value.trim();
  if (!question) return;
  logAction("CHAT_QUESTION", currentRoomId, question);
  addChatMessage("You", question, "user");
  inp.value = "";
  const response = getOperatorResponse(question);
  addChatMessage("Operator", response, "operator");
  chatInteractions++;
  // Î¤Î¿ chat ÎµÎ¯Î½Î±Î¹ Î®Î´Î· Î±Î½Î¿Î¹Ï‡Ï„ÏŒ Î±Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î­ÎºÎ±Î½Îµ ÎºÎ»Î¹Îº ÏƒÏ„Î¿ ÏÎ¿Î¼Ï€ÏŒÏ„
  const container = document.getElementById("chat-messages");
  if (container) container.scrollTop = container.scrollHeight;
}

function toggleChatbot() {
  const chat = document.getElementById('chatbot-container');
  const robotBtn = document.getElementById('robot-operator-btn');
  if (!chat || !robotBtn) return; // Safety check
  const isOpening = chat.style.display !== 'flex';
  chat.style.display = isOpening ? 'flex' : 'none';
  if (isOpening) {
    chatInteractions++;
    if (typeof unreadChatMessages === 'undefined') unreadChatMessages = 0;
    unreadChatMessages = 0;
    robotBtn.classList.remove('has-messages');
    robotBtn.title = 'ğŸ¤– The Operator';
    const container = document.getElementById('chat-messages');
    if (container) container.scrollTop = container.scrollHeight;
  }
}
function addChatMessage(sender, text, type) {
  try {
    const container = document.getElementById('chat-messages');
    if (!container) return; // Safety check - chat container not ready yet
    
    const div = document.createElement('div');
    div.className = `chat-msg ${type}`;
    div.innerText = `${sender}: ${text}`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    
    // Î”ÎµÎ½ Î±Î½Î¿Î¯Î³Î¿Ï…Î¼Îµ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± Ï„Î¿ chat - Î±Ï€Î»Î¬ Ï€ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Ï…Î¼Îµ indicator ÏƒÏ„Î¿ ÏÎ¿Î¼Ï€ÏŒÏ„
    const chat = document.getElementById('chatbot-container');
    if (chat && chat.style.display !== 'flex') {
      if (typeof unreadChatMessages === 'undefined') unreadChatMessages = 0;
      unreadChatMessages++;
      const robotBtn = document.getElementById('robot-operator-btn');
      if (robotBtn) {
        robotBtn.classList.add('has-messages');
        robotBtn.title = `ğŸ¤– The Operator (${unreadChatMessages} Î½Î­Î¿${unreadChatMessages > 1 ? 'Î±' : ''} Î¼Î®Î½Ï…Î¼Î±)`;
      }
    }
  } catch (error) {
    console.warn("addChatMessage error (non-critical):", error);
    // Don't break the game if chat fails
  }
}
function checkIdleTimeFunc() {
  clearTimeout(idleTimer);
  idleTimer = setTimeout(() => {
    if(currentRoomId && !solvedRooms[currentRoomId]) {
      addChatMessage("Operator", "Î ÏÎ¬ÎºÏ„Î¿ÏÎ±, Î²Î»Î­Ï€Ï‰ ÏŒÏ„Î¹ ÎºÎ±Î¸Ï…ÏƒÏ„ÎµÏÎµÎ¯Ï‚. Î˜ÎµÏ‚ Î¼Î¹Î± Ï…Ï€ÏŒÎ´ÎµÎ¹Î¾Î·;", "operator");
      chatInteractions++;
    }
  }, 45000);
}

/* NAVIGATION & FLASHLIGHT */
function enterGame() {
  document.getElementById("splash").style.display = "none";
  goTo("instructions");
  speak("ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸ÎµÏ‚ Ï€ÏÎ¬ÎºÏ„Î¿ÏÎ±. Î¤Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î´Î­Ï‡ÎµÏ„Î±Î¹ ÎµÏ€Î¯Î¸ÎµÏƒÎ·. Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î»ÏÏƒÎµÎ¹Ï‚ Ï„Î¿Ï…Ï‚ Î³ÏÎ¯Ï†Î¿Ï…Ï‚ Î³Î¹Î± Î½Î± Î±Ï€Î¿Î´ÏÎ¬ÏƒÎµÎ¹Ï‚ ÎºÎ±Î¹ Î½Î± ÏƒÏÏƒÎµÎ¹Ï‚ Ï„Î¿ ÎµÏÎ³Î±ÏƒÏ„Î®ÏÎ¹Î¿.");
}

function goTo(screenId) {
  try {
    // FIX: Clear Virus on Room Exit
    if (virusInterval) {
      clearInterval(virusInterval);
      virusInterval = null;
      document.querySelectorAll('.virus-popup').forEach(p => p.remove());
    }

    const newScreen = document.getElementById(screenId);
    if (!newScreen) return;

    checkIdleTimeFunc();

    const now = new Date();
    if (currentRoomId && currentRoomId.startsWith("room") && roomEnterTime) {
      roomTime[currentRoomId] += (now - roomEnterTime)/1000;
    }

    if (screenId.startsWith("room")) {
      currentRoomId = screenId;
      roomEnterTime = now;
      if (roomConfig && roomConfig[currentRoomId]) {
        addChatMessage("Operator", `Entering Node: ${roomConfig[currentRoomId].title}`, "operator");
      }
      logAction("ENTER_ROOM", currentRoomId, "Started");
    } else {
      currentRoomId = null;
    }

  document.querySelectorAll('.screen').forEach(s => { s.style.display="none"; s.classList.remove('active'); });
  newScreen.style.display = "block";
  setTimeout(()=>newScreen.classList.add('active'), 50);

  lastScreen = (screenId !== 'glossary') ? screenId : lastScreen;
  updateHUD(screenId);
  updateProgressMap(screenId);

  // FLASHLIGHT RESET
  const overlay = document.getElementById('darkness-overlay');
  if (screenId.startsWith("room") && roomConfig[screenId] && roomConfig[screenId].isDark) {
    overlay.style.display = 'block';
    speak("Î ÏÎ¿ÏƒÎ¿Ï‡Î®. Î”Î¹Î±ÎºÎ¿Ï€Î® ÏÎµÏÎ¼Î±Ï„Î¿Ï‚. Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿Î½ Ï†Î±ÎºÏŒ.");
  } else {
    overlay.style.display = 'none';
  }

  if (screenId.startsWith("room")) {
    playRoomNarration(screenId);
    playSfx("door");
    // Mysterious cue when entering the dark room (power cut)
    if (screenId === "room4" && roomConfig[screenId] && roomConfig[screenId].isDark && !muteSounds) {
      try { mysteriousSound.currentTime = 0; mysteriousSound.play().catch(()=>{}); } catch(e) {}
    }
    // Tension cue when entering BOSS room
    if (screenId === "room10" && !muteSounds) {
      try { mysteriousSound.currentTime = 0; mysteriousSound.play().catch(()=>{}); } catch(e) {}
    }
  }

  playBGMForScreen(screenId);

  if (screenId === 'room1') {
    initTerminalRoom1();
  }

  if (screenId === 'exit') finishSession();
  } catch (error) {
    console.error("Error in goTo:", error);
    // Don't break navigation - just log the error
  }
}

function playRoomNarration(roomId) {
  const storyEl = document.getElementById("story-" + roomId);
  if (storyEl && !muteSpeech) {
    if (speechSynthesis.speaking) speechSynthesis.cancel();
    let u = new SpeechSynthesisUtterance(fixPhonetics(storyEl.innerText));
    u.lang = "el-GR";
    speechSynthesis.speak(u);
  }
}
function repeatQuestion(roomId) {
  if (muteSpeech) return;
  const qEl = document.getElementById("qtext-" + roomId);
  if(qEl) {
    if (speechSynthesis.speaking) speechSynthesis.cancel();
    let u = new SpeechSynthesisUtterance(fixPhonetics(qEl.innerText));
    u.lang = "el-GR";
    speechSynthesis.speak(u);
  }
}

/* START GAME */
function startGame() {
  try {
    timeLeft = 900;
    integrity = 100;
    score = 150; // Score starts at 150
    resetStructures();

    clearInterval(timerInterval);
    const timerEl = document.getElementById("timer");
    if (timerEl) timerEl.style.display = "inline-block";

    timerInterval = setInterval(()=> {
      if(timeLeft <= 0 || integrity <= 0) {
        clearInterval(timerInterval);
        // Stop timer display
        if (timerEl) timerEl.innerText = "â³ 0:00";
        // Show Game Over Screen instead of hard reset
        showGameOverScreen();
      } else {
        timeLeft--;
        let m = Math.floor(timeLeft/60);
        let s = timeLeft%60;
        if (timerEl) timerEl.innerText = "â³ " + m + ":" + (s<10?"0":"")+s;
      }
    },1000);

    sessionStartTime = new Date();
    gameStarted = true;
    unlockAllAudio();
    goTo('room1');
  } catch (error) {
    console.error("Error in startGame:", error);
    alert("Î£Ï†Î¬Î»Î¼Î± Î­Î½Î±ÏÎ¾Î·Ï‚ Ï€Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï. Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î·Î½ ÎºÎ¿Î½ÏƒÏŒÎ»Î± Î³Î¹Î± Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚.");
  }
}

/* FINISH + LOGGING */
function finishSession() {
  clearInterval(timerInterval);
  timerInterval = null;
  sessionEndTime = new Date();
  const finalScore = Math.max(0, score);
  document.getElementById('finalScore').innerText = finalScore;
  document.getElementById('maxScore').innerText = "150";

  const name = playerProfile.name || "Î ÏÎ¬ÎºÏ„Î¿ÏÎ±";
  const congrats = `Î£Ï…Î³Ï‡Î±ÏÎ·Ï„Î®ÏÎ¹Î± ${name}! Î‘Ï€Î­Î´ÏÎ±ÏƒÎµÏ‚ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î± ÎºÎ±Î¹ Î­ÏƒÏ‰ÏƒÎµÏ‚ Ï„Î¿ ÎµÏÎ³Î±ÏƒÏ„Î®ÏÎ¹Î¿.`;
  const exitP = document.getElementById("exitCongrats");
  if(exitP) exitP.innerText = congrats;

  // Awards based on final score (150 - penalties)
  let celeb = document.getElementById("celebration");
  let ach = document.getElementById("achievement");

  if (finalScore >= 130 && integrity >= 70) {
    celeb.className = "celebration-legendary";
    celeb.innerText = "ğŸ† Î‘Î ÎŸÎ›Î¥Î¤Î— Î•Î Î™Î¤Î¥Î§Î™Î‘! ÎŸ Î¹ÏŒÏ‚ Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ Ï€Î»Î®ÏÏ‰Ï‚!";
    ach.innerText = "ğŸ† RANK: ELITE HACKER (Î•Î¾ÎµÎ¹Î´Î¹ÎºÎµÏ…Î¼Î­Î½Î¿Ï‚ Î ÏÎ¬ÎºÏ„Î¿ÏÎ±Ï‚)";
  } else if (finalScore >= 100) {
    celeb.className = "celebration-good";
    celeb.innerText = "ğŸ‰ ÎšÎ‘Î›Î— Î”ÎŸÎ¥Î›Î•Î™Î‘! Î¤Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± ÏƒÏÎ¸Î·ÎºÎµ.";
    ach.innerText = "ğŸ¥ˆ RANK: SECURITY OFFICER (Î‘Î¾Î¹Ï‰Î¼Î±Ï„Î¹ÎºÏŒÏ‚ Î‘ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚)";
  } else {
    celeb.className = "celebration-basic";
    celeb.innerText = "âœ… Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ. Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ· Ï€ÏÎ¿ÏƒÎ¿Ï‡Î® ÏƒÏ„Î·Î½ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±!";
    ach.innerText = "ğŸ¥‰ RANK: TRAINEE (Î•ÎºÏ€Î±Î¹Î´ÎµÏ…ÏŒÎ¼ÎµÎ½Î¿Ï‚)";
  }

  stopBGM();
  try { ambientLoopSound.pause(); ambientLoopSound.currentTime = 0; } catch(e) {}
  if (!muteSounds) {
    try { victoryMusic.currentTime = 0; victoryMusic.play().catch(()=>{}); } catch(e) {}
    try { victorySound.currentTime = 0; victorySound.play().catch(()=>{}); } catch(e) {}
    setTimeout(function() {
      try { applauseSound.currentTime = 0; applauseSound.play().catch(()=>{}); } catch(e) {};
    }, 1600);
  }

  if(!muteSpeech) speak(congrats + " Î¤Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± ÎµÎ¯Î½Î±Î¹ Î±ÏƒÏ†Î±Î»Î­Ï‚.");

  buildStudentStats();
  updateSessionLog();
}

/* Î‘Î½Î¬Î»Ï…ÏƒÎ· Î•Ï€Î¹Î´ÏŒÏƒÎµÏ‰Î½ Î±Î½Î¬ Node - Î³Î¹Î± Î¼Î±Î¸Î·Ï„Î­Ï‚ Î»Ï…ÎºÎµÎ¯Î¿Ï…/ÎµÎ¹Î´Î¹ÎºÏŒÏ„Î·Ï„ÎµÏ‚ */
const roomShortNames = {
  room1: "Node 1: Python Terminal", room2: "Node 2: Network Protocols", room3: "Node 3: Binary Decryption", 
  room4: "Node 4: Server Hardware", room5: "Node 5: Security Clearance", room6: "Node 6: Algorithm Debug",
  room7: "Node 7: Loop Iteration", room8: "Node 8: Logic Gates", room9: "Node 9: SQL Injection",
  room10: "Node 10: BOSS Fight"
};

const roomTopics = {
  room1: "Python Syntax", room2: "Network Fundamentals", room3: "Binary Systems", room4: "Hardware Components",
  room5: "Security Protocols", room6: "Algorithm Logic", room7: "Control Flow", room8: "Syntax Debugging",
  room9: "Database Queries", room10: "Multi-step Security"
};

function buildStudentStats() {
  const container = document.getElementById("studentStatsContent");
  if (!container) return;

  const roomIds = ["room1","room2","room3","room4","room5","room6","room7","room8","room9","room10"];
  const performanceData = [];
  const highPerformance = [];
  const needsReview = [];
  const criticalErrors = [];

  for (const rid of roomIds) {
    const att = attempts[rid] || 0;
    const hints = hintsUsed[rid] || 0;
    const solved = !!solvedRooms[rid];
    const label = roomShortNames[rid] || rid;
    const topic = roomTopics[rid] || "";
    
    // Calculate accuracy: solved with minimal attempts = high accuracy
    const accuracy = solved ? (att <= 1 && hints === 0 ? "High" : att <= 2 && hints <= 1 ? "Medium" : "Low") : "Failed";
    const efficiency = solved ? (att + hints) : null; // Lower is better
    
    performanceData.push({ rid, label, topic, att, hints, solved, accuracy, efficiency });
    
    if (solved && att <= 1 && hints === 0)
      highPerformance.push({ label, topic, att, hints });
    else if (!solved || att >= 2 || hints >= 1)
      needsReview.push({ label, topic, att, hints, solved, accuracy });
    if (att > 0)
      criticalErrors.push({ label, topic, att, hints });
  }

  criticalErrors.sort((a, b) => b.att - a.att);
  const topErrors = criticalErrors.slice(0, 3);

  let html = "";
  
  // High Performance Section
  if (highPerformance.length > 0) {
    html += "<div class='stat-block excellent'><div class='stat-block-title'>âœ“ Î¥ÏˆÎ·Î»Î® Î‘Ï€ÏŒÎ´Î¿ÏƒÎ·</div>" +
      "<ul class='stat-block-list'>" + highPerformance.map(r => 
        "<li><strong>" + r.label + "</strong><br><span style='font-size:0.85em; color:#aaa;'>" + r.topic + " â€¢ Accuracy: High</span></li>"
      ).join("") + "</ul></div>";
  }
  
  // Needs Review Section
  if (needsReview.length > 0) {
    const reviewItems = needsReview.map(r => {
      const metrics = [];
      if (r.att > 0) metrics.push(r.att + " failed attempts");
      if (r.hints > 0) metrics.push(r.hints + " hints used");
      const status = r.solved ? "Completed" : "Incomplete";
      return "<li><strong>" + r.label + "</strong><br>" +
        "<span style='font-size:0.85em; color:#aaa;'>" + r.topic + " â€¢ " + status + 
        (metrics.length > 0 ? " â€¢ " + metrics.join(", ") : "") + "</span></li>";
    }).join("");
    html += "<div class='stat-block need-repeat'><div class='stat-block-title'>âš ï¸ Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ Î•Ï€Î±Î½ÎµÎ¾Î­Ï„Î±ÏƒÎ·</div><ul class='stat-block-list'>" + reviewItems + "</ul></div>";
  }
  
  // Critical Errors Section
  if (topErrors.length > 0) {
    html += "<div class='stat-block most-mistakes'><div class='stat-block-title'>ğŸ”´ ÎšÏÎ¯ÏƒÎ¹Î¼Î± Î£Î·Î¼ÎµÎ¯Î±</div>" +
      "<ul class='stat-block-list'>" + topErrors.map(r => 
        "<li><strong>" + r.label + "</strong><br><span style='font-size:0.85em; color:#aaa;'>" + r.topic + 
        " â€¢ Error count: " + r.att + "</span></li>"
      ).join("") + "</ul></div>";
  }
  
  if (!html)
    html = "<p style='color:#888; text-align:center;'>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Î½Î¬Î»Ï…ÏƒÎ·Ï‚.</p>";
  else
    html += "<div class='student-stats-footer'>Î£ÏÏƒÏ„Î±ÏƒÎ·: Î•ÏƒÏ„Î¯Î±ÏƒÎµ ÏƒÏ„Î·Î½ ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ· Ï„Ï‰Î½ Î¸ÎµÎ¼Î¬Ï„Ï‰Î½ Î¼Îµ Ï‡Î±Î¼Î·Î»Î® Î±Ï€ÏŒÎ´Î¿ÏƒÎ·. Î¤Î± nodes Î¼Îµ Ï…ÏˆÎ·Î»Î® Î±ÎºÏÎ¯Î²ÎµÎ¹Î± Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î½ ÎºÎ±Î»Î® ÎºÎ±Ï„Î±Î½ÏŒÎ·ÏƒÎ·.</div>";

  container.innerHTML = html;
}

function updateSessionLog() {
  const inv = inventory.map(i => ({ icon: i.icon, text: i.text, roomId: i.roomId }));

  const logObject = {
    version: "EscapeRoom-TheWiper-Thesis-Final",
    timestamps: {
      startISO: sessionStartTime ? sessionStartTime.toISOString() : null,
      endISO: sessionEndTime ? sessionEndTime.toISOString() : null
    },
    player: {
      name: playerProfile.name,
      avatar: playerProfile.avatar
    },
    session: {
      durationSeconds: (sessionStartTime && sessionEndTime) ? Math.round((sessionEndTime - sessionStartTime)/1000) : null,
      timeLimitSeconds: 900
    },
    score: {
      total: score,
      maxBaseScore: MAX_SCORE,
      integrity: integrity
    },
    engagementMetrics: {
      chatInteractions,
      minigameAttempts,
      combineAttempts
    },
    actionTimeline: actionLog, // --- NEW: DETAILED TIMELINE ---
    inventory: inv
  };

  const area = document.getElementById("sessionLog");
  if(area) area.value = JSON.stringify(logObject, null, 2);
}

/* PROFILE */
function savePlayerSetup() {
  playerProfile.name = document.getElementById("playerNameInput").value || "Unknown";
  goTo('intro');
}
function selectAvatar(id, el) {
  playerProfile.avatar = id;
  document.querySelectorAll('.avatar-option').forEach(d=>d.classList.remove('selected'));
  el.classList.add('selected');
}

/* DOWNLOADS */
function downloadJSON() {
  const logText = document.getElementById("sessionLog").value;
  if (!logText) {
    alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± export. ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎµ Ï€ÏÏÏ„Î± Ï„Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹.");
    return;
  }
  // Ensure valid JSON formatting with proper indentation
  let jsonData;
  try {
    jsonData = JSON.parse(logText); // Validate JSON
    // Pretty print with 2-space indentation for readability
    const jsonString = JSON.stringify(jsonData, null, 2);
    const blob = new Blob([jsonString], {type: "application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; 
    a.download = "escape_room_session.json";
    document.body.appendChild(a); 
    a.click(); 
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (e) {
    console.error("JSON parse error:", e);
    alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± JSON. Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î·Î½ ÎºÎ¿Î½ÏƒÏŒÎ»Î±.");
  }
}
function downloadCSV() {
  const headers = ["playerName","avatar","totalScore","integrity","durationSeconds","chatInteractions","minigameAttempts","combineAttempts"];
  const end = sessionEndTime || new Date();
  const dur = sessionStartTime ? Math.round((end - sessionStartTime)/1000) : "";
  const row = [
    (playerProfile.name||""),
    (playerProfile.avatar||""),
    Math.max(0, score),
    integrity,
    dur,
    chatInteractions,
    minigameAttempts,
    combineAttempts
  ];
  // Use comma as delimiter (standard CSV) with proper escaping
  const escape = (v) => {
    const str = String(v);
    // If contains comma, newline, or quote, wrap in quotes and escape quotes
    if (str.includes(',') || str.includes('\n') || str.includes('"')) {
      return '"' + str.replace(/"/g, '""') + '"';
    }
    return str;
  };
  const line1 = headers.map(escape).join(',');
  const line2 = row.map(escape).join(',');
  // UTF-8 BOM for Excel compatibility + Windows line endings
  const csv = "\uFEFF" + line1 + "\r\n" + line2;
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "escape_room_session.csv";
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function downloadCertificate() {
  const name = playerProfile.name || "Î ÏÎ¬ÎºÏ„Î¿ÏÎ±";
  const finalScore = Math.max(0, score); // Score based on 150 - penalties
  
  let rank = "";
  let rankDesc = "";
  let rankEmoji = "";
  if (finalScore >= 130 && integrity >= 70) {
    rank = "ELITE HACKER";
    rankDesc = "Î•Î¾ÎµÎ¹Î´Î¹ÎºÎµÏ…Î¼Î­Î½Î¿Ï‚ Î ÏÎ¬ÎºÏ„Î¿ÏÎ±Ï‚";
    rankEmoji = "ğŸ†";
  } else if (finalScore >= 100) {
    rank = "SECURITY OFFICER";
    rankDesc = "Î‘Î¾Î¹Ï‰Î¼Î±Ï„Î¹ÎºÏŒÏ‚ Î‘ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚";
    rankEmoji = "ğŸ¥ˆ";
  } else {
    rank = "TRAINEE";
    rankDesc = "Î•ÎºÏ€Î±Î¹Î´ÎµÏ…ÏŒÎ¼ÎµÎ½Î¿Ï‚";
    rankEmoji = "ğŸ¥‰";
  }
  
  const date = sessionEndTime ? new Date(sessionEndTime).toLocaleDateString('el-GR', { year: 'numeric', month: 'long', day: 'numeric' }) : new Date().toLocaleDateString('el-GR', { year: 'numeric', month: 'long', day: 'numeric' });
  const durationSeconds = sessionStartTime && sessionEndTime ? Math.round((sessionEndTime - sessionStartTime) / 1000) : 0;
  const duration = Math.round(durationSeconds / 60); // Convert to minutes
  
  // Create certificate element
  const certDiv = document.createElement('div');
  certDiv.style.position = 'fixed';
  certDiv.style.left = '-9999px';
  certDiv.style.width = '1123px'; // A4 landscape width in pixels at 96dpi
  certDiv.style.height = '794px'; // A4 landscape height
  certDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
  certDiv.style.padding = '40px';
  certDiv.style.fontFamily = 'Arial, sans-serif';
  certDiv.style.textAlign = 'center';
  certDiv.style.color = '#333';
  
  certDiv.innerHTML = `
    <div style="background: white; padding: 60px; border: 10px solid #ffd700; box-shadow: 0 0 30px rgba(0,0,0,0.3); height: 100%; display: flex; flex-direction: column; justify-content: center;">
      <h1 style="color: #333; font-size: 42px; margin-bottom: 20px; margin-top: 0;">${rankEmoji} Î Î™Î£Î¤ÎŸÎ ÎŸÎ™Î—Î¤Î™ÎšÎŸ ÎŸÎ›ÎŸÎšÎ›Î—Î¡Î©Î£Î—Î£</h1>
      <h2 style="color: #667eea; font-size: 32px; margin: 20px 0;">Escape Room: The Wiper</h2>
      <div style="font-size: 36px; font-weight: bold; color: #764ba2; margin: 30px 0;">${name}</div>
      <div style="font-size: 28px; color: #ff6b6b; margin: 20px 0; font-weight: bold;">${rank}</div>
      <div style="font-size: 22px; color: #555; margin-bottom: 30px;">${rankDesc}</div>
      <div style="font-size: 18px; color: #555; margin: 10px 0; line-height: 2;">
        <p>ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î± Ï„Î·Î½ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® Î±Ï€Î¿Î´ÏÎ¬ÏƒÎµÏ‰Ï‚ Î±Ï€ÏŒ Ï„Î¿ ÎµÏÎ³Î±ÏƒÏ„Î®ÏÎ¹Î¿.</p>
          <p><strong>System Integrity:</strong> ${finalScore} / 150 Ï€ÏŒÎ½Ï„Ï‰Î½</p>
        <p><strong>Î§ÏÏŒÎ½Î¿Ï‚ Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚:</strong> ${duration} Î»ÎµÏ€Ï„Î¬</p>
        <p><strong>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±:</strong> ${date}</p>
      </div>
      <div style="margin-top: 40px; font-size: 14px; color: #888;">Î‘Ï…Ï„ÏŒ Ï„Î¿ Ï€Î¹ÏƒÏ„Î¿Ï€Î¿Î¹Î·Ï„Î¹ÎºÏŒ Î±Ï€Î¿Î´ÎµÎ¹ÎºÎ½ÏÎµÎ¹ Ï„Î·Î½ Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Ï„Î¿Ï… Escape Room: The Wiper</div>
    </div>
  `;
  
  document.body.appendChild(certDiv);
  
  // Use html2canvas to convert to image, then jsPDF to create PDF
  setTimeout(() => {
    html2canvas(certDiv, { scale: 2, useCORS: true }).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('landscape', 'mm', 'a4');
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = canvas.width;
      const imgHeight = canvas.height;
      const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
      const imgScaledWidth = imgWidth * ratio;
      const imgScaledHeight = imgHeight * ratio;
      const xOffset = (pdfWidth - imgScaledWidth) / 2;
      const yOffset = (pdfHeight - imgScaledHeight) / 2;
      
      pdf.addImage(imgData, 'PNG', xOffset, yOffset, imgScaledWidth, imgScaledHeight);
      pdf.save(`certificate_${name.replace(/\s+/g, '_')}_${Date.now()}.pdf`);
      document.body.removeChild(certDiv);
    }).catch(err => {
      console.error("Error generating certificate:", err);
      alert("Î£Ï†Î¬Î»Î¼Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚ Ï€Î¹ÏƒÏ„Î¿Ï€Î¿Î¹Î·Ï„Î¹ÎºÎ¿Ï. Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î½Î± Î±Î½Î¿Î¯Î¾ÎµÏ„Îµ Ï„Î¿ PDF Î±Ï€ÏŒ Ï„Î¿ Print.");
      document.body.removeChild(certDiv);
    });
  }, 100);
}

function restartGame() { location.reload(); }

function showGameOverScreen() {
  stopBGM();
  if (bgMusic) bgMusic.pause();
  if (ambientLoopSound) ambientLoopSound.pause();

  // Play failure sound
  playSfx("wrong");
  
  // Hide all screens and show game over screen
  document.querySelectorAll('.screen').forEach(s => { 
    s.style.display = "none"; 
    s.classList.remove('active'); 
  });
  
  const gameOverScreen = document.getElementById("gameOver");
  if (gameOverScreen) {
    gameOverScreen.style.display = "block";
    setTimeout(() => gameOverScreen.classList.add('active'), 50);
  }
  
  // Stop timer if still running
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

function continueWithPenalty() {
  // Penalty: lose 50 points (do not zero out)
  score = Math.max(0, score - 50);
  const scoreEl = document.getElementById("score-value");
  if (scoreEl) scoreEl.innerText = String(score);
  
  // Reset timer to give more time (optional: add 5 minutes)
  timeLeft = 300; // 5 more minutes
  
  // Restart timer
  const timerEl = document.getElementById("timer");
  if (timerEl) timerEl.style.display = "inline-block";
  
  clearInterval(timerInterval);
  timerInterval = setInterval(()=> {
    if(timeLeft <= 0 || integrity <= 0) {
      clearInterval(timerInterval);
      if (timerEl) timerEl.innerText = "â³ 0:00";
      showGameOverScreen();
    } else {
      timeLeft--;
      let m = Math.floor(timeLeft/60);
      let s = timeLeft%60;
      if (timerEl) timerEl.innerText = "â³ " + m + ":" + (s<10?"0":"")+s;
    }
  },1000);
  
  // Hide game over screen and return to current room
  const gameOverScreen = document.getElementById("gameOver");
  if (gameOverScreen) {
    gameOverScreen.style.display = "none";
    gameOverScreen.classList.remove('active');
  }
  
  // Return to the room the player was in (or room1 if none)
  const roomToReturn = currentRoomId || 'room1';
  goTo(roomToReturn);
  
  // Show message
  addChatMessage("System", "âš ï¸ Î Î¿Î¹Î½Î® ÎµÏ†Î±ÏÎ¼ÏŒÏƒÏ„Î·ÎºÎµ: -50 Ï€ÏŒÎ½Ï„Î¿Î¹. ÎˆÏ‡ÎµÎ¹Ï‚ 5 Î»ÎµÏ€Ï„Î¬ Î±ÎºÏŒÎ¼Î±.", "system");
  
  // Play sound
  playSfx("shortCircuit");
}

/* FLASHLIGHT MOUSE TRACKING */
document.addEventListener('mousemove', function(e) {
  const overlay = document.getElementById('darkness-overlay');
  if(overlay.style.display !== 'none') {
    overlay.style.background = `radial-gradient(circle 250px at ${e.clientX}px ${e.clientY}px, transparent 0%, rgba(0,0,0,0.98) 100%)`;
  }
});

/* DRAGGABLE WINDOWS (Only for Terminal Room 1) */
function makeDraggable(elmnt) {
  let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  const header = elmnt.querySelector('.window-header');
  if (header) {
    header.onmousedown = dragMouseDown;
  }

  function dragMouseDown(e) {
    e = e || window.event;
    e.preventDefault();
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    elmnt.style.transform = "none";
  }

  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}

/* INIT */
window.onload = () => {
  document.getElementById("splash").style.display = "flex";
  initProgressMap();
  initRoom2Drag(); 
  initParsonsDrag(); 
  makeDraggable(document.getElementById("qblock-room1"));
};
</script>

<script>
/* =========================================
   ğŸ•µï¸â€â™‚ï¸ SECRET HACKER MODE (F12 EASTER EGG)
   ========================================= */

// 1. ÎœÎ®Î½Ï…Î¼Î± ÎºÎ±Î»Ï‰ÏƒÎ¿ÏÎ¯ÏƒÎ¼Î±Ï„Î¿Ï‚ ÏƒÏ„Î·Î½ ÎšÎ¿Î½ÏƒÏŒÎ»Î±
setTimeout(() => {
    console.clear();
    const styleTitle = "color: #ff0000; font-size: 20px; font-weight: bold; text-shadow: 2px 2px #000; background: #222; padding: 10px; border: 2px solid red;";
    const styleBody = "color: #00ff00; font-size: 14px; font-family: monospace; background: #111; padding: 5px;";
    const styleCode = "color: #ffff00; font-size: 16px; font-weight: bold; background: #333; padding: 4px; border: 1px dashed yellow; cursor: pointer;";

    console.log("%câš ï¸ SECURITY BREACH DETECTED âš ï¸", styleTitle);
    console.log("%cÎ ÏÎ¬ÎºÏ„Î¿ÏÎ±, Î²Î»Î­Ï€Ï‰ ÏŒÏ„Î¹ Î¾Î­ÏÎµÎ¹Ï‚ Î½Î± ÎºÎ¿Î¹Ï„Î¬Ï‚ Ï€Î¯ÏƒÏ‰ Î±Ï€ÏŒ Ï„Î¹Ï‚ Î³ÏÎ±Î¼Î¼Î­Ï‚...", styleBody);
    console.log("%cÎ‘Î½ ÏŒÎ½Ï„Ï‰Ï‚ Î¾Î­ÏÎµÎ¹Ï‚ Ï„Î¹ ÎºÎ¬Î½ÎµÎ¹Ï‚, Ï„ÏÎ­Î¾Îµ Ï„Î·Î½ ÎµÎ½Ï„Î¿Î»Î®: %cadminOverride()", styleBody, styleCode);
    
    // Detection Î³Î¹Î± DevTools - ÎµÎ»Î­Î³Ï‡ÎµÎ¹ Î±Î½ ÎµÎ¯Î½Î±Î¹ Î±Î½Î¿Î¹Ï‡Ï„ÏŒ
    detectDevTools();
    
}, 2000);

// Detection function Î³Î¹Î± DevTools
function detectDevTools() {
    let devtools = {open: false, orientation: null};
    const threshold = 160;
    
    setInterval(() => {
        if (window.outerHeight - window.innerHeight > threshold || 
            window.outerWidth - window.innerWidth > threshold) {
            if (!devtools.open) {
                devtools.open = true;
                // DevTools Î±Î½Î¿Î¯Ï‡Ï„Î·ÎºÎµ - ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎµ Ï„Î¿ hint
                setTimeout(() => {
                    showConsoleHint();
                }, 500);
            }
        } else {
            if (devtools.open) {
                devtools.open = false;
                // DevTools Î­ÎºÎ»ÎµÎ¹ÏƒÎµ - ÎºÏÏÏˆÎµ Ï„Î¿ hint
                const hint = document.getElementById('console-hint');
                if (hint) hint.remove();
            }
        }
    }, 500);
}

// Visual hint Î³Î¹Î± Ï„Î¿ Console tab
function showConsoleHint() {
    // Î‘Ï†Î±Î¹ÏÎ¿ÏÎ¼Îµ Ï„Î¿ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ hint Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹
    const existingHint = document.getElementById('console-hint');
    if(existingHint) return; // Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î·, Î¼Î·Î½ Ï„Î¿ Î¾Î±Î½Î±Î´ÎµÎ¯Î¾ÎµÎ¹Ï‚
    
    const hint = document.createElement('div');
    hint.id = 'console-hint';
    hint.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.9);
        border: 2px solid #ff0000;
        color: #00ff00;
        padding: 15px 20px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 14px;
        z-index: 99999;
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        animation: pulse-hint 2s infinite;
    `;
    hint.innerHTML = `
        <div style="color: #ff0000; font-weight: bold; margin-bottom: 8px;">âš ï¸ DEVTOOLS DETECTED</div>
        <div>ÎšÎ¬Î½Îµ ÎºÎ»Î¹Îº ÏƒÏ„Î¿ <strong style="color: #ffff00;">Console</strong> tab Î³Î¹Î± Î½Î± Î´ÎµÎ¹Ï‚ Ï„Î¿ Î¼Î®Î½Ï…Î¼Î±!</div>
        <div style="font-size: 11px; color: #aaa; margin-top: 8px;">(Î® Ï€Î¬Ï„Î± ESC Î³Î¹Î± Î½Î± ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹Ï‚)</div>
    `;
    
    // CSS animation Î³Î¹Î± pulse effect
    if(!document.getElementById('console-hint-style')) {
        const style = document.createElement('style');
        style.id = 'console-hint-style';
        style.textContent = `
            @keyframes pulse-hint {
                0%, 100% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.8; transform: scale(1.02); }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(hint);
    
    // ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î¼Îµ ESC Î® ÎºÎ»Î¹Îº
    const closeHint = (e) => {
        if(e.key === 'Escape' || e.type === 'click') {
            if(hint.parentNode) hint.remove();
            document.removeEventListener('keydown', closeHint);
        }
    };
    document.addEventListener('keydown', closeHint);
    hint.addEventListener('click', closeHint);
}

// 2. Î— Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· Ï€Î¿Ï… ÎºÎ±Î»ÎµÎ¯ Î¿ Î¼Î±Î¸Î·Ï„Î®Ï‚
window.adminOverride = function() {
    console.log("%cğŸš€ ROOT ACCESS GRANTED. BYPASSING SECURITY...", "color: lime; font-size: 20px; font-weight: bold;");
    
    // Î£Ï„Î±Î¼Î±Ï„Î¬Î¼Îµ Ï„Î¿Î½ Ï‡ÏÏŒÎ½Î¿
    clearInterval(timerInterval);
    
    // Î£Ï„Î±Î¼Î±Ï„Î¬Î¼Îµ Ï„Î¿Î½ Î¹ÏŒ (Î±Î½ Ï„ÏÎ­Ï‡ÎµÎ¹)
    if(virusInterval) clearInterval(virusInterval);
    document.querySelectorAll('.virus-popup').forEach(el => el.remove());

    // Î”Î¯Î½Î¿Ï…Î¼Îµ Ï„Î¿ Î±Ï€ÏŒÎ»Ï…Ï„Î¿ ÏƒÎºÎ¿Ï ÎºÎ±Î¹ ÎµÎ¹Î´Î¹ÎºÏŒ Ï„Î¯Ï„Î»Î¿
    score = 1337; 
    integrity = 100;
    playerProfile.name = (playerProfile.name || "Agent") + " (The Console Hacker)";

    // Î‰Ï‡Î¿Ï‚ Î½Î¯ÎºÎ·Ï‚
    if(!muteSounds) { 
        let winSfx = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"); 
        if(typeof victorySound !== 'undefined') victorySound.play(); 
        else winSfx.play();
    }

    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚ ÏƒÏ„Î·Î½ Î¿Î¸ÏŒÎ½Î·
    const hud = document.getElementById('hudWrapper');
    if(hud) hud.style.display = 'none'; // ÎšÏÏÎ²Î¿Ï…Î¼Îµ Ï„Î¿ UI

    cinematic("SYSTEM HACKED", "Admin Access Granted via Console.", 3000);

    // ÎœÎµÏ„Î¬Î²Î±ÏƒÎ· ÏƒÏ„Î·Î½ Î¿Î¸ÏŒÎ½Î· Ï„ÎµÏÎ¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ 2 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±
    setTimeout(() => {
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        document.getElementById('splash').style.display = 'none';
        
        const exit = document.getElementById('exit');
        exit.style.display = 'block';
        exit.classList.add('active');

        document.getElementById('exitCongrats').innerHTML = "<span style='color:red; font-family:monospace'>// SYSTEM_OVERRIDE_SUCCESSFUL</span>";
        document.getElementById('achievement').innerHTML = "ğŸ† RANK: <b>GOD MODE (Developer)</b><br>Â«Î”ÎµÎ½ Î­Ï€Î±Î¹Î¾ÎµÏ‚ Ï„Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹. Î¤Î¿ 'Ï‡Î¬ÎºÎ±ÏÎµÏ‚'.Â»";
        document.getElementById('finalScore').innerText = "âˆ";
        
        // ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® ÏƒÏ„Î¿ Log
        logAction("HACK", "console", "adminOverride() triggered via F12");
        updateSessionLog();

    }, 2000);

    return "System Hacked Successfully.";
};
</script>

</body>
</html>